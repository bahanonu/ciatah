<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]--><!--[if gt IE 8]><!--><html class="no-js" lang="en"> <!--<![endif]-->
<head>
<meta charset="utf-8"/>
<meta content="IE=edge" http-equiv="X-UA-Compatible"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<meta content="Biafra Ahanonu" name="author"/>
<link href="../img/favicon.ico" rel="shortcut icon"/>
<title>One-page readme (auto)</title>
<link href="https://fonts.googleapis.com/css?family=Lato:400,700|Roboto+Slab:400,700|Inconsolata:400,700" rel="stylesheet"/>
<link href="../css/theme.css" rel="stylesheet"/>
<link href="../css/theme_extra.css" rel="stylesheet"/>
<link href="../css/extra.css" rel="stylesheet"/>
<link href="../css/pygments.css" rel="stylesheet"/>
<script>
    // Current page data
    var mkdocs_page_name = "One-page readme (auto)";
    var mkdocs_page_input_path = "all_docs.md";
    var mkdocs_page_url = null;
  </script>
<script defer="" src="../js/jquery-2.1.1.min.js"></script>
<script defer="" src="../js/modernizr-2.8.3.min.js"></script>
</head>
<body class="wy-body-for-nav" role="document">
<div class="wy-grid-for-nav">
<nav class="wy-nav-side stickynav" data-toggle="wy-nav-shift">
<div class="wy-side-scroll">
<div class="wy-side-nav-search">
<a class="icon icon-home" href=".."> CIAtah</a>
</div>
<div aria-label="main navigation" class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation">
<ul>
<li class="toctree-l1"><a class="reference internal" href="..">Home</a>
</li>
</ul>
<p class="caption"><span class="caption-text">End-to-end</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="./">One-page readme</a>
</li>
<li class="toctree-l1 current"><a class="reference internal current" href="./">One-page readme (auto)</a>
<ul class="current">
<li class="toctree-l2"><a class="reference internal" href="#setup">â€”Setupâ€”</a>
</li>
<li class="toctree-l2"><a class="reference internal" href="#quick-start-guide">Quick start guide</a>
<ul>
<li class="toctree-l3"><a class="reference internal" href="#install">Install</a>
</li>
<li class="toctree-l3"><a class="reference internal" href="#check-required-toolboxes-installed">Check required toolboxes installed</a>
</li>
<li class="toctree-l3"><a class="reference internal" href="#setup-sitename">Setup CIAtah</a>
</li>
<li class="toctree-l3"><a class="reference internal" href="#sitename-main-gui-notes">CIAtah main GUI notes</a>
</li>
<li class="toctree-l3"><a class="reference internal" href="#additional-quick-start-notes">Additional quick start notes</a>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#installation">Installation</a>
<ul>
<li class="toctree-l3"><a class="reference internal" href="#example-data">Example data</a>
</li>
<li class="toctree-l3"><a class="reference internal" href="#dependencies">Dependencies</a>
<ul>
<li class="toctree-l4"><a class="reference internal" href="#matlab-toolbox-dependencies">MATLAB Toolbox dependencies</a>
</li>
<li class="toctree-l4"><a class="reference internal" href="#parallel-computing-toolbox-pct">Parallel Computing Toolbox (PCT)</a>
</li>
<li class="toctree-l4"><a class="reference internal" href="#imagej">ImageJ</a>
</li>
<li class="toctree-l4"><a class="reference internal" href="#saleae">Saleae</a>
</li>
<li class="toctree-l4"><a class="reference internal" href="#cnmf-and-cnmf-e">CNMF and CNMF-E</a>
</li>
<li class="toctree-l4"><a class="reference internal" href="#neurodata-without-borders">Neurodata Without Borders</a>
</li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#repository">â€”Repositoryâ€”</a>
</li>
<li class="toctree-l2"><a class="reference internal" href="#data">Data</a>
<ul>
<li class="toctree-l3"><a class="reference internal" href="#input-and-output-files">Input and output files</a>
</li>
<li class="toctree-l3"><a class="reference internal" href="#loading-data">Loading data</a>
</li>
<li class="toctree-l3"><a class="reference internal" href="#nwb-support">NWB Support</a>
</li>
<li class="toctree-l3"><a class="reference internal" href="#preferred-folder-naming-format">Preferred folder naming format</a>
</li>
<li class="toctree-l3"><a class="reference internal" href="#videos">Videos</a>
</li>
<li class="toctree-l3"><a class="reference internal" href="#cell-images">Cell images</a>
</li>
<li class="toctree-l3"><a class="reference internal" href="#cell-traces">Cell traces</a>
</li>
<li class="toctree-l3"><a class="reference internal" href="#repository-notes">Repository notes</a>
<ul>
<li class="toctree-l4"><a class="reference internal" href="#repository-organization">Repository organization</a>
</li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#processing-data">â€”Processing dataâ€”</a>
</li>
<li class="toctree-l2"><a class="reference internal" href="#processing-calcium-imaging-data">Processing calcium imaging data</a>
<ul>
<li class="toctree-l3"><a class="reference internal" href="#guides">Guides</a>
<ul>
<li class="toctree-l4"><a class="reference internal" href="#webinar">Webinar</a>
</li>
<li class="toctree-l4"><a class="reference internal" href="#workshop-tutorial">Workshop tutorial</a>
</li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#workflow">Workflow</a>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#detailed-sitename-processing-pipeline">Detailed CIAtah processing pipeline</a>
<ul>
<li class="toctree-l3"><a class="reference internal" href="#spatially-downsample-raw-movies-or-convert-to-hdf5-with-modeldownsamplerawmovies">Spatially downsample raw movies or convert to HDF5 with modelDownsampleRawMovies</a>
<ul>
<li class="toctree-l4"><a class="reference internal" href="#converting-inscopix-isxd-files-to-hdf5">Converting Inscopix ISXD files to HDF5</a>
</li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#check-movie-registration-before-pre-processing-with-viewmovieregistrationtest">Check movie registration before pre-processing with viewMovieRegistrationTest</a>
</li>
<li class="toctree-l3"><a class="reference internal" href="#preprocessing-calcium-imaging-movies-with-modelpreprocessmovie">Preprocessing calcium imaging movies with modelPreprocessMovie</a>
<ul>
<li class="toctree-l4"><a class="reference internal" href="#saveload-preprocessing-settings">Save/load preprocessing settings</a>
</li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#manual-movie-cropping-with-modelmodifymovies">Manual movie cropping with modelModifyMovies</a>
</li>
<li class="toctree-l3"><a class="reference internal" href="#extracting-cells-with-modelextractsignalsfrommovie">Extracting cells with modelExtractSignalsFromMovie</a>
</li>
<li class="toctree-l3"><a class="reference internal" href="#loading-cell-extraction-output-data-for-custom-scripts">Loading cell-extraction output data for custom scripts</a>
</li>
<li class="toctree-l3"><a class="reference internal" href="#loading-cell-extraction-output-data-with-modelvarsfromfiles">Loading cell-extraction output data with modelVarsFromFiles</a>
</li>
<li class="toctree-l3"><a class="reference internal" href="#validating-cell-extraction-with-viewcellextractiononmovie">Validating cell extraction with viewCellExtractionOnMovie</a>
</li>
<li class="toctree-l3"><a class="reference internal" href="#sorting-cell-extraction-outputs-with-computemanualsortsignals">Sorting cell extraction outputs with computeManualSortSignals</a>
<ul>
<li class="toctree-l4"><a class="reference internal" href="#gui-usage-on-large-imaging-datasets">GUI usage on large imaging datasets</a>
</li>
<li class="toctree-l4"><a class="reference internal" href="#cell-sorting-from-the-command-line-with-signalsorter">Cell sorting from the command line with signalSorter</a>
</li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#removing-cells-not-within-brain-region-with-modelmodifyregionanalysis">Removing cells not within brain region with modelModifyRegionAnalysis</a>
</li>
<li class="toctree-l3"><a class="reference internal" href="#cross-session-cell-alignment-with-computematchobjbtwntrials">Cross-session cell alignment with computeMatchObjBtwnTrials</a>
<ul>
<li class="toctree-l4"><a class="reference internal" href="#view-cross-session-cell-alignment-with-viewmatchobjbtwnsessions">View cross-session cell alignment with viewMatchObjBtwnSessions</a>
</li>
<li class="toctree-l4"><a class="reference internal" href="#save-cross-session-cell-alignment-with-modelsavematchobjbtwntrials">Save cross-session cell alignment with modelSaveMatchObjBtwnTrials</a>
</li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#imagejmatlab-based-mouse-location-tracking">ImageJ+MATLAB based mouse location tracking</a>
<ul>
<li class="toctree-l3"><a class="reference internal" href="#instructions-for-imagej-and-matlab">Instructions for ImageJ and Matlab</a>
<ul>
<li class="toctree-l4"><a class="reference internal" href="#example-output-from-2017_09_11_p540_m381_openfield01_091112017">Example output from 2017_09_11_p540_m381_openfield01_091112017</a>
</li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#api">â€”APIâ€”</a>
</li>
<li class="toctree-l2"><a class="reference internal" href="#example-sitename-pipeline-via-the-command-line">Example CIAtah pipeline via the command line.</a>
<ul>
<li class="toctree-l3"><a class="reference internal" href="#setup_1">Setup</a>
</li>
<li class="toctree-l3"><a class="reference internal" href="#visualize-movie">Visualize movie</a>
</li>
<li class="toctree-l3"><a class="reference internal" href="#downsample-movie">Downsample movie</a>
</li>
<li class="toctree-l3"><a class="reference internal" href="#remove-stripe-artifacts-eg-from-camera-from-movie">Remove stripe artifacts (e.g. from camera) from movie</a>
</li>
<li class="toctree-l3"><a class="reference internal" href="#detrend-movie-if-needed-default-linear-trend-eg-to-compensate-for-bleaching-over-time">Detrend movie if needed (default linear trend), e.g. to compensate for bleaching over time.</a>
</li>
<li class="toctree-l3"><a class="reference internal" href="#run-motion-correction">Run motion correction</a>
</li>
<li class="toctree-l3"><a class="reference internal" href="#convert-movie-to-units-of-relative-fluorescence">Convert movie to units of relative fluorescence</a>
</li>
<li class="toctree-l3"><a class="reference internal" href="#downsample-movie_1">Downsample movie</a>
</li>
<li class="toctree-l3"><a class="reference internal" href="#run-pca-ica">Run PCA-ICA</a>
</li>
<li class="toctree-l3"><a class="reference internal" href="#run-cnmf-or-cnmf-e-cell-extraction">Run CNMF or CNMF-e cell extraction.</a>
</li>
<li class="toctree-l3"><a class="reference internal" href="#run-extract-cell-extraction">Run EXTRACT cell extraction.</a>
</li>
<li class="toctree-l3"><a class="reference internal" href="#manual-sort-output-cells">Manual sort output cells</a>
<ul>
<li class="toctree-l4"><a class="reference internal" href="#run-signal-sorting-using-nwb">Run signal sorting using NWB</a>
</li>
<li class="toctree-l4"><a class="reference internal" href="#run-signal-sorting-using-multiple-nwb-files-from-cell-extraction">Run signal sorting using multiple NWB files from cell extraction.</a>
</li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#overlay-cells-on-movies-as-sanity-check">Overlay cells on movies as sanity check</a>
</li>
<li class="toctree-l3"><a class="reference internal" href="#batch-process-example-movies-and-perform-cross-session-cell-alignment">Batch process example movies and perform cross-session cell alignment</a>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#sitename-functions-within-codepackage-sub-package">CIAtah functions within {{ code.package }} sub-package.</a>
<ul>
<li class="toctree-l3"><a class="reference internal" href="#visualizing-movies">Visualizing movies</a>
</li>
<li class="toctree-l3"><a class="reference internal" href="#get-movie-information">Get movie information</a>
</li>
<li class="toctree-l3"><a class="reference internal" href="#sorting-cells">Sorting cells</a>
</li>
<li class="toctree-l3"><a class="reference internal" href="#pre-processing">Pre-processing</a>
</li>
<li class="toctree-l3"><a class="reference internal" href="#cell-extraction">Cell extraction</a>
</li>
<li class="toctree-l3"><a class="reference internal" href="#cross-session-alignment">Cross-session alignment</a>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#help">â€”Helpâ€”</a>
</li>
<li class="toctree-l2"><a class="reference internal" href="#common-issues-and-fixes">Common issues and fixes</a>
<ul>
<li class="toctree-l3"><a class="reference internal" href="#contents">Contents</a>
</li>
<li class="toctree-l3"><a class="reference internal" href="#error-opening-avi-or-other-files-due-to-codec-issues">Error opening AVI or other files due to codec issues</a>
</li>
<li class="toctree-l3"><a class="reference internal" href="#pca-ica-cnmf-e-or-other-cell-extraction-algorithms-dont-produce-sensible-output">PCA-ICA, CNMF-E, or other cell extraction algorithm's don't produce sensible output.</a>
</li>
<li class="toctree-l3"><a class="reference internal" href="#out-of-memory-using-miji">Out of memory using Miji</a>
</li>
<li class="toctree-l3"><a class="reference internal" href="#selecting-scripts-folder-in-fijiapp-on-mac-os-x">Selecting scripts folder in Fiji.app on Mac OS X</a>
</li>
<li class="toctree-l3"><a class="reference internal" href="#fiji-wont-start-using-miji-or-mijstart">Fiji won't start using Miji or MIJ.start</a>
</li>
<li class="toctree-l3"><a class="reference internal" href="#downloadcnmfgithubrepositoriesm-not-downloading-correctly">downloadCnmfGithubRepositories.m not downloading correctly</a>
</li>
<li class="toctree-l3"><a class="reference internal" href="#modelpreprocessmovie-analysis-options-list-not-showing">modelPreprocessMovie analysis options list not showing</a>
</li>
<li class="toctree-l3"><a class="reference internal" href="#miji-not-loading-correctly">Miji not loading correctly</a>
</li>
<li class="toctree-l3"><a class="reference internal" href="#viewmovie-or-other-functions-where-movies-need-to-be-loaded-end-without-executing">viewMovie or other functions where movies need to be loaded end without executing</a>
</li>
<li class="toctree-l3"><a class="reference internal" href="#contrast-is-low-on-cell-transient-ff-movies-using-computemanualsortsignals">Contrast is low on cell transient Î”F/F movies using computeManualSortSignals</a>
</li>
<li class="toctree-l3"><a class="reference internal" href="#traces-in-computemanualsortsignals-gui-are-flat">Traces in computeManualSortSignals GUI are flat.</a>
<ul>
<li class="toctree-l4"><a class="reference internal" href="#cant-see-transients">Can't see transients.</a>
</li>
<li class="toctree-l4"><a class="reference internal" href="#change-the-minmax">Change the min/max.</a>
</li>
<li class="toctree-l4"><a class="reference internal" href="#can-now-see-transients">Can now see transients.</a>
</li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#blank-frames-or-entire-frames-have-baseline-shifted-after-motion-correction-in-modelpreprocessmovie">Blank frames or entire frames have baseline shifted after motion correction in modelPreprocessMovie</a>
</li>
<li class="toctree-l3"><a class="reference internal" href="#file-or-folder-dialog-box-with-no-instructions">File or folder dialog box with no instructions</a>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#inscopix">Inscopix</a>
<ul>
<li class="toctree-l3"><a class="reference internal" href="#visualizing-isxd-files">Visualizing ISXD files</a>
</li>
<li class="toctree-l3"><a class="reference internal" href="#converting-isxd-files-to-hdf5">Converting ISXD files to HDF5</a>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#neurodata-without-borders-nwb">Neurodata Without Borders (NWB)</a>
<ul>
<li class="toctree-l3"><a class="reference internal" href="#saving-nwb">Saving NWB</a>
</li>
<li class="toctree-l3"><a class="reference internal" href="#loading-nwb">Loading NWB</a>
</li>
<li class="toctree-l3"><a class="reference internal" href="#using-nwb-with-signalsorter">Using NWB with signalSorter</a>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#interpreting-displayed-movies">Interpreting displayed movies</a>
<ul>
<li class="toctree-l3"><a class="reference internal" href="#example">Example</a>
<ul>
<li class="toctree-l4"><a class="reference internal" href="#raw-movie">Raw movie</a>
</li>
<li class="toctree-l4"><a class="reference internal" href="#dff0">dF/F0</a>
</li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#imaging-analysis-methods-and-code">Imaging analysis methods and code</a>
<ul>
<li class="toctree-l3"><a class="reference internal" href="#image-registration">Image Registration</a>
</li>
<li class="toctree-l3"><a class="reference internal" href="#cross-day-alignment">Cross-day alignment</a>
</li>
<li class="toctree-l3"><a class="reference internal" href="#cell-segmentation-static-image">Cell segmentation (static image)</a>
</li>
<li class="toctree-l3"><a class="reference internal" href="#cell-extraction-dynamic-movie">Cell extraction (dynamic movie)</a>
</li>
<li class="toctree-l3"><a class="reference internal" href="#cell-extraction-correction">Cell-extraction correction</a>
</li>
<li class="toctree-l3"><a class="reference internal" href="#full-packages">Full packages</a>
</li>
<li class="toctree-l3"><a class="reference internal" href="#standards">Standards</a>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#analyzing-large-movies">Analyzing large movies</a>
<ul>
<li class="toctree-l3"><a class="reference internal" href="#playing-large-movies-from-disk">Playing large movies from disk</a>
</li>
<li class="toctree-l3"><a class="reference internal" href="#roi-signal-extraction">ROI signal extraction</a>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#stripe-removal-from-movies">Stripe removal from movies</a>
<ul>
<li class="toctree-l3"><a class="reference internal" href="#example-implementation">Example implementation</a>
</li>
<li class="toctree-l3"><a class="reference internal" href="#removestripsfrommovie">removeStripsFromMovie</a>
</li>
<li class="toctree-l3"><a class="reference internal" href="#sitename">CIAtah</a>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#preprocessing-improving-snr">Preprocessing: Improving SNR</a>
<ul>
<li class="toctree-l3"><a class="reference internal" href="#movie-cell-roi-trace-during-cell-sorting">Movie cell ROI trace during cell sorting</a>
</li>
<li class="toctree-l3"><a class="reference internal" href="#spatial-filtering-during-modelpreprocessmovie-preprocessing">Spatial filtering during modelPreprocessMovie preprocessing</a>
</li>
<li class="toctree-l3"><a class="reference internal" href="#viewmovieregistrationtest">viewMovieRegistrationTest</a>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#movie-filtering">Movie Filtering</a>
<ul>
<li class="toctree-l3"><a class="reference internal" href="#why-conduct-spatial-filtering">Why conduct spatial filtering?</a>
</li>
<li class="toctree-l3"><a class="reference internal" href="#filtering-movies-with-normalizemovie">Filtering movies with normalizeMovie</a>
<ul>
<li class="toctree-l4"><a class="reference internal" href="#fft-bandpass-filtering">FFT bandpass filtering</a>
</li>
<li class="toctree-l4"><a class="reference internal" href="#divide-by-lowpass-filtering">Divide by lowpass filtering</a>
</li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#images-from-unit-test">Images from unit test</a>
<ul>
<li class="toctree-l4"><a class="reference internal" href="#main-filtering-functions">Main filtering functions.</a>
</li>
<li class="toctree-l4"><a class="reference internal" href="#test-function-filtering">Test function filtering</a>
</li>
<li class="toctree-l4"><a class="reference internal" href="#matlab-test-function">Matlab test function</a>
</li>
<li class="toctree-l4"><a class="reference internal" href="#matlab-test-function-movie-output">Matlab test function movie output</a>
</li>
<li class="toctree-l4"><a class="reference internal" href="#imagej-test-function">ImageJ test function</a>
</li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#common-issues">Common Issues</a>
<ul>
<li class="toctree-l4"><a class="reference internal" href="#dark-halos-around-cells">Dark halos around cells</a>
</li>
<li class="toctree-l4"><a class="reference internal" href="#comparison-of-matlab-and-imagej-fft-based-spatial-filtering">Comparison of MATLAB and ImageJ FFT-based spatial filtering</a>
</li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#preprocessing-temporal-downsampling">Preprocessing: Temporal downsampling</a>
<ul>
<li class="toctree-l3"><a class="reference internal" href="#calculating-final-transformation-after-multiple-registration-iterations">Calculating final transformation after multiple registration iterations.</a>
</li>
<li class="toctree-l3"><a class="reference internal" href="#turboreg">Turboreg</a>
<ul>
<li class="toctree-l4"><a class="reference internal" href="#compiling-turboreg-and-transfturboreg-mex-file">Compiling turboreg and transfturboreg mex file</a>
</li>
<li class="toctree-l4"><a class="reference internal" href="#running-turboreg">Running turboreg</a>
</li>
<li class="toctree-l4"><a class="reference internal" href="#old-input">Old input</a>
</li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#cell-extraction_1">Cell extraction</a>
</li>
<li class="toctree-l2"><a class="reference internal" href="#manual-cell-sorting-of-cell-extraction-outputs">Manual cell sorting of cell extraction outputs</a>
<ul>
<li class="toctree-l3"><a class="reference internal" href="#usage">Usage</a>
<ul>
<li class="toctree-l4"><a class="reference internal" href="#signalsorter-use-with-large-or-remote-server-imaging-movies">signalSorter use with large or remote server imaging movies</a>
</li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#interface">Interface</a>
</li>
<li class="toctree-l3"><a class="reference internal" href="#best-practices">Best practices</a>
</li>
<li class="toctree-l3"><a class="reference internal" href="#neighboring-cells">Neighboring cells</a>
</li>
<li class="toctree-l3"><a class="reference internal" href="#common-issues_1">Common issues</a>
</li>
<li class="toctree-l3"><a class="reference internal" href="#examples">Examples</a>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#cross-day-or-session-cell-alignment-alignment">Cross-day or -session cell alignment alignment</a>
<ul>
<li class="toctree-l3"><a class="reference internal" href="#algorithm-overview">Algorithm overview</a>
</li>
<li class="toctree-l3"><a class="reference internal" href="#example-output">Example output</a>
</li>
<li class="toctree-l3"><a class="reference internal" href="#usage_1">Usage</a>
</li>
<li class="toctree-l3"><a class="reference internal" href="#algorithm-results">Algorithm results</a>
<ul>
<li class="toctree-l4"><a class="reference internal" href="#cross-session-metrics-and-results-on-cross-session-amygdala-response-to-pain">Cross-session metrics and results on cross-session amygdala response to pain</a>
</li>
<li class="toctree-l4"><a class="reference internal" href="#pfc-cross-session-alignment">PFC cross-session alignment.</a>
</li>
<li class="toctree-l4"><a class="reference internal" href="#dorsal-striatum-cross-session-algorithm-comparison">Dorsal striatum cross-session algorithm comparison</a>
</li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#animal-tracking">Animal tracking</a>
</li>
<li class="toctree-l2"><a class="reference internal" href="#imagej-based-tracking">ImageJ based tracking</a>
<ul>
<li class="toctree-l3"><a class="reference internal" href="#instructions-for-imagej-and-matlab_1">Instructions for ImageJ and Matlab</a>
</li>
<li class="toctree-l3"><a class="reference internal" href="#example-output-from-animal-in-open-field-during-miniature-microscope-imaging">Example output from animal in open field during miniature microscope imaging</a>
</li>
<li class="toctree-l3"><a class="reference internal" href="#tracking-video">Tracking video</a>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#misc">â€”Miscâ€”</a>
</li>
<li class="toctree-l2"><a class="reference internal" href="#acknowledgments">Acknowledgments</a>
</li>
<li class="toctree-l2"><a class="reference internal" href="#references">References</a>
<ul>
<li class="toctree-l3"><a class="reference internal" href="#turboreg-motion-correction">Turboreg (motion correction)</a>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#questions">Questions?</a>
</li>
<li class="toctree-l2"><a class="reference internal" href="#license">License</a>
</li>
</ul>
</li>
</ul>
<p class="caption"><span class="caption-text">Setup</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../install/">Quick Start</a>
</li>
<li class="toctree-l1"><a class="reference internal" href="../install_alt/">Install</a>
</li>
<li class="toctree-l1"><a class="reference internal" href="../example_data/">Example data</a>
</li>
<li class="toctree-l1"><a class="reference internal" href="../dependencies/">Dependencies</a>
</li>
</ul>
<p class="caption"><span class="caption-text">Repository</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../data/">Data formats</a>
</li>
<li class="toctree-l1"><a class="reference internal" href="../notes/">Notes</a>
</li>
<li class="toctree-l1"><a class="reference internal" href="../organization/">Organization</a>
</li>
</ul>
<p class="caption"><span class="caption-text">Processing imaging data</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../pipeline_overview/">Overview</a>
</li>
<li class="toctree-l1"><a class="reference internal" href="../pipeline_detailed_all/">One-page step-by-step</a>
</li>
<li class="toctree-l1"><a class="reference internal" href="../pipeline_detailed/">One-page step-by-step (auto)</a>
</li>
<li class="toctree-l1"><a class="reference internal" href="../pipeline_detailed_downsample_raw/">1| Downsample raw movies</a>
</li>
<li class="toctree-l1"><a class="reference internal" href="../pipeline_detailed_preprocess_check/">2| Check pre-process settings</a>
</li>
<li class="toctree-l1"><a class="reference internal" href="../pipeline_detailed_preprocess/">3| <u><strong>Processing imaging movies</strong></u></a>
</li>
<li class="toctree-l1"><a class="reference internal" href="../pipeline_detailed_modify_movies/">4| Movie clean-up</a>
</li>
<li class="toctree-l1"><a class="reference internal" href="../pipeline_detailed_signal_extraction/">5| <u><strong>Cell extraction</strong></u></a>
</li>
<li class="toctree-l1"><a class="reference internal" href="../pipeline_detailed_signal_extraction_load/">6| Loading cell extraction outputs</a>
</li>
<li class="toctree-l1"><a class="reference internal" href="../pipeline_detailed_signal_extraction_validation/">7| <u><strong>Cell extraction validation</strong></u></a>
</li>
<li class="toctree-l1"><a class="reference internal" href="../pipeline_detailed_signal_sorting_manual/">8| <u><strong>Manual cell sorting</strong></u></a>
</li>
<li class="toctree-l1"><a class="reference internal" href="../pipeline_detailed_signal_region_analysis/">9| Region-specific analysis</a>
</li>
<li class="toctree-l1"><a class="reference internal" href="../pipeline_detailed_cross_session/">10| <u><strong>Cross-session alignment</strong></u></a>
</li>
</ul>
<p class="caption"><span class="caption-text">Spinal cord motion correction</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../pipeline_detailed_spinal/">Spinal cord motion correction</a>
</li>
</ul>
<p class="caption"><span class="caption-text">Animal tracking</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../pipeline_animal_tracking/">Animal tracking (ImageJ+MATLAB)</a>
</li>
</ul>
<p class="caption"><span class="caption-text">API</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../api_example_pipeline/">Custom pipelines</a>
</li>
<li class="toctree-l1"><a class="reference internal" href="../api_ciapkg/">ciapkg</a>
</li>
</ul>
<p class="caption"><span class="caption-text">Help</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../help_issues/">Issues and fixes</a>
</li>
<li class="toctree-l1"><a class="reference internal" href="../blank/"><div class="subsection1">Data</div></a>
</li>
<li class="toctree-l1"><a class="reference internal" href="../help_inscopix/">Inscopix</a>
</li>
<li class="toctree-l1"><a class="reference internal" href="../help_nwb/">Neurodata Without Borders</a>
</li>
<li class="toctree-l1"><a class="reference internal" href="../blank/"><div class="subsection1">Interface</div></a>
</li>
<li class="toctree-l1"><a class="reference internal" href="../help_contrast/">Movie display and noise</a>
</li>
<li class="toctree-l1"><a class="reference internal" href="../blank/"><div class="subsection1">Analysis</div></a>
</li>
<li class="toctree-l1"><a class="reference internal" href="../help_analysis_methods/">Analysis methods</a>
</li>
<li class="toctree-l1"><a class="reference internal" href="../help_large_movie_analysis/">Large movie analysis</a>
</li>
<li class="toctree-l1"><a class="reference internal" href="../help_stripe_removal/">Stripe removal</a>
</li>
<li class="toctree-l1"><a class="reference internal" href="../help_snr/">Improving signal-to-noise</a>
</li>
<li class="toctree-l1"><a class="reference internal" href="../help_spatial_filtering/">Spatial filtering</a>
</li>
<li class="toctree-l1"><a class="reference internal" href="../help_temporal_downsampling/">Temporal downsampling</a>
</li>
<li class="toctree-l1"><a class="reference internal" href="../help_motion_correction/">Motion correction</a>
</li>
<li class="toctree-l1"><a class="reference internal" href="../help_cell_extraction/">Cell extraction</a>
</li>
<li class="toctree-l1"><a class="reference internal" href="../help_manual_cell_sorting/">Manual cell sorting</a>
</li>
<li class="toctree-l1"><a class="reference internal" href="../help_cross_session_alignment/">Cross-session alignemnt</a>
</li>
<li class="toctree-l1"><a class="reference internal" href="../help_animal_tracking/">Animal tracking</a>
</li>
</ul>
<p class="caption"><span class="caption-text">Misc</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../acknowledgments/">Acknowledgments</a>
</li>
<li class="toctree-l1"><a class="reference internal" href="../references/">Cite</a>
</li>
<li class="toctree-l1"><a class="reference internal" href="../questions/">Questions</a>
</li>
<li class="toctree-l1"><a class="reference internal" href="../license/">License</a>
</li>
</ul>
</div>
</div>
</nav>
<section class="wy-nav-content-wrap" data-toggle="wy-nav-shift">
<nav aria-label="top navigation" class="wy-nav-top" role="navigation">
<i class="fa fa-bars" data-toggle="wy-nav-top"></i>
<a href="..">CIAtah</a>
</nav>
<div class="wy-nav-content">
<div class="rst-content">
<div aria-label="breadcrumbs navigation" role="navigation">
<ul class="wy-breadcrumbs">
<li><a href="..">Docs</a> »</li>
<li>End-to-end »</li>
<li>One-page readme (auto)</li>
<li class="wy-breadcrumbs-aside">
</li>
</ul>
<hr/>
</div>
<div role="main">
<div class="section">
<h1 id="ciatah-one-page-readme">CIAtah one-page README<a class="headerlink" href="#ciatah-one-page-readme" title="Permanent link">¶</a></h1>
<p>This page contains all the documents in a single page and is automatically updated to reflect the current state of each page.</p>
<h2 id="setup"><div class="subsection1"><em>â€”Setupâ€”</em></div><a class="headerlink" href="#setup" title="Permanent link">¶</a></h2>
<!-- --8<-- -->
<h2 id="quick-start-guide">Quick start guide<a class="headerlink" href="#quick-start-guide" title="Permanent link">¶</a></h2>
<p>Below are steps needed to quickly get started using the <code>CIAtah</code> software package in MATLAB.</p>
<h3 id="install">Install<a class="headerlink" href="#install" title="Permanent link">¶</a></h3>
<ul>
<li>Clone the <code>CIAtah</code> repository (using <a href="https://desktop.github.com/">GitHub desktop</a> or command line) or download the repository zip and unzip  (e.g. run below MATLAB command).</li>
</ul>
<ul>
<li>
<p>Point the MATLAB path to the <code>CIAtah</code> root folder (<em>NOT</em> <code>@ciatah</code> sub-folder in the repository).</p>
<ul>
<li>Alternatively, download the package from <code>File Exchange</code> using the Add-Ons explorer in MATLAB. See <code>CIAtah</code> entry at:</li>
</ul>
</li>
</ul>
<p><a href="https://www.mathworks.com/matlabcentral/fileexchange/75466-calciumimaginganalysis"><img alt="View {{ site.name }} on File Exchange" src="https://www.mathworks.com/matlabcentral/images/matlab-file-exchange.svg"/></a> or <a href="https://www.mathworks.com/matlabcentral/fileexchange/75466-calciumimaginganalysis">https://www.mathworks.com/matlabcentral/fileexchange/75466-calciumimaginganalysis</a>.</p>
<div class="codehilite"><pre><span></span><code><span class="lineno" data-linenos=" 1 "></span><span class="c">% Optional: this will set MATLAB working folder to the default user path. Make sure you have read/write permissions.</span>
<span class="lineno" data-linenos=" 2 "></span>
<span class="lineno" data-linenos=" 3 "></span><span class="k">try</span><span class="p">;</span> <span class="n">cd</span><span class="p">(</span><span class="n">userpath</span><span class="p">);</span> <span class="k">catch</span><span class="p">;</span> <span class="k">end</span><span class="p">;</span>
<span class="lineno" data-linenos=" 4 "></span>
<span class="lineno" data-linenos=" 5 "></span>
<span class="lineno" data-linenos=" 6 "></span>
<span class="lineno" data-linenos=" 7 "></span><span class="c">% Download and unzip current repository</span>
<span class="lineno" data-linenos=" 8 "></span>
<span class="lineno" data-linenos=" 9 "></span><span class="n">unzip</span><span class="p">(</span><span class="s">'https://github.com/bahanonu/ciatah/archive/master.zip'</span><span class="p">);</span>
<span class="lineno" data-linenos="10 "></span>
<span class="lineno" data-linenos="11 "></span>
<span class="lineno" data-linenos="12 "></span>
<span class="lineno" data-linenos="13 "></span><span class="c">% Make CIAtah the working folder</span>
<span class="lineno" data-linenos="14 "></span>
<span class="lineno" data-linenos="15 "></span><span class="n">cd</span><span class="p">(</span><span class="s">'ciatah-master'</span><span class="p">)</span>
</code></pre></div>
<h3 id="check-required-toolboxes-installed">Check required toolboxes installed<a class="headerlink" href="#check-required-toolboxes-installed" title="Permanent link">¶</a></h3>
<p><code>CIAtah</code> depends on several MATLAB toolboxes to run properly. Run the below command to have <code>CIAtah</code> check whether dependencies have been installed properly. If not use the <code>Add-Ons</code> (<a href="https://www.mathworks.com/help/matlab/matlab_env/get-add-ons.html">https://www.mathworks.com/help/matlab/matlab_env/get-add-ons.html</a>) explorer to install each toolbox.</p>
<div class="codehilite"><pre><span></span><code><span class="lineno" data-linenos="1 "></span><span class="n">ciapkg</span><span class="p">.</span><span class="n">io</span><span class="p">.</span><span class="n">matlabToolboxCheck</span><span class="p">;</span>`
</code></pre></div>
<h3 id="setup-sitename">Setup <code>CIAtah</code><a class="headerlink" href="#setup-sitename" title="Permanent link">¶</a></h3>
<ul>
<li>Run <code>CIAtah</code> using the below MATLAB commands. Call <code>obj;</code> in the MATLAB command window each time you want to go back to the main GUI. <strong>Note: <code>calciumImagingAnalysis</code> class is now called <code>ciatah</code>, all functionality is the same.</strong></li>
</ul>
<div class="codehilite"><pre><span></span><code><span class="lineno" data-linenos=" 1 "></span><span class="c">% Run these commands in MATLAB to get started.</span>
<span class="lineno" data-linenos=" 2 "></span>
<span class="lineno" data-linenos=" 3 "></span>
<span class="lineno" data-linenos=" 4 "></span>
<span class="lineno" data-linenos=" 5 "></span><span class="c">% Loads the class into an object for use in this session</span>
<span class="lineno" data-linenos=" 6 "></span>
<span class="lineno" data-linenos=" 7 "></span><span class="n">obj</span> <span class="p">=</span> <span class="p">ciatah;</span>
<span class="lineno" data-linenos=" 8 "></span>
<span class="lineno" data-linenos=" 9 "></span>
<span class="lineno" data-linenos="10 "></span>
<span class="lineno" data-linenos="11 "></span><span class="c">% Runs routines to check dependencies and help user get setup.</span>
<span class="lineno" data-linenos="12 "></span>
<span class="lineno" data-linenos="13 "></span><span class="n">obj</span><span class="p">.</span><span class="n">setup</span><span class="p">;</span>
<span class="lineno" data-linenos="14 "></span>
<span class="lineno" data-linenos="15 "></span>
<span class="lineno" data-linenos="16 "></span>
<span class="lineno" data-linenos="17 "></span><span class="c">% Open the class menu (always type `obj` then enter load the class/modules menu)</span>
<span class="lineno" data-linenos="18 "></span>
<span class="lineno" data-linenos="19 "></span><span class="n">obj</span> <span class="s">%</span> <span class="s">then</span> <span class="s">hit</span> <span class="s">enter,</span> <span class="s">no</span> <span class="s">semicolon!</span>
</code></pre></div>
<ul>
<li>Afterwards, likely want to run <code>modelAddNewFolders</code> module first in order to add folders containing imaging data to the current class object.</li>
</ul>
<ul>
<li>[Optional] Users on Windows systems should download <code>Everything</code> (<a href="https://www.voidtools.com/">https://www.voidtools.com/</a>). It is a very useful and extremely fast search engine for files and folders on a computer that can allow users to quickly get lists of folders then need to analyze in <code>CIAtah</code>.</li>
</ul>
<ul>
<li>[Optional] Users who want to run analysis via the command line can run <code>edit ciapkg.demo.cmdLinePipeline</code> and run each segment of code there to see what commands are needed to perform each step. It assumes you have already run <code>example_downloadTestData</code>.</li>
</ul>
<h3 id="sitename-main-gui-notes"><code>CIAtah</code> main GUI notes<a class="headerlink" href="#sitename-main-gui-notes" title="Permanent link">¶</a></h3>
<ul>
<li>All main decisions for choosing a method/procedure to run, cell-extraction algorithm, and which folders to analyze are in a single window.</li>
</ul>
<ul>
<li>The GUI will real-time update the selected folders based on the selections in the subject, assay, and folder filter areas.</li>
</ul>
<ul>
<li>Sections not relevant for a specific method are grayed out.</li>
</ul>
<ul>
<li>Tab to cycle through selection areas. Green background is the currently selected area, dark gray background is area that had previously been selected but is not the active area, and white background is for areas that have not been selected yet.</li>
</ul>
<ul>
<li>Hover mouse over method names for tooltip that gives additional information.</li>
</ul>
<p><strong>For example, selecting middle two assays automatically changes selection in <code>Loaded folders</code> section.</strong></p>
<p><a href="https://user-images.githubusercontent.com/5241605/79494880-96ed0280-7fd8-11ea-85e1-05a13dc26e90.png" target="_blank"><img alt="image" height="auto" src="https://user-images.githubusercontent.com/5241605/79494880-96ed0280-7fd8-11ea-85e1-05a13dc26e90.png" width="45%"/></a></p>
<p><a href="https://user-images.githubusercontent.com/5241605/79494959-b97f1b80-7fd8-11ea-8197-7be457d24638.png" target="_blank"><img alt="image" height="auto" src="https://user-images.githubusercontent.com/5241605/79494959-b97f1b80-7fd8-11ea-8197-7be457d24638.png" width="45%"/></a></p>
<p><strong>Certain sections become available when user selects the appropriate method (e.g. cell-extraction method available when selecting <code>modelExtractSignalsFromMovie</code>).</strong></p>
<p><a href="https://user-images.githubusercontent.com/5241605/79495026-d4ea2680-7fd8-11ea-8d4d-02164e1af1d6.png" target="_blank"><img alt="image" height="auto" src="https://user-images.githubusercontent.com/5241605/79495026-d4ea2680-7fd8-11ea-8d4d-02164e1af1d6.png" width="50%"/></a></p>
<h3 id="additional-quick-start-notes">Additional quick start notes<a class="headerlink" href="#additional-quick-start-notes" title="Permanent link">¶</a></h3>
<ul>
<li>See additional details in <a href="#processing-calcium-imaging-data">Processing calcium imaging data</a> for running the full processing pipeline.</li>
</ul>
<ul>
<li>Settings used to pre-process imaging movies (<code>modelPreprocessMovie</code> module) are stored inside the HDF5 file to allow <code>CIAtah</code> to load them again later.</li>
</ul>
<ul>
<li>To force load all directories, including most external software packages (in <code>_external_programs</code> folder), type <code>ciapkg.loadAllDirs;</code> into MATLAB command line. This is most relevant when you need to access specific functions in an outside repository that are normally hidden until needed.</li>
</ul>
<ul>
<li>When issues are encountered, first check the <code>*Common issues and fixes</code> Wiki page to see if a solution is there. Else, submit a new issue or email Biafra (bahanonu [at] alum.mit.edu).</li>
</ul>
<ul>
<li>
<p>Notes:</p>
<ul>
<li>
<p>There are two sets of test data that are downloaded:</p>
<ul>
<li><strong>Single session analysis</strong>: <code>data\2014_04_01_p203_m19_check01_raw</code> can be used to test the pipeline until the cross-session alignment step.</li>
</ul>
<ul>
<li><strong>Batch analysis</strong>: <code>data\batch</code> contains three imaging sessions that should be processed and can then be used for the cross-session alignment step. Users should try these sessions to get used to batched analysis.</li>
</ul>
</li>
</ul>
<ul>
<li>
<p>For Fiji dependency, when path to <code>Miji.m</code> (e.g. <code>\Fiji.app\scripts</code> folder) is requested, likely in <code>\_external_programs\FIJI_FOLDER\Fiji.app\scripts</code> where <code>FIJI_FOLDER</code> varies depending on OS, unless the user requested a custom path or on OSX (in which case, find Fiji the install directory).</p>
<ul>
<li>If you run into Java heap space memory errors when Miji tries to load Fiji in MATLAB, make sure "java.opts" file is in MATLAB start-up folder or that <code>CIAtah</code> folder is the MATLAB start-up folder (<a href="https://www.mathworks.com/help/matlab/matlab_env/matlab-startup-folder.html">instructions on changing</a>).</li>
</ul>
</li>
</ul>
<ul>
<li>
<p><code>CIAtah</code> often uses <a href="https://www.cheatography.com/davechild/cheat-sheets/regular-expressions/">regular expressions</a> to find relevant movie and other files in folders to analyze.</p>
<ul>
<li>For example, by default it looks for any movie files in a folder containing <code>concat</code>, e.g. <code>concat_recording_20140401_180333.h5</code> (test data). If you have a file called <code>rawData_2019_01_01_myInterestingExperiment.avi</code> and all your raw data files start with <code>rawData_</code> then change the regular expression to <code>rawData_</code> when requested by the repository. See <code>setMovieInfo</code> module to change after adding new folders.</li>
</ul>
</li>
</ul>
<ul>
<li><code>CIAtah</code> generally assumes users have imaging data associated with <em>one</em> imaging session and animal in a given folder. Follow folder naming conventions in <a href="#data">Data</a> for best experience.</li>
</ul>
<ul>
<li>External software packages are downloaded into <code>_external_programs</code> folder and should be placed there if done manually.</li>
</ul>
</li>
</ul>
<p>Users can alternatively run setup as below.</p>
<div class="codehilite"><pre><span></span><code><span class="lineno" data-linenos=" 1 "></span><span class="c">% Run these commands in MATLAB to get started.</span>
<span class="lineno" data-linenos=" 2 "></span>
<span class="lineno" data-linenos=" 3 "></span>
<span class="lineno" data-linenos=" 4 "></span>
<span class="lineno" data-linenos=" 5 "></span><span class="c">% Loads all directories</span>
<span class="lineno" data-linenos=" 6 "></span>
<span class="lineno" data-linenos=" 7 "></span><span class="n">loadBatchFxns</span><span class="p">;</span>
<span class="lineno" data-linenos=" 8 "></span>
<span class="lineno" data-linenos=" 9 "></span>
<span class="lineno" data-linenos="10 "></span>
<span class="lineno" data-linenos="11 "></span><span class="c">% Loads the class into an object for use in this session</span>
<span class="lineno" data-linenos="12 "></span>
<span class="lineno" data-linenos="13 "></span><span class="n">obj</span> <span class="p">=</span> <span class="p">ciatah;</span>
<span class="lineno" data-linenos="14 "></span>
<span class="lineno" data-linenos="15 "></span>
<span class="lineno" data-linenos="16 "></span>
<span class="lineno" data-linenos="17 "></span><span class="c">% Download and load dependent software packages into "_external_programs" folder.</span>
<span class="lineno" data-linenos="18 "></span>
<span class="lineno" data-linenos="19 "></span><span class="c">% Also download test data into "data" folder.</span>
<span class="lineno" data-linenos="20 "></span>
<span class="lineno" data-linenos="21 "></span><span class="c">% Normally only need to one once after first downloading CIAtah package.</span>
<span class="lineno" data-linenos="22 "></span>
<span class="lineno" data-linenos="23 "></span><span class="n">obj</span><span class="p">.</span><span class="n">loadDependencies</span><span class="p">;</span>
<span class="lineno" data-linenos="24 "></span>
<span class="lineno" data-linenos="25 "></span>
<span class="lineno" data-linenos="26 "></span>
<span class="lineno" data-linenos="27 "></span><span class="c">% Add folders containing imaging data.</span>
<span class="lineno" data-linenos="28 "></span>
<span class="lineno" data-linenos="29 "></span><span class="n">obj</span><span class="p">.</span><span class="n">modelAddNewFolders</span><span class="p">;</span>
<span class="lineno" data-linenos="30 "></span>
<span class="lineno" data-linenos="31 "></span>
<span class="lineno" data-linenos="32 "></span>
<span class="lineno" data-linenos="33 "></span><span class="c">% [optional] Set the names CIAtah will look for in each folder</span>
<span class="lineno" data-linenos="34 "></span>
<span class="lineno" data-linenos="35 "></span><span class="n">obj</span><span class="p">.</span><span class="n">setMovieInfo</span><span class="p">;</span>
<span class="lineno" data-linenos="36 "></span>
<span class="lineno" data-linenos="37 "></span>
<span class="lineno" data-linenos="38 "></span>
<span class="lineno" data-linenos="39 "></span><span class="c">% Open class menu to pick module to run.</span>
<span class="lineno" data-linenos="40 "></span>
<span class="lineno" data-linenos="41 "></span><span class="n">obj</span><span class="p">.</span><span class="n">runPipeline</span><span class="p">;</span> <span class="c">% then hit enter!</span>
</code></pre></div>
<h2 id="installation">Installation<a class="headerlink" href="#installation" title="Permanent link">¶</a></h2>
<p>Note, this is an alternative method of installation to that outlined in <a href="../install/">Quick Start</a>.</p>
<p>Clone the <code>CIAtah</code> repository or download the repository zip and unzip.</p>
<ul>
<li>Point the MATLAB path to the <code>CIAtah</code> folder.</li>
</ul>
<ul>
<li>Run <code>loadBatchFxns.m</code> before using functions in the directory. This adds all needed directories and sub-directories to the MATLAB path.</li>
</ul>
<ul>
<li>Type <code>obj = ciatah;</code> into MATLAB command window and follow instructions that appear after to add data and run analysis.</li>
</ul>
<ul>
<li>Run the <code>ciatah</code> class method <code>loadDependencies</code> or type <code>obj.loadDependencies</code> after initializing a <code>ciatah</code> object into the command window to download and add Fiji to path, download CNMF/CNMF-E repositories, download/setup CVX (for CNMF/CNMF-E), and download example data.</li>
</ul>
<p>Note</p>
<ul>
<li>Place <code>CIAtah</code> in a folder where MATLAB will have write permissions, as it also creates a <code>private</code> subdirectory to store some user information along with downloading required external software packages.</li>
</ul>
<ul>
<li><code>file_exchange</code> folder contains File Exchange functions used by <code>CIAtah</code>.</li>
</ul>
<ul>
<li>In general, it is best to set the MATLAB startup directory to the <code>CIAtah</code> folder. This allows <code>java.opts</code> and <code>startup.m</code> to set the correct Java memory requirements and load the correct folders into the MATLAB path.</li>
</ul>
<ul>
<li>If <code>CIAtah</code> IS NOT the startup folder, place <code>java.opts</code> wherever the MATLAB startup folder is so the correct Java memory requirements are set (important for using ImageJ/Miji in MATLAB).</li>
</ul>
<ul>
<li>If it appears an old <code>CIAtah</code> repository is loaded after pulling a new version, run <code>restoredefaultpath</code> and check that old <code>CIAtah</code> folders are not in the MATLAB path.</li>
</ul>
 - This version of `CIAtah` has been tested on Windows MATLAB `2015b`, `2017a`, and `2018b`. Moderate testing on Windows and OSX (10.10.5) `2017b` and `2018b`. 
<h4 id="example-data">Example data<a class="headerlink" href="#example-data" title="Permanent link">¶</a></h4>
<p>The <code>CIAtah</code> repository contains several example one-photon calcium imaging movies from miniature microscope experiments in freely moving rodents.</p>
<p>To download example data, run <code>loadDependencies</code> module (e.g. <code>obj.loadDependencies</code>) and select <code>Download test one-photon data.</code> option to download one-photon miniature microscope example datasets to use for testing <code>CIAtah</code> preprocessing, cell extraction, and cell classification code. The data will be located in the <code>data</code> folder within the repository root directory.</p>
<p>Else run <code>example_downloadTestData.m</code> from the MATLAB command line with the working directory set to the <code>CIAtah</code> repository.</p>
<h4 id="dependencies">Dependencies<a class="headerlink" href="#dependencies" title="Permanent link">¶</a></h4>
<p>By default external MATLAB-based software packages are stored in <code>_external_programs</code>.</p>
<h5 id="matlab-toolbox-dependencies">MATLAB Toolbox dependencies<a class="headerlink" href="#matlab-toolbox-dependencies" title="Permanent link">¶</a></h5>
<ul>
<li>
<p>Primary toolboxes</p>
<ul>
<li>distrib_computing_toolbox</li>
</ul>
<ul>
<li>image_toolbox</li>
</ul>
<ul>
<li>signal_toolbox</li>
</ul>
<ul>
<li>statistics_toolbox</li>
</ul>
</li>
</ul>
<ul>
<li>
<p>Secondary toolboxes (not required for main pre-processing pipeline)</p>
<ul>
<li>video_and_image_blockset</li>
</ul>
<ul>
<li>bioinformatics_toolbox</li>
</ul>
<ul>
<li>financial_toolbox</li>
</ul>
<ul>
<li>neural_network_toolbox</li>
</ul>
</li>
</ul>
<h5 id="parallel-computing-toolbox-pct">Parallel Computing Toolbox (PCT)<a class="headerlink" href="#parallel-computing-toolbox-pct" title="Permanent link">¶</a></h5>
<p>By default both <code>CIAtah</code> and PCT auto-start a parallel pool for functions that use parallelization (e.g. or calls to <code>parfor</code>). For some users this may not be desired, in that case go to MATLAB preferences and uncheck the below.</p>
<p><img alt="image" src="https://user-images.githubusercontent.com/5241605/67807212-99bb6180-fa51-11e9-81e1-9ab0fac8847a.png"/></p>
<p>Or enter the following commands into the MATLAB command window:</p>
<div class="codehilite"><pre><span></span><code><span class="lineno" data-linenos="1 "></span><span class="n">parSet</span> <span class="p">=</span> <span class="n">parallel</span><span class="p">.</span><span class="n">Settings</span><span class="p">;</span>
<span class="lineno" data-linenos="2 "></span>
<span class="lineno" data-linenos="3 "></span><span class="n">parSet</span><span class="p">.</span><span class="n">Pool</span><span class="p">.</span><span class="n">AutoCreate</span> <span class="p">=</span> <span class="n">false</span><span class="p">;</span>
</code></pre></div>
<h5 id="imagej">ImageJ<a class="headerlink" href="#imagej" title="Permanent link">¶</a></h5>
<ul>
<li>Run <code>downloadMiji</code> from <code>downloads\downloadMiji.m</code> or <code>obj.loadDependencies</code> (when class initialized) to download Fiji version appropriate to your platform.</li>
</ul>
<ul>
<li>Else download Fiji (preferably <strong>2015 December 22</strong> version): <a href="https://imagej.net/Fiji/Downloads">https://imagej.net/Fiji/Downloads</a>.</li>
</ul>
<ul>
<li>Make sure have Miji in Fiji installation: <a href="http://bigwww.epfl.ch/sage/soft/mij/">http://bigwww.epfl.ch/sage/soft/mij/</a>.</li>
</ul>
<ul>
<li>This is used as an alternative to the <code>CIAtah</code> <code>playMovie.m</code> function for viewing movies and is needed for some movie modification steps.</li>
</ul>
<h5 id="saleae">Saleae<a class="headerlink" href="#saleae" title="Permanent link">¶</a></h5>
<ul>
<li><em>Only download</em> if doing behavior and imaging experiments that use this DAQ device to collect data.</li>
</ul>
<ul>
<li>Download 1.2.26: <a href="https://support.saleae.com/logic-software/legacy-software/older-software-releases#1-2-26-download">https://support.saleae.com/logic-software/legacy-software/older-software-releases#1-2-26-download</a>.</li>
</ul>
<h5 id="cnmf-and-cnmf-e">CNMF and CNMF-E<a class="headerlink" href="#cnmf-and-cnmf-e" title="Permanent link">¶</a></h5>
<ul>
<li>Download repositories by running <code>downloadCnmfGithubRepositories.m</code> or <code>obj.loadDependencies</code> (when class is initialized).</li>
</ul>
<ul>
<li>CNMF: <a href="https://github.com/flatironinstitute/CaImAn-MATLAB">https://github.com/flatironinstitute/CaImAn-MATLAB</a>.</li>
</ul>
<ul>
<li>
<p>CNMF-E: <a href="https://github.com/bahanonu/CNMF_E">https://github.com/bahanonu/CNMF_E</a></p>
<ul>
<li>forked from <a href="https://github.com/zhoupc/CNMF_E">https://github.com/zhoupc/CNMF_E</a> to fix HDF5, movies with NaNs, and other related compatibility issues.</li>
</ul>
</li>
</ul>
<ul>
<li>
<p>CVX: <a href="http://cvxr.com/cvx/download/">http://cvxr.com/cvx/download/</a>.</p>
<ul>
<li>Download <code>All platforms</code> (<em>Redistributable: free solvers only</em>), e.g. <a href="http://web.cvxr.com/cvx/cvx-rd.zip">http://web.cvxr.com/cvx/cvx-rd.zip</a>.</li>
</ul>
</li>
</ul>
<h5 id="neurodata-without-borders">Neurodata Without Borders<a class="headerlink" href="#neurodata-without-borders" title="Permanent link">¶</a></h5>
<p>Neurodata Without Borders (NWB) file support requires the following GitHub repositories be present in the <code>_external_programs</code> folder. These are downloaded automatically when running <code>obj.setup</code>.</p>
<ul>
<li><a href="https://github.com/schnitzer-lab/nwb_schnitzer_lab">https://github.com/schnitzer-lab/nwb_schnitzer_lab</a>.</li>
</ul>
<ul>
<li><a href="https://github.com/ewiger/yamlmatlab">https://github.com/ewiger/yamlmatlab</a>.</li>
</ul>
<ul>
<li><a href="https://github.com/NeurodataWithoutBorders/matnwb">https://github.com/NeurodataWithoutBorders/matnwb</a>.</li>
</ul>
<h2 id="repository"><div class="subsection1"><em>â€”Repositoryâ€”</em></div><a class="headerlink" href="#repository" title="Permanent link">¶</a></h2>
<h2 id="data">Data<a class="headerlink" href="#data" title="Permanent link">¶</a></h2>
<p>The class generally operates on the principal that a single imaging session is contained within a single folder or directory. Thus, even if a single imaging session contains multiple trials (e.g. the imaging data is split across multiple movies) this is fine as the class will concatenate them during the preprocessing step should the user request that.</p>
<p>The naming convention in general is below. Both TIF and AVI raw files are supported and are converted to HDF5 after processing since that format offers more flexibility during cell extraction and other analysis steps.</p>
<h4 id="input-and-output-files">Input and output files<a class="headerlink" href="#input-and-output-files" title="Permanent link">¶</a></h4>
<ul>
<li>Default raw imaging data filename: <code>concat_.*.(h5|tif)</code>.</li>
</ul>
<ul>
<li>Default raw processed data filename: <code>folderName_(processing steps).h5</code>, where <code>folderName</code> is the directory name where the calcium imaging movies are located.</li>
</ul>
<ul>
<li>
<p>Main files output by <code>CIAtah</code>. Below, <code>.*</code> normally indicates the folder name prefixed to the filename.</p>
<ul>
<li><code>.*_pcaicaAnalysis.mat</code>: Where PCA-ICA outputs are stored.</li>
</ul>
<ul>
<li><code>.*_ICdecisions_.*.mat</code>: Where decisions for cell (=1) and not cell (=0) are stored in a <code>valid</code> variable.</li>
</ul>
<ul>
<li><code>.*_regionModSelectUser.mat</code>: A mask of the region (=1) to include in further analyses.</li>
</ul>
<ul>
<li><code>.*_turboreg_crop_dfof_1.h5</code>: Processed movie, in this case motion corrected, cropped, and Î”_F/F_.</li>
</ul>
<ul>
<li><code>processing_info</code>: a folder containing preprocessing information.</li>
</ul>
</li>
</ul>
<h4 id="loading-data">Loading data<a class="headerlink" href="#loading-data" title="Permanent link">¶</a></h4>
<p>Users can load data from any NWB or CIAtah-style MAT files containing cell-extraction outputs using the <code>ciapkg.io.loadSignalExtraction</code> function as below.</p>
<div class="codehilite"><pre><span></span><code><span class="lineno" data-linenos="1 "></span><span class="p">[</span><span class="n">inputImages</span><span class="p">,</span><span class="n">inputSignals</span><span class="p">,</span><span class="n">infoStruct</span><span class="p">,</span><span class="n">algorithmStr</span><span class="p">,</span><span class="n">inputSignals2</span><span class="p">]</span> <span class="p">=</span> <span class="n">ciapkg</span><span class="p">.</span><span class="n">io</span><span class="p">.</span><span class="n">loadSignalExtraction</span><span class="p">(</span><span class="n">fileName</span><span class="p">);</span>
</code></pre></div>
<h4 id="nwb-support">NWB Support<a class="headerlink" href="#nwb-support" title="Permanent link">¶</a></h4>
<p>CIAtah supports NWB format and by default will output cell-extraction analysis as CIAtah format unless user specifies otherwise. NWB files are by default stored in the <code>nwbFiles</code> sub-folder. This can be changed by setting the <code>obj.nwbFileFolder</code> property to a different folder name. Learn more about saving and loading</p>
<ul>
<li>Default image mask HDF5 dataset name: <code>/processing/ophys/ImageSegmentation/PlaneSegmentation</code>.</li>
</ul>
<ul>
<li>Default fluorescence activity HDF5 dataset name: <code>/processing/ophys/Fluorescence/RoiResponseSeries</code>.</li>
</ul>
<h4 id="preferred-folder-naming-format">Preferred folder naming format<a class="headerlink" href="#preferred-folder-naming-format" title="Permanent link">¶</a></h4>
<p>Folders should following the format <code>YYYY_MM_DD_pXXX_mXXX_assayXX_trialXX</code> where:</p>
<ul>
<li><code>YYYY_MM_DD</code> = normal year/month/day scheme.</li>
</ul>
<ul>
<li><code>pXXX</code> = protocol number, e.g. p162, for the set of experiments performed for the same set of animals.</li>
</ul>
<ul>
<li><code>mXXX</code> = subject ID/number, e.g. m805 or animal ID.</li>
</ul>
<ul>
<li><code>assayXX</code> = assay ID and session number, e.g. vonfrey01 is the 1st von Frey assay session.</li>
</ul>
<ul>
<li><code>trialXX</code> = the trial number of the current assay session, only applicable if multiple trials in the same assay session.</li>
</ul>
<h4 id="videos">Videos<a class="headerlink" href="#videos" title="Permanent link">¶</a></h4>
<ul>
<li>
<p>HDF5:</p>
<ul>
<li>Saved as a <code>[x y t]</code> 3D matrix where <code>x</code> and <code>y</code> are the height and width of video while <code>t</code> is number of frames.</li>
</ul>
<ul>
<li><code>/1</code> as the name for directory containing movie data.</li>
</ul>
<ul>
<li>HDF can be read in using Fiji, see <a href="http://lmb.informatik.uni-freiburg.de/resources/opensource/imagej_plugins/hdf5.html">http://lmb.informatik.uni-freiburg.de/resources/opensource/imagej_plugins/hdf5.html</a>.</li>
</ul>
<ul>
<li>Each HDF5 file should contain imaging data in a dataset name, e.g. <code>/1</code> is the default datasetname for <code>[x y frames]</code> 2D calcium imaging movies in this repository.</li>
</ul>
<ul>
<li>Most functions have a <code>inputDatasetName</code> option to specify the dataset name if different from <code>/1</code>.</li>
</ul>
</li>
</ul>
<ul>
<li>
<p>TIF</p>
<ul>
<li>Normal <code>[x y frames]</code> tif.</li>
</ul>
</li>
</ul>
<ul>
<li>
<p>AVI</p>
<ul>
<li>Raw uncompressed grayscale <code>[x y frames]</code> avi.</li>
</ul>
</li>
</ul>
<h4 id="cell-images">Cell images<a class="headerlink" href="#cell-images" title="Permanent link">¶</a></h4>
<ul>
<li>
<p>IC filters from PCA-ICA and images from CNMF(-E).</p>
<ul>
<li><code>[x y n]</code> matrix</li>
</ul>
<ul>
<li><code>x</code> and <code>y</code> being height/width of video and <code>n</code> is number of ICs output.</li>
</ul>
</li>
</ul>
<h4 id="cell-traces">Cell traces<a class="headerlink" href="#cell-traces" title="Permanent link">¶</a></h4>
<ul>
<li>
<p>IC traces from PCA-ICA and images from CNMF(-E).</p>
<ul>
<li><code>[n f]</code> matrix.</li>
</ul>
<ul>
<li><code>n</code> is number of ICs output and <code>f</code> is number of movie frames.</li>
</ul>
<h3 id="repository-notes">Repository notes<a class="headerlink" href="#repository-notes" title="Permanent link">¶</a></h3>
<ul>
<li>Covers preprocessing of calcium imaging videos, cell and activity trace extraction (supports the following methods: PCA-ICA, CELLMax, EXTRACT, CNMF, CNMF-E, and ROI), manual and automated sorting of cell extraction outputs, cross-session alignment of cells, and more.</li>
</ul>
</li>
</ul>
<ul>
<li>Supports <code>PCA-ICA</code>, <code>CNMF</code>, <code>CNMF-E</code>, <code>EXTRACT</code>, and <code>ROI</code> cell extraction methods publicly along with <code>CELLMax</code> for Schnitzer Lab collaborators. Additional methods can be integrated upon request.</li>
</ul>
<ul>
<li>Most extensively tested on Windows MATLAB <code>2018b</code> and <code>2019a</code>. Moderate testing on Windows MATLAB <code>2015b</code>, <code>2017a</code>, <code>2017b</code>, and <code>2018b</code> along with OSX (10.10.5) <code>2017b</code> and <code>2018b</code>. Individual functions and <code>CIAtah</code> class should work on other MATLAB versions after <code>2015b</code>, but submit an issue if errors occur. Newer MATLAB version preferred.</li>
</ul>
<ul>
<li>
<p>This repository consists of code used in and released with</p>
<ul>
<li>G. Corder<em>, __B. Ahanonu</em>__, B. F. Grewe, D. Wang, M. J. Schnitzer, and G. Scherrer (2019). An amygdalar neural ensemble encoding the unpleasantness of painful experiences. <em>Science</em>, 363, 276-281. <a href="http://science.sciencemag.org/content/363/6424/276">http://science.sciencemag.org/content/363/6424/276</a>.</li>
</ul>
<ul>
<li>
<p>and similar code helped process imaging or behavioral data in:</p>
<ul>
<li>J.G. Parker<em>, J.D. Marshall</em>, <strong>B. Ahanonu</strong>, Y.W. Wu, T.H. Kim, B.F. Grewe, Y. Zhang, J.Z. Li, J.B. Ding, M.D. Ehlers, and M.J. Schnitzer (2018). Diametric neural ensemble dynamics in parkinsonian and dyskinetic states. <em>Nature</em>, 557, 177â€“182. <a href="https://doi.org/10.1038/s41586-018-0090-6">https://doi.org/10.1038/s41586-018-0090-6</a>.</li>
</ul>
<ul>
<li>Y. Li, A. Mathis, B.F. Grewe, J.A. Osterhout, B. Ahanonu, M.J. Schnitzer, V.N. Murthy, and C. Dulac (2017). Neuronal representation of social information in the medial amygdala of awake behaving mice. Cell, 171(5), 1176-1190. <a href="https://doi.org/10.1016/j.cell.2017.10.015">https://doi.org/10.1016/j.cell.2017.10.015</a>.</li>
</ul>
</li>
</ul>
</li>
</ul>
<ul>
<li>Code mostly developed while in <a href="http://pyramidal.stanford.edu/">Prof. Mark Schnitzer's lab</a> at Stanford University. Credit to those who helped in <a href="#acknowledgments">Acknowledgments</a>.</li>
</ul>
<ul>
<li>Please check the 'Wiki' for further instructions on specific processing/analysis steps and additional information of software used by this package.</li>
</ul>
<ul>
<li>When issues are encountered, first check the <code>Common issues and fixes</code> Wiki page to see if a solution is there. Else, submit a new issue.</li>
</ul>
<p><img alt="ciapkg_pipeline.png" src="../img/ciapkg_pipeline.png"/></p>
<!-- ![image](https://user-images.githubusercontent.com/5241605/61981834-ab532000-afaf-11e9-97c2-4b1d7d759a30.png) -->
<h4 id="repository-organization">Repository organization<a class="headerlink" href="#repository-organization" title="Permanent link">¶</a></h4>
<p>Below are a list of the top-level directories and what types of functions or files are within.</p>
<ul>
<li>__@ciatah - Contains <code>ciatah</code> class and associated methods for calcium imaging analysis.</li>
</ul>
<ul>
<li><strong><em>external</em>programs</strong>_ - External software packages (e.g. CNMF, CELLMax, and others) are stored here.</li>
</ul>
<ul>
<li><strong>+ciapkg</strong> - Package containing CIAtah functions. All functions will eventually be moved here to create a clean namespace.</li>
</ul>
<ul>
<li><strong>ciapkg</strong><p>- <strong><em>overloaded</em></strong> - Functions that overload core MATLAB functions to add functionality or fix display issues.</p>
<p>- <strong>behavior</strong> - Processing of behavior files (e.g. accelerometer data, Saleae files, etc.).</p>
<p>- <strong>classification</strong> - Classification of cells, e.g. manual classification of cell extraction outputs or cross-session grouping of cells.</p>
<p>- <strong>data</strong> - Location of test data.</p>
<p>- <strong>download</strong> - Functions that help download external code packages or data.</p>
<p>- <strong>file_exchange</strong> - Contains any outside code from MATLAB's File Exchange that are dependencies in repository functions.</p>
<p>- <strong>hdf5</strong> - Functions concerned with HDF5 input/output.</p>
<p>- <strong>image</strong> - Functions concerned with processing images (or [x y] matrices).</p>
<p>- <strong>inscopix</strong> - Functions concerned with Inscopix-specific data processing (e.g. using the ISX MATLAB API).</p>
<p>- <strong>io</strong> - Contains functions concerned with file or function input-output.</p>
<p>- <strong>motion_correction</strong> - Functions concerned with motion correction.</p>
<p>- <strong>movie_processing</strong> - Functions concerned with preprocessing calcium imaging videos, e.g. spatial filtering, downsampling, etc.</p>
<p>- <strong>neighbor</strong> - Detection and display of neighboring cell information.</p>
<p>- <strong><em>private</em></strong> - This directory contains various user settings, output pictures/data/logs from <code>CIAtah</code> modules, and more. This directory is NOT included in the MATLAB path, hence is good for storing related scripts without interfering with <code>CIAtah</code>.</p>
<p>- <strong>python</strong> - Python code, e.g. for processing Saleae data.</p>
<p>- <strong>serial</strong> - Code for saving and processing serial port data, e.g. Arduino streaming data.</p>
<p>- <strong>settings</strong> - Functions concerned with settings for other functions.</p>
<p>- <strong>signal_extraction</strong> - Functions related to cell extraction, e.g. running PCA-ICA.</p>
<p>- <strong>signal_processing</strong> - Functions to process cell activity traces.</p>
<p>- <strong>tracking</strong> - ImageJ and MATLAB functions to track animal location in behavior movies.</p>
<p>- <strong>unit_tests</strong> [optional] - Functions to validate specific repository functions.</p>
<p>- <strong>video</strong> - Functions to manipulate or process videos, e.g. making movie montages or adding dropped frames.</p>
<p>- <strong>view</strong> - Functions concerned with displaying data or information to the user, normally do not process data.</p>
</li>
</ul>
<h2 id="processing-data"><div class="subsection1"><em>â€”Processing dataâ€”</em></div><a class="headerlink" href="#processing-data" title="Permanent link">¶</a></h2>
<h2 id="processing-calcium-imaging-data">Processing calcium imaging data<a class="headerlink" href="#processing-calcium-imaging-data" title="Permanent link">¶</a></h2>
<p>The general pipeline for processing calcium imaging data is below. This repository includes code to do nearly every step.</p>
<!-- ![image](https://user-images.githubusercontent.com/5241605/61981834-ab532000-afaf-11e9-97c2-4b1d7d759a30.png) -->
<p><img alt="ciapkg_pipeline.png" src="../img/ciapkg_pipeline.png"/></p>
<h3 id="guides">Guides<a class="headerlink" href="#guides" title="Permanent link">¶</a></h3>
<p>Below are recordings for users who want to learn more about calcium imaging analysis.</p>
<h4 id="webinar">Webinar<a class="headerlink" href="#webinar" title="Permanent link">¶</a></h4>
<p>This webinar gives an overview of calcium imaging analysis (with a focus on CIAtah) along with tips for improving experiments and analysis: <a href="https://info.inscopix.com/inscopix-inspire-view-webinarbiafra-ahanonu-signal-in-the-noise-distinguishing-relevant-neural-activity-in-calcium-imaging">https://info.inscopix.com/inscopix-inspire-view-webinarbiafra-ahanonu-signal-in-the-noise-distinguishing-relevant-neural-activity-in-calcium-imaging</a>.</p>
<h4 id="workshop-tutorial">Workshop tutorial<a class="headerlink" href="#workshop-tutorial" title="Permanent link">¶</a></h4>
<p>This recording gives an overview of setting up and using CIAtah: <a href="https://www.youtube.com/watch?v=I6abW3uuJJw">https://www.youtube.com/watch?v=I6abW3uuJJw</a>.</p>
<h3 id="workflow">Workflow<a class="headerlink" href="#workflow" title="Permanent link">¶</a></h3>
<p>To start using the <code>CIAtah</code> software package, enter the following into the MATLAB command window.</p>
<div class="codehilite"><pre><span></span><code><span class="lineno" data-linenos=" 1 "></span><span class="c">% Loads all directories</span>
<span class="lineno" data-linenos=" 2 "></span>
<span class="lineno" data-linenos=" 3 "></span><span class="n">loadBatchFxns</span><span class="p">;</span>
<span class="lineno" data-linenos=" 4 "></span>
<span class="lineno" data-linenos=" 5 "></span>
<span class="lineno" data-linenos=" 6 "></span>
<span class="lineno" data-linenos=" 7 "></span><span class="c">% Loads the class into an object.</span>
<span class="lineno" data-linenos=" 8 "></span>
<span class="lineno" data-linenos=" 9 "></span><span class="n">obj</span> <span class="p">=</span> <span class="n">ciatah</span><span class="p">;</span>
<span class="lineno" data-linenos="10 "></span>
<span class="lineno" data-linenos="11 "></span>
<span class="lineno" data-linenos="12 "></span>
<span class="lineno" data-linenos="13 "></span><span class="c">% Open the class menu</span>
<span class="lineno" data-linenos="14 "></span>
<span class="lineno" data-linenos="15 "></span><span class="n">obj</span> <span class="s">%</span> <span class="s">then</span> <span class="s">hit</span> <span class="s">enter,</span> <span class="s">no</span> <span class="s">semicolon!</span>
<span class="lineno" data-linenos="16 "></span>
<span class="lineno" data-linenos="17 "></span><span class="c">% Alternatively</span>
<span class="lineno" data-linenos="18 "></span>
<span class="lineno" data-linenos="19 "></span><span class="n">obj</span><span class="p">.</span><span class="n">runPipeline</span><span class="p">;</span> <span class="c">% then hit enter!</span>
</code></pre></div>
<p>The general order of functions that users should run is ([optional] are those not critical for most datasets):</p>
<ul>
<li>
<p><code>loadDependencies</code></p>
<ul>
<li>If user is running CIAtah for the first time, this module has several options to download and load CNMF/CNMF-E code for cell extraction, Fiji for viewing/modifying videos (using Miji), and test data from a miniature microscope experiment.</li>
</ul>
</li>
</ul>
<ul>
<li>
<p><code>modelDownsampleRawMovies</code> [optional]</p>
<ul>
<li>If users have raw calcium imaging data that needs to be spatially downsampled, e.g. raw data from Inscopix nVista software.</li>
</ul>
</li>
</ul>
<ul>
<li>
<p><code>modelAddNewFolders</code></p>
<ul>
<li>Users should always use this method first, used to add folders to the current class object.</li>
</ul>
<ul>
<li>For example, if users ran <code>example_downloadTestData.m</code>, then add the folder <code>[githubRepoPath]\data\2014_04_01_p203_m19_check01_raw</code> where <code>githubRepoPath</code> is the absolute path to the current <code>CIAtah</code> repository.</li>
</ul>
</li>
</ul>
<ul>
<li>
<p><code>viewMovie</code></p>
<ul>
<li>Users should check that CIAtah loads their movies correctly and that Miji is working.</li>
</ul>
<ul>
<li>Users can view movies from disk, which allows checking of very large movies quickly.</li>
</ul>
<ul>
<li>Remember to check that <code>Imaging movie regexp:</code> (regular expression class uses to find user movies within given folders) setting matches name of movies currently in repository.</li>
</ul>
</li>
</ul>
<ul>
<li>
<p><code>viewMovieRegistrationTest</code> [optional]</p>
<ul>
<li>Users can check different spatial filtering and registration settings.</li>
</ul>
<ul>
<li><code>tregRunX</code> folders (where <code>X</code> is a number) contain details of each run setting. Delete from analysis folder if don't need outputs later.</li>
</ul>
<ul>
<li>Remember to adjust contrast in resulting montage movies since different filtering will change the absolute pixel values.</li>
</ul>
</li>
</ul>
<ul>
<li>
<p><code>modelPreprocessMovie</code></p>
<ul>
<li>Main processing method for CIAtah. Performs motion correction, spatial filtering, cropping, down-sampling, and relative fluorescence calculations. If using Inscopix nVista 1.0 or 2.0, also will correct for dropped frames.</li>
</ul>
</li>
</ul>
<ul>
<li>
<p><code>modelModifyMovies</code></p>
<ul>
<li>GUI that allows users to remove movie regions not relevant to cell extraction.</li>
</ul>
</li>
</ul>
<ul>
<li>
<p><code>modelExtractSignalsFromMovie</code></p>
<ul>
<li>Performs cell extraction on processed movies. Currently supports PCA-ICA, CNMF, CNMF-e, ROI, and EXTRACT. Support for CELLMax will be enabled in the public repository upon release.</li>
</ul>
</li>
</ul>
<ul>
<li>
<p><code>modelVarsFromFiles</code></p>
<ul>
<li>Run after <code>modelExtractSignalsFromMovie</code> to load cell image and trace information into the current class object.</li>
</ul>
</li>
</ul>
<ul>
<li>
<p><code>viewCellExtractionOnMovie</code> [optional]</p>
<ul>
<li>This function overlays the cell extraction outputs on snippets of the processed video, allowing users to check that cell extraction correctly identified all the cells.</li>
</ul>
</li>
</ul>
<ul>
<li>
<p><code>computeManualSortSignals</code></p>
<ul>
<li>A GUI to allow users to classify cells and not cells in cell extraction outputs.</li>
</ul>
</li>
</ul>
<ul>
<li>
<p><code>modelModifyRegionAnalysis</code> [optional]</p>
<ul>
<li>Users are able to select specific cells from cell extraction manual sorting to include in further analyses.</li>
</ul>
</li>
</ul>
<ul>
<li>
<p><code>computeMatchObjBtwnTrials</code></p>
<ul>
<li>Method to register cells across imaging sessions. Also includes visual check GUI in <code>viewMatchObjBtwnSessions</code> method.</li>
</ul>
<ul>
<li><strong>Note: it is heavily advised that throughout a particular animal's imaging sessions, that you keep the acquisition frame dimensions identical.</strong> This makes cross-session registration easier. Else you will have to crop all sessions for that animal to the same size ensuring that the area of interest is present in each.</li>
</ul>
<h2 id="detailed-sitename-processing-pipeline">Detailed CIAtah processing pipeline<a class="headerlink" href="#detailed-sitename-processing-pipeline" title="Permanent link">¶</a></h2>
</li>
</ul>
<p>The following detailed pipeline assumes you have started a CIAtah object using the below command:</p>
<div class="codehilite"><pre><span></span><code><span class="lineno" data-linenos="1 "></span><span class="n">obj</span> <span class="p">=</span> <span class="n">ciatah</span><span class="p">;</span>
</code></pre></div>
<h3 id="spatially-downsample-raw-movies-or-convert-to-hdf5-with-modeldownsamplerawmovies">Spatially downsample raw movies or convert to HDF5 with <code>modelDownsampleRawMovies</code><a class="headerlink" href="#spatially-downsample-raw-movies-or-convert-to-hdf5-with-modeldownsamplerawmovies" title="Permanent link">¶</a></h3>
<p>Users have the ability to spatially downsample raw movies, often necessary to denoise the data, save storage space, and improve runtimes of later processing steps. For most data, users can downsample 2 or 4 times in each spatial dimension while still retaining sufficient pixels per cell to facilitate cell-extraction.</p>
<p>To run, either select <code>modelDownsampleRawMovies</code> in the GUI menu or type the below command after initializing a CIAtah obj.</p>
<div class="codehilite"><pre><span></span><code><span class="lineno" data-linenos="1 "></span><span class="n">obj</span><span class="p">.</span><span class="n">modelDownsampleRawMovies</span><span class="p">;</span>
</code></pre></div>
<p>This will pop-up the following screen. Users can</p>
<ul>
<li>input several folders where ISXD files are by separating each folder path with a comma (<code>Folder(s) where raw HDF5s are located</code>),</li>
</ul>
<ul>
<li>specify a common root folder to save files to (<code>Folder to save downsampled HDF5s to:</code>),</li>
</ul>
<ul>
<li>and input a root directory that contains the sub-folders with the raw data (<code>Decompression source root folder(s)</code>).</li>
</ul>
<p>The function will automatically put each file in its corresponding folder, <strong>make sure folder names are unique</strong> (this should be done anyways for data analysis reasons).</p>
<p><img alt="image" src="https://user-images.githubusercontent.com/5241605/67715130-71b2fc00-f986-11e9-970e-9d1252c25db8.png"/></p>
<h4 id="converting-inscopix-isxd-files-to-hdf5">Converting Inscopix ISXD files to HDF5<a class="headerlink" href="#converting-inscopix-isxd-files-to-hdf5" title="Permanent link">¶</a></h4>
<p>To convert from Inscopix ISXD file format (output by nVista v3+ and nVoke) to HDF5 run <code>modelDownsampleRawMovies</code> without changing the regular expression or make sure it looks for <code>.*.isxd</code> or similar. Users will need the latest version of the <a href="https://www.inscopix.com/nVista#Data_Analysis">Inscopix Data Processing Software</a> as these functions take advantage of their API. If CIAtah cannot automatically find the API, it will ask the user to direct it to the <em>root</em> location of the Inscopix Data Processing Software (see below).</p>
<p><img alt="image" src="https://user-images.githubusercontent.com/5241605/67715327-df5f2800-f986-11e9-9f91-eeabe7688fed.png"/></p>
<h3 id="check-movie-registration-before-pre-processing-with-viewmovieregistrationtest">Check movie registration before pre-processing with <code>viewMovieRegistrationTest</code><a class="headerlink" href="#check-movie-registration-before-pre-processing-with-viewmovieregistrationtest" title="Permanent link">¶</a></h3>
<p>Users should spatially filter one-photon or other data with background noise (e.g. neuropil). To get a feel for how the different spatial filtering affects SNR/movie data before running the full processing pipeline, run <code>viewMovieRegistrationTest</code> module. Then select either <code>matlab divide by lowpass before registering</code> or <code>matlab bandpass before registering</code> then change <code>filterBeforeRegFreqLow</code> and <code>filterBeforeRegFreqHigh</code> settings, see below.</p>
<p>Within each folder will be a sub-folder called <code>preprocRunTest</code> inside of which is a series of sub-folders called <code>preprocRun##</code> that will contain a file called <code>settings.mat</code> that can be loaded into <code>modelPreprocessMovie</code> so the same settings that worked during the test can be used during the actual pre-processing run.</p>
<p><img alt="image" src="https://user-images.githubusercontent.com/5241605/52497447-f3f65880-2b8a-11e9-8875-c6b408e5c011.png"/></p>
<ul>
<li>
<p>You'll get an output like the below:</p>
<ul>
<li><strong>A</strong>: The top left is without any filtering while the other 3 are with different bandpass filtering options.</li>
</ul>
<ul>
<li><strong>B</strong>: Cell Î”F/F intensity profile from the raw movie. Obtain by selecting <code>Analyze-&gt;Plot profile</code> from Fiji menu after selecting a square segment running through a cell.</li>
</ul>
<ul>
<li><strong>C</strong>: Same cell Î”F/F intensity profile from the bottom/left movie (note the y-axis is the same as above). Obtained in same manner as <strong>B</strong>.</li>
</ul>
</li>
</ul>
<p><img alt="image" src="https://user-images.githubusercontent.com/5241605/59561146-695ab580-8fd1-11e9-892b-ce1f5fc7800e.png"/></p>
<h3 id="preprocessing-calcium-imaging-movies-with-modelpreprocessmovie">Preprocessing calcium imaging movies with <code>modelPreprocessMovie</code><a class="headerlink" href="#preprocessing-calcium-imaging-movies-with-modelpreprocessmovie" title="Permanent link">¶</a></h3>
<p>After users instantiate an object of the <code>CIAtah</code> class and enter a folder, they can start preprocessing of their calcium imaging data with <code>modelPreprocessMovie</code>.</p>
<ul>
<li>See below for a series of windows to get started, the options for motion correction, cropping unneeded regions, Î”_F/F_, and temporal downsampling were selected for use in the study associated with this repository.</li>
</ul>
<ul>
<li>If users have not specified the path to Miji, a window appears asking them to select the path to Miji's <code>scripts</code> folder.</li>
</ul>
<ul>
<li>If users are using the test dataset, it is recommended that they do not use temporal downsampling.</li>
</ul>
<ul>
<li>Vertical and horizontal stripes in movies (e.g. CMOS camera artifacts) can be removed via <code>stripeRemoval</code> step. Remember to select correct <code>stripOrientationRemove</code>,<code>stripSize</code>, and <code>stripfreqLowExclude</code> options in the preprocessing options menu.</li>
</ul>
<p><img alt="image" src="https://user-images.githubusercontent.com/5241605/49827992-93d86700-fd3f-11e8-9936-d7143bbec3db.png"/></p>
<p>Next the user is presented with a series of options for motion correction, image registration, and cropping.:</p>
<ul>
<li>The options highlighted in green are those that should be considered by users.</li>
</ul>
<ul>
<li>Users can over their mouse over each option to get tips on what they mean.</li>
</ul>
<ul>
<li>In particular, make sure that <code>inputDatasetName</code> is correct for HDF5 files and that <code>fileFilterRegexp</code> matches the form of the calcium imaging movie files to be analyzed.</li>
</ul>
<ul>
<li>After this, the user is asked to let the algorithm know how many frames of the movie to analyze (defaults to all frames).</li>
</ul>
<ul>
<li>Then the user is asked to select a region to use for motion correction. In general, it is best to select areas with high contrast and static markers such as blood vessels. Stay away from the edge of the movie or areas outside the brain (e.g. the edge of microendoscope GRIN lens in one-photon miniature microscope movies).</li>
</ul>
<p><img alt="image" src="https://user-images.githubusercontent.com/5241605/49828665-4ceb7100-fd41-11e8-9da6-9f5a510f1c13.png"/></p>
<h4 id="saveload-preprocessing-settings">Save/load preprocessing settings<a class="headerlink" href="#saveload-preprocessing-settings" title="Permanent link">¶</a></h4>
<p>Users can also enable saving and loading of previously selected pre-processing settings by changing the red option below.</p>
<p><img alt="image" src="https://user-images.githubusercontent.com/5241605/70419318-10b52400-1a1a-11ea-9b43-782ac6624042.png"/></p>
<p>Settings loaded from previous run (e.g. of <code>modelPreprocessMovie</code>) or file (e.g. from <code>viewMovieRegistrationTest</code> runs) are highlighted in orange. Settings that user has just changed are still highlighted in green.</p>
<p><img alt="image" src="https://user-images.githubusercontent.com/5241605/70418766-e6169b80-1a18-11ea-9713-f5a8301fe1c1.png"/></p>
<p>The algorithm will then run all the requested preprocessing steps and presented the user with the option of viewing a slice of the processed file. Users have now completed pre-processing.</p>
<p><img alt="image" src="https://user-images.githubusercontent.com/5241605/49829599-b53b5200-fd43-11e8-82eb-1e94fd7950e7.png"/></p>
<!-- ****************************************** -->
<h3 id="manual-movie-cropping-with-modelmodifymovies">Manual movie cropping with <code>modelModifyMovies</code><a class="headerlink" href="#manual-movie-cropping-with-modelmodifymovies" title="Permanent link">¶</a></h3>
<p>If users need to eliminate specific regions of their movie before running cell extraction, that option is provided. Users select a region using an ImageJ interface and select <code>done</code> when they want to move onto the next movie or start the cropping. Movies have <code>NaNs</code> or <code>0s</code> added in the cropped region rather than changing the dimensions of the movie.</p>
<p><img alt="image" src="https://user-images.githubusercontent.com/5241605/49829899-8f627d00-fd44-11e8-96fb-2e909b4f0d78.png"/></p>
<!-- ****************************************** -->
<h3 id="extracting-cells-with-modelextractsignalsfrommovie">Extracting cells with <code>modelExtractSignalsFromMovie</code><a class="headerlink" href="#extracting-cells-with-modelextractsignalsfrommovie" title="Permanent link">¶</a></h3>
<p>Users can run PCA-ICA, <a href="https://github.com/schnitzer-lab/EXTRACT-public" target="_blank">EXTRACT</a>, CNMF, CNMF-E, and ROI cell extraction by following the below set of option screens. Details on running the new Schnitzer lab cell-extraction methods (e.g. CELLMax) will be added here after they are released.</p>
<p>We normally estimate the number of PCs and ICs on the high end, manually sort to get an estimate of the number of cells, then run PCA-ICA again with IC 1.5-3x the number of cells and PCs 1-1.5x number of ICs.</p>
<p>To run CNMF or CNMF-E, run <code>loadDependencies</code> module (e.g. <code>obj.loadDependencies</code>) after CIAtah class is loaded. CVX (a CNMF dependency) will also be downloaded and <code>cvx_setup</code> run to automatically set it up.</p>
<p><img alt="image" src="https://user-images.githubusercontent.com/5241605/49830421-fa608380-fd45-11e8-8d9a-47a3d2921111.png"/></p>
<p>The resulting output (on <em>Figure 45+</em>) at the end should look something like:</p>
<p><img alt="image" src="https://user-images.githubusercontent.com/5241605/67053021-fe42fc00-f0f4-11e9-980c-88f463cb5043.png"/></p>
<!-- ![image](https://user-images.githubusercontent.com/5241605/51728907-c2c44700-2026-11e9-9614-1a57c3a60f5f.png) -->
<!-- ****************************************** -->
<h3 id="loading-cell-extraction-output-data-for-custom-scripts">Loading cell-extraction output data for custom scripts<a class="headerlink" href="#loading-cell-extraction-output-data-for-custom-scripts" title="Permanent link">¶</a></h3>
<p>Users can load outputs from cell extraction using the below command. This will then allow users to use the images and activity traces for downstream analysis as needed.</p>
<div class="codehilite"><pre><span></span><code><span class="lineno" data-linenos="1 "></span><span class="p">[</span><span class="n">inputImages</span><span class="p">,</span><span class="n">inputSignals</span><span class="p">,</span><span class="n">infoStruct</span><span class="p">,</span><span class="n">algorithmStr</span><span class="p">,</span><span class="n">inputSignals2</span><span class="p">]</span> <span class="p">=</span> <span class="n">ciapkg</span><span class="p">.</span><span class="n">io</span><span class="p">.</span><span class="n">loadSignalExtraction</span><span class="p">(</span><span class="s">'pathToFile'</span><span class="p">);</span>
</code></pre></div>
<p>Note, the outputs correspond to the below:</p>
<ul>
<li><code>inputImages</code> - 3D or 4D matrix containing cells and their spatial information, format: [x y nCells].</li>
</ul>
<ul>
<li><code>inputSignals</code> - 2D matrix containing activity traces in [nCells nFrames] format.</li>
</ul>
<ul>
<li><code>infoStruct</code> - contains information about the file, e.g. the 'description' property that can contain information about the algorithm.</li>
</ul>
<ul>
<li><code>algorithmStr</code> - String of the algorithm name.</li>
</ul>
<ul>
<li><code>inputSignals2</code> - same as inputSignals but for secondary traces an algorithm outputs.</li>
</ul>
<!-- ****************************************** -->
<h3 id="loading-cell-extraction-output-data-with-modelvarsfromfiles">Loading cell-extraction output data with <code>modelVarsFromFiles</code><a class="headerlink" href="#loading-cell-extraction-output-data-with-modelvarsfromfiles" title="Permanent link">¶</a></h3>
<p>In general, after running cell-extraction (<code>modelExtractSignalsFromMovie</code>) on a dataset, run the <code>modelVarsFromFiles</code> module. This allows <code>CIAtah</code> to load/pre-load information about that cell-extraction run.</p>
<p>If you had to restart MATLAB or are just loading CIAtah fresh but have previously run cell extraction, run this method before doing anything else with that cell-extraction data.</p>
<p>A menu will pop-up like below when <code>modelVarsFromFiles</code> is loaded, you can normally just leave the defaults as is.</p>
<p><img alt="image" src="https://user-images.githubusercontent.com/5241605/67052600-7f00f880-f0f3-11e9-9555-96fe32b4de6d.png"/></p>
<!-- ****************************************** -->
<h3 id="validating-cell-extraction-with-viewcellextractiononmovie">Validating cell extraction with <code>viewCellExtractionOnMovie</code><a class="headerlink" href="#validating-cell-extraction-with-viewcellextractiononmovie" title="Permanent link">¶</a></h3>
<p>After users have run cell extraction, they should check that cells are not being missed during the process. Running the method <code>viewCellExtractionOnMovie</code> will create a movie with outlines of cell extraction outputs overlaid on the movie.</p>
<p>Below is an example, with black outlines indicating location of cell extraction outputs. If users see active cells (red flashes) that are not outlined, that indicates either exclusion or other parameters should be altered in the previous <code>modelExtractSignalsFromMovie</code> cell extraction step.</p>
<p><img alt="2014_04_01_p203_m19_check01_raw_viewCellExtractionOnMovie_ezgif-4-57913bcfdf3f_2" src="https://user-images.githubusercontent.com/5241605/59560798-50033a80-8fcc-11e9-8228-f9a3d83ca591.gif"/></p>
<!-- ****************************************** -->
<h3 id="sorting-cell-extraction-outputs-with-computemanualsortsignals">Sorting cell extraction outputs with <code>computeManualSortSignals</code><a class="headerlink" href="#sorting-cell-extraction-outputs-with-computemanualsortsignals" title="Permanent link">¶</a></h3>
<p align="center">
<strong>CIAtah cell sorting GUI</strong>
</p>
<p align="center">
<a href="https://user-images.githubusercontent.com/5241605/100851700-64dec280-343a-11eb-974c-d6d29faf9eb2.gif">
<img align="center" alt="ciapkgMovie" src="https://user-images.githubusercontent.com/5241605/100851700-64dec280-343a-11eb-974c-d6d29faf9eb2.gif" style="margin-left:auto;margin-right:auto;display:block;margin-bottom: 1%;" title="ciapkgMovie" width="75%"/>
</a>
</p>
<p>Outputs from most common cell-extraction algorithms like PCA-ICA, CNMF, etc. contain signal sources that are not cells and thus must be manually removed from the output. The repository contains a GUI for sorting cells from not cells. GUI also contains a shortcut menu that users can access by right-clicking or selecting the top-left menu.</p>
<p>Below users can see a list of options that are given before running the code, those highlighted in green</p>
<p><img alt="image" src="https://user-images.githubusercontent.com/5241605/49845107-43322f80-fd7a-11e8-96b9-3f870d4b9009.png"/></p>
<h4 id="gui-usage-on-large-imaging-datasets">GUI usage on large imaging datasets<a class="headerlink" href="#gui-usage-on-large-imaging-datasets" title="Permanent link">¶</a></h4>
<ul>
<li>To manually sort on large movies that will not fit into RAM, select the below options (highlighted in green). This will load only chunks of the movie asynchronously into the GUI as you sort cell extraction outputs.</li>
</ul>
<p><img alt="image" src="https://user-images.githubusercontent.com/5241605/59215159-5d07d000-8b6d-11e9-8dd7-0d69d5fd38b6.png"/></p>
<h4 id="cell-sorting-from-the-command-line-with-signalsorter">Cell sorting from the command line with <code>signalSorter</code><a class="headerlink" href="#cell-sorting-from-the-command-line-with-signalsorter" title="Permanent link">¶</a></h4>
<p>Usage instructions below for <code>signalSorter</code>, e.g. if not using the <code>CIAtah</code> GUI.</p>
<p><strong>Main inputs</strong></p>
<ul>
<li><code>inputImages</code> - [x y N] matrix where N = number of images, x/y are dimensions.</li>
</ul>
<ul>
<li><code>inputSignals</code> - [N frames] <em>double</em> matrix where N = number of signals (traces).</li>
</ul>
<ul>
<li><code>inputMovie</code> - [x y frames] matrix</li>
</ul>
<p><strong>Main outputs</strong></p>
<ul>
<li><code>choices</code> - [N 1] vector of 1 = cell, 0 = not a cell</li>
</ul>
<ul>
<li><code>inputImagesSorted</code> - [x y N] filtered by <code>choices</code></li>
</ul>
<ul>
<li><code>inputSignalsSorted</code> - [N frames] filtered by <code>choice</code></li>
</ul>
<div class="codehilite"><pre><span></span><code><span class="lineno" data-linenos=" 1 "></span><span class="n">iopts</span><span class="p">.</span><span class="n">inputMovie</span> <span class="p">=</span> <span class="n">inputMovie</span><span class="p">;</span> <span class="c">% movie associated with traces</span>
<span class="lineno" data-linenos=" 2 "></span>
<span class="lineno" data-linenos=" 3 "></span><span class="n">iopts</span><span class="p">.</span><span class="n">valid</span> <span class="p">=</span> <span class="s">'neutralStart'</span><span class="p">;</span> <span class="c">% all choices start out gray or neutral to not bias user</span>
<span class="lineno" data-linenos=" 4 "></span>
<span class="lineno" data-linenos=" 5 "></span><span class="n">iopts</span><span class="p">.</span><span class="n">cropSizeLength</span> <span class="p">=</span> <span class="mi">20</span><span class="p">;</span> <span class="c">% region, in px, around a signal source for transient cut movies (subplot 2)</span>
<span class="lineno" data-linenos=" 6 "></span>
<span class="lineno" data-linenos=" 7 "></span><span class="n">iopts</span><span class="p">.</span><span class="n">cropSize</span> <span class="p">=</span> <span class="mi">20</span><span class="p">;</span> <span class="c">% see above</span>
<span class="lineno" data-linenos=" 8 "></span>
<span class="lineno" data-linenos=" 9 "></span><span class="n">iopts</span><span class="p">.</span><span class="n">medianFilterTrace</span> <span class="p">=</span> <span class="mi">0</span><span class="p">;</span> <span class="c">% whether to subtract a rolling median from trace</span>
<span class="lineno" data-linenos="10 "></span>
<span class="lineno" data-linenos="11 "></span><span class="n">iopts</span><span class="p">.</span><span class="n">subtractMean</span> <span class="p">=</span> <span class="mi">0</span><span class="p">;</span> <span class="c">% whether to subtract the trace mean</span>
<span class="lineno" data-linenos="12 "></span>
<span class="lineno" data-linenos="13 "></span><span class="n">iopts</span><span class="p">.</span><span class="n">movieMin</span> <span class="p">=</span> <span class="o">-</span><span class="mf">0.01</span><span class="p">;</span> <span class="c">% helps set contrast for subplot 2, preset movie min here or it is calculated</span>
<span class="lineno" data-linenos="14 "></span>
<span class="lineno" data-linenos="15 "></span><span class="n">iopts</span><span class="p">.</span><span class="n">movieMax</span> <span class="p">=</span> <span class="mf">0.05</span><span class="p">;</span> <span class="c">% helps set contrast for subplot 2, preset movie max here or it is calculated</span>
<span class="lineno" data-linenos="16 "></span>
<span class="lineno" data-linenos="17 "></span><span class="n">iopts</span><span class="p">.</span><span class="n">backgroundGood</span> <span class="p">=</span> <span class="p">[</span><span class="mi">208</span><span class="p">,</span><span class="mi">229</span><span class="p">,</span><span class="mi">180</span><span class="p">]</span><span class="o">/</span><span class="mi">255</span><span class="p">;</span>
<span class="lineno" data-linenos="18 "></span>
<span class="lineno" data-linenos="19 "></span><span class="n">iopts</span><span class="p">.</span><span class="n">backgroundBad</span> <span class="p">=</span> <span class="p">[</span><span class="mi">244</span><span class="p">,</span><span class="mi">166</span><span class="p">,</span><span class="mi">166</span><span class="p">]</span><span class="o">/</span><span class="mi">255</span><span class="p">;</span>
<span class="lineno" data-linenos="20 "></span>
<span class="lineno" data-linenos="21 "></span><span class="n">iopts</span><span class="p">.</span><span class="n">backgroundNeutral</span> <span class="p">=</span> <span class="nb">repmat</span><span class="p">(</span><span class="mi">230</span><span class="p">,[</span><span class="mi">1</span> <span class="mi">3</span><span class="p">])</span><span class="o">/</span><span class="mi">255</span><span class="p">;</span>
<span class="lineno" data-linenos="22 "></span>
<span class="lineno" data-linenos="23 "></span><span class="p">[</span><span class="n">inputImagesSorted</span><span class="p">,</span> <span class="n">inputSignalsSorted</span><span class="p">,</span> <span class="n">choices</span><span class="p">]</span> <span class="p">=</span> <span class="n">signalSorter</span><span class="p">(</span><span class="n">inputImages</span><span class="p">,</span> <span class="n">inputSignals</span><span class="p">,</span> <span class="s">'options'</span><span class="p">,</span><span class="n">iopts</span><span class="p">);</span>
</code></pre></div>
<p>Examples of the interface on two different datasets:</p>
<h5 id="bla-one-photon-imaging-data-signal-sorting-gui">BLA one-photon imaging data signal sorting GUI<a class="headerlink" href="#bla-one-photon-imaging-data-signal-sorting-gui" title="Permanent link">¶</a></h5>
<p><img alt="out-1" src="https://user-images.githubusercontent.com/5241605/34796712-3868cb3a-f60b-11e7-830e-8eec5b2c76d7.gif"/></p>
<h5 id="mpfc-one-photon-imaging-data-signal-sorting-gui-from-example_downloadtestdatam">mPFC one-photon imaging data signal sorting GUI (from <code>example_downloadTestData.m</code>)<a class="headerlink" href="#mpfc-one-photon-imaging-data-signal-sorting-gui-from-example_downloadtestdatam" title="Permanent link">¶</a></h5>
<p><img alt="image" src="https://user-images.githubusercontent.com/5241605/46322488-04c00d80-c59e-11e8-9e8a-18b3b8e4567d.png"/></p>
<h5 id="context-menu">Context menu<a class="headerlink" href="#context-menu" title="Permanent link">¶</a></h5>
<p><a href="https://user-images.githubusercontent.com/5241605/95838435-9ec30080-0cf6-11eb-981d-fc8b5d46de7b.png" target="_blank"><img alt="drawing" height="auto" src="https://user-images.githubusercontent.com/5241605/95838435-9ec30080-0cf6-11eb-981d-fc8b5d46de7b.png" width="900"/></a></p>
<!-- ****************************************** -->
<h3 id="removing-cells-not-within-brain-region-with-modelmodifyregionanalysis">Removing cells not within brain region with <code>modelModifyRegionAnalysis</code><a class="headerlink" href="#removing-cells-not-within-brain-region-with-modelmodifyregionanalysis" title="Permanent link">¶</a></h3>
<p>If the imaging field-of-view includes cells from other brain regions, they can be removed using <code>modelModifyRegionAnalysis</code></p>
<p><img alt="image" src="https://user-images.githubusercontent.com/5241605/49834696-e9b60a80-fd51-11e8-90bb-9854b7ccaeb8.png"/></p>
<!-- ****************************************** -->
<h3 id="cross-session-cell-alignment-with-computematchobjbtwntrials">Cross-session cell alignment with <code>computeMatchObjBtwnTrials</code><a class="headerlink" href="#cross-session-cell-alignment-with-computematchobjbtwntrials" title="Permanent link">¶</a></h3>
<p>This step allows users to align cells across imaging sessions (e.g. those taken on different days). See the <code>Cross session cell alignment</code> wiki page for more details and notes on cross-session alignment.</p>
<ul>
<li>Users run <code>computeMatchObjBtwnTrials</code> to do cross-day alignment (first row in pictures below).</li>
</ul>
<ul>
<li>Users then run <code>viewMatchObjBtwnSessions</code> to get a sense for how well the alignment ran.</li>
</ul>
<ul>
<li><code>computeCellDistances</code> and <code>computeCrossDayDistancesAlignment</code> allow users to compute the within session pairwise Euclidean centroid distance for all cells and the cross-session pairwise distance for all global matched cells, respectively.</li>
</ul>
<p><img alt="image" src="https://user-images.githubusercontent.com/5241605/49835713-eec88900-fd54-11e8-8d24-f7c426802297.png"/></p>
<p>Users can then get the matrix that gives the session IDs</p>
<div class="codehilite"><pre><span></span><code><span class="lineno" data-linenos="1 "></span><span class="c">% Global IDs is a matrix of [globalID sessionID]</span>
<span class="lineno" data-linenos="2 "></span>
<span class="lineno" data-linenos="3 "></span><span class="c">% Each (globalID, sessionID) pair gives the within session ID for that particular global ID</span>
<span class="lineno" data-linenos="4 "></span>
<span class="lineno" data-linenos="5 "></span><span class="n">globalIDs</span> <span class="p">=</span> <span class="n">alignmentStruct</span><span class="p">.</span><span class="n">globalIDs</span><span class="p">;</span>
</code></pre></div>
<h4 id="view-cross-session-cell-alignment-with-viewmatchobjbtwnsessions">View cross-session cell alignment with <code>viewMatchObjBtwnSessions</code><a class="headerlink" href="#view-cross-session-cell-alignment-with-viewmatchobjbtwnsessions" title="Permanent link">¶</a></h4>
<p>To evaluate how well cross-session alignment works, <code>computeMatchObjBtwnTrials</code> will automatically run <code>viewMatchObjBtwnSessions</code> at the end, but users can also run it separately after alignment. The left are raw dorsal striatum cell maps from a single animal. The right shows after cross-session alignment; color is used to indicate a global ID cell (e.g. the same cell matched across multiple days). Thus, same color cell = same cell across sessions.</p>
<p><a href="https://cloud.githubusercontent.com/assets/5241605/25643108/9bcfccda-2f52-11e7-8514-31968752bd95.gif" target="_blank"><img alt="2017_05_02_p545_m121_p215_raw" height="400" src="https://cloud.githubusercontent.com/assets/5241605/25643108/9bcfccda-2f52-11e7-8514-31968752bd95.gif" width="auto"/></a></p>
<p><a href="https://cloud.githubusercontent.com/assets/5241605/25643473/dd7b11ce-2f54-11e7-8d84-eb98c5ef801c.gif" target="_blank"><img alt="2017_05_02_p545_m121_p215_corrected_biafraalgorithm2" height="400" src="https://cloud.githubusercontent.com/assets/5241605/25643473/dd7b11ce-2f54-11e7-8d84-eb98c5ef801c.gif" width="auto"/></a></p>
<h4 id="save-cross-session-cell-alignment-with-modelsavematchobjbtwntrials">Save cross-session cell alignment with <code>modelSaveMatchObjBtwnTrials</code><a class="headerlink" href="#save-cross-session-cell-alignment-with-modelsavematchobjbtwntrials" title="Permanent link">¶</a></h4>
<p>Users can save out the alignment structure by running <code>modelSaveMatchObjBtwnTrials</code>. This will allow users to select a folder where <code>CIAtah</code> will save a MAT-file with the alignment structure information for each animal.</p>
<h2 id="imagejmatlab-based-mouse-location-tracking">ImageJ+MATLAB based mouse location tracking<a class="headerlink" href="#imagejmatlab-based-mouse-location-tracking" title="Permanent link">¶</a></h2>
<p>Functions needed (have entire <code>CIAtah</code> loaded anyways):</p>
<ul>
<li><code>mm_tracking.ijm</code> is the tracking function for use in ImageJ, place in</li>
</ul>
<p><code>plugins</code> folder. If already had <code>CIAtah</code> download Fiji, place in the <code>_external_programs/[Fiji directory]/Fiji.app/plugins</code> folder.</p>
<ul>
<li><code>removeIncorrectObjs.m</code> is a function to clean-up the ImageJ output.</li>
</ul>
<ul>
<li><code>createTrackingOverlayVideo</code> is a way to check the output from the</li>
</ul>
<p>tracking by overlaying mouse tracker onto the video.</p>
<h3 id="instructions-for-imagej-and-matlab">Instructions for ImageJ and Matlab<a class="headerlink" href="#instructions-for-imagej-and-matlab" title="Permanent link">¶</a></h3>
<p>Example screen after running <code>mm_tracking</code> within ImageJ, click to expand.</p>
<p><a href="https://user-images.githubusercontent.com/5241605/34800762-1fa35480-f61a-11e7-91fb-65a260436725.png" target="_blank"><img alt="image" height="auto" src="https://user-images.githubusercontent.com/5241605/34800762-1fa35480-f61a-11e7-91fb-65a260436725.png" width="600"/></a></p>
<!-- <a href="https://user-images.githubusercontent.com/5241605/34800762-1fa35480-f61a-11e7-91fb-65a260436725.png" target="_blank">![image](https://user-images.githubusercontent.com/5241605/34800762-1fa35480-f61a-11e7-91fb-65a260436725.png)</a> -->
<p>After the above screen, there will be multiple other screens culminating in one where a threshold is chosen that is used to remove non-animal pixels from analysis. The threshold matters quite a bit and the script ignores anything that isn't red (i.e. larger than threshold) OR not within the range specified by the parameters below.</p>
<p><img alt="image" src="https://user-images.githubusercontent.com/5241605/71494852-8c2f1780-2807-11ea-93b7-8c51e21116b3.png"/></p>
<p>The script opens the AVI as a virtual stack and asks for the threshold is so that I can quickly scan through the entire movie to make sure the set threshold works even with slight/major changes in illumination, e.g. the below threshold will work across many frames</p>
<p><img alt="image" src="https://user-images.githubusercontent.com/5241605/71494077-7f0f2a00-2801-11ea-9144-f1fc6b04c27a.png"/></p>
<p>If the threshold is set to low, certain frames will not have the animal detected, e.g. if the lighting changes.</p>
<p><img alt="image" src="https://user-images.githubusercontent.com/5241605/71494720-7e2cc700-2806-11ea-976e-3e9b70b00861.png"/></p>
<p>Once ImageJ is finished, within Matlab run the following code (cleans up the ImageJ tracking by removing small objects and adding NaNs for missing frames along with making a movie to check output). Modify to point toward paths specific for your data.</p>
<div class="codehilite"><pre><span></span><code><span class="lineno" data-linenos=" 1 "></span><span class="c">% CSV file from imageJ and AVI movie path used in ImageJ</span>
<span class="lineno" data-linenos=" 2 "></span>
<span class="lineno" data-linenos=" 3 "></span><span class="n">moviePath</span> <span class="p">=</span> <span class="s">'PATH_TO_AVI_USED_IN_IMAEJ'</span><span class="p">;</span>
<span class="lineno" data-linenos=" 4 "></span>
<span class="lineno" data-linenos=" 5 "></span><span class="n">csvPath</span> <span class="p">=</span> <span class="s">'PATH_TO_CSV_OUTPUT_BY_IMAGEJ'</span><span class="p">;</span>
<span class="lineno" data-linenos=" 6 "></span>
<span class="lineno" data-linenos=" 7 "></span><span class="c">% clean up tracking</span>
<span class="lineno" data-linenos=" 8 "></span>
<span class="lineno" data-linenos=" 9 "></span><span class="p">[</span><span class="n">trackingTableFilteredCell</span><span class="p">]</span> <span class="p">=</span> <span class="n">removeIncorrectObjs</span><span class="p">(</span><span class="n">csvPath</span><span class="p">,</span><span class="s">'inputMovie'</span><span class="p">,{</span><span class="n">moviePath</span><span class="p">});</span>
<span class="lineno" data-linenos="10 "></span>
<span class="lineno" data-linenos="11 "></span><span class="c">% make tracking video</span>
<span class="lineno" data-linenos="12 "></span>
<span class="lineno" data-linenos="13 "></span><span class="c">% frames to use as example check</span>
<span class="lineno" data-linenos="14 "></span>
<span class="lineno" data-linenos="15 "></span><span class="n">nFrames</span><span class="p">=</span><span class="mi">1500</span><span class="p">:</span><span class="mi">2500</span><span class="p">;</span>
<span class="lineno" data-linenos="16 "></span>
<span class="lineno" data-linenos="17 "></span><span class="n">inputMovie</span> <span class="p">=</span> <span class="n">loadMovieList</span><span class="p">(</span><span class="n">moviePath</span><span class="p">,</span><span class="s">'frameList'</span><span class="p">,</span><span class="n">nFrames</span><span class="p">);</span>
<span class="lineno" data-linenos="18 "></span>
<span class="lineno" data-linenos="19 "></span><span class="p">[</span><span class="n">inputTrackingVideo</span><span class="p">]</span> <span class="p">=</span> <span class="n">createTrackingOverlayVideo</span><span class="p">(</span><span class="n">inputMovie</span><span class="p">,</span><span class="n">movmean</span><span class="p">(</span><span class="n">trackingTableFilteredCell</span><span class="p">.</span><span class="n">XM</span><span class="p">(</span><span class="n">nFrames</span><span class="p">),</span><span class="mi">5</span><span class="p">),</span><span class="n">movmean</span><span class="p">(</span><span class="n">trackingTableFilteredCell</span><span class="p">.</span><span class="n">YM</span><span class="p">(</span><span class="n">nFrames</span><span class="p">),</span><span class="mi">5</span><span class="p">));</span>
<span class="lineno" data-linenos="20 "></span>
<span class="lineno" data-linenos="21 "></span><span class="n">playMovie</span><span class="p">(</span><span class="n">inputTrackingVideo</span><span class="p">);</span>
</code></pre></div>
<h4 id="example-output-from-2017_09_11_p540_m381_openfield01_091112017">Example output from 2017_09_11_p540_m381_openfield01_091112017<a class="headerlink" href="#example-output-from-2017_09_11_p540_m381_openfield01_091112017" title="Permanent link">¶</a></h4>
<!-- ![image](https://user-images.githubusercontent.com/5241605/34800547-2a10a3b0-f619-11e7-9c88-88750c9875cd.png) -->
<p><img alt="image" height="auto" src="https://user-images.githubusercontent.com/5241605/34800547-2a10a3b0-f619-11e7-9c88-88750c9875cd.png" width="400"/></p>
<p>Using <code>createTrackingOverlayVideo</code> to verify tracking matches animal position on a per frame basis.</p>
<!-- ![image](https://user-images.githubusercontent.com/5241605/34800536-19eefcf2-f619-11e7-954f-dba59f4fd427.png) -->
<p><img alt="image" height="auto" src="https://user-images.githubusercontent.com/5241605/34800536-19eefcf2-f619-11e7-954f-dba59f4fd427.png" width="400"/></p>
<h2 id="api"><div class="subsection1"><em>â€”APIâ€”</em></div><a class="headerlink" href="#api" title="Permanent link">¶</a></h2>
<h2 id="example-sitename-pipeline-via-the-command-line">Example <code>CIAtah</code> pipeline via the command line.<a class="headerlink" href="#example-sitename-pipeline-via-the-command-line" title="Permanent link">¶</a></h2>
<p>Below is an example <code>CIAtah</code> pipeline using the command line for those that do not want to use the class or want to create their own custom batch analyses. It assumes you have already run <code>example_downloadTestData</code> to download the example test data and have MATLAB path set to the <code>CIAtah</code> root directory.</p>
<p>Can also access the pipeline by typing <code>edit ciapkg.demo.cmdLinePipeline</code> into the MATLAB command window or run by typing in <code>ciapkg.demo.cmdLinePipeline;</code>.</p>
<h3 id="setup_1">Setup<a class="headerlink" href="#setup_1" title="Permanent link">¶</a></h3>
<div class="codehilite"><pre><span></span><code><span class="lineno" data-linenos=" 1 "></span><span class="c">% Running CIAtah from MATLAB command line/window</span>
<span class="lineno" data-linenos=" 2 "></span>
<span class="lineno" data-linenos=" 3 "></span>
<span class="lineno" data-linenos=" 4 "></span>
<span class="lineno" data-linenos=" 5 "></span><span class="n">guiEnabled</span> <span class="p">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="lineno" data-linenos=" 6 "></span>
<span class="lineno" data-linenos=" 7 "></span><span class="n">saveAnalysis</span> <span class="p">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="lineno" data-linenos=" 8 "></span>
<span class="lineno" data-linenos=" 9 "></span><span class="n">inputDatasetName</span> <span class="p">=</span> <span class="s">'/1'</span><span class="p">;</span>
<span class="lineno" data-linenos="10 "></span>
<span class="lineno" data-linenos="11 "></span><span class="n">rawFileRegexp</span> <span class="p">=</span> <span class="s">'concat'</span><span class="p">;</span>
<span class="lineno" data-linenos="12 "></span>
<span class="lineno" data-linenos="13 "></span>
<span class="lineno" data-linenos="14 "></span>
<span class="lineno" data-linenos="15 "></span><span class="c">% Setup folder paths</span>
<span class="lineno" data-linenos="16 "></span>
<span class="lineno" data-linenos="17 "></span><span class="n">analysisFolderPath</span> <span class="p">=</span> <span class="p">[</span><span class="n">ciapkg</span><span class="p">.</span><span class="n">getDir</span><span class="p">()</span> <span class="n">filesep</span> <span class="s">'data'</span> <span class="n">filesep</span> <span class="s">'2014_04_01_p203_m19_check01'</span><span class="p">];</span>
<span class="lineno" data-linenos="18 "></span>
<span class="lineno" data-linenos="19 "></span><span class="p">[</span><span class="o">~</span><span class="p">,</span><span class="n">folderName</span><span class="p">,</span><span class="o">~</span><span class="p">]</span> <span class="p">=</span> <span class="n">fileparts</span><span class="p">(</span><span class="n">analysisFolderPath</span><span class="p">);</span>
<span class="lineno" data-linenos="20 "></span>
<span class="lineno" data-linenos="21 "></span><span class="c">% Setup NWB folder paths</span>
<span class="lineno" data-linenos="22 "></span>
<span class="lineno" data-linenos="23 "></span><span class="n">nwbFilePath</span> <span class="p">=</span> <span class="p">[</span><span class="n">analysisFolderPath</span> <span class="n">filesep</span> <span class="s">'nwbFiles'</span> <span class="n">filesep</span> <span class="n">folderName</span><span class="p">];</span>
<span class="lineno" data-linenos="24 "></span>
<span class="lineno" data-linenos="25 "></span><span class="n">nwbFileFolderPath</span> <span class="p">=</span> <span class="p">[</span><span class="n">analysisFolderPath</span> <span class="n">filesep</span> <span class="s">'nwbFiles'</span><span class="p">];</span>
<span class="lineno" data-linenos="26 "></span>
<span class="lineno" data-linenos="27 "></span>
<span class="lineno" data-linenos="28 "></span>
<span class="lineno" data-linenos="29 "></span><span class="c">% Load CIAtah functions</span>
<span class="lineno" data-linenos="30 "></span>
<span class="lineno" data-linenos="31 "></span><span class="n">loadBatchFxns</span><span class="p">();</span>
</code></pre></div>
<div class="codehilite"><pre><span></span><code><span class="lineno" data-linenos="1 "></span><span class="c">%% Download test data, only a single session</span>
<span class="lineno" data-linenos="2 "></span>
<span class="lineno" data-linenos="3 "></span><span class="n">ciapkg</span><span class="p">.</span><span class="n">api</span><span class="p">.</span><span class="n">example_downloadTestData</span><span class="p">(</span><span class="s">'downloadExtraFiles'</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span>
</code></pre></div>
<div class="codehilite"><pre><span></span><code><span class="lineno" data-linenos="1 "></span><span class="c">%% Load movie to analyze</span>
<span class="lineno" data-linenos="2 "></span>
<span class="lineno" data-linenos="3 "></span><span class="n">inputMoviePath</span> <span class="p">=</span> <span class="n">ciapkg</span><span class="p">.</span><span class="n">api</span><span class="p">.</span><span class="n">getFileList</span><span class="p">(</span><span class="n">analysisFolderPath</span><span class="p">,</span><span class="n">rawFileRegexp</span><span class="p">,</span><span class="s">'sortMethod'</span><span class="p">,</span><span class="s">'natural'</span><span class="p">);</span>
<span class="lineno" data-linenos="4 "></span>
<span class="lineno" data-linenos="5 "></span><span class="c">% inputMoviePath = [analysisFolderPath filesep 'concat_recording_20140401_180333.h5'];</span>
<span class="lineno" data-linenos="6 "></span>
<span class="lineno" data-linenos="7 "></span><span class="n">inputMovie</span> <span class="p">=</span> <span class="n">ciapkg</span><span class="p">.</span><span class="n">api</span><span class="p">.</span><span class="n">loadMovieList</span><span class="p">(</span><span class="n">inputMoviePath</span><span class="p">,</span><span class="s">'inputDatasetName'</span><span class="p">,</span><span class="n">inputDatasetName</span><span class="p">);</span>
</code></pre></div>
<h3 id="visualize-movie">Visualize movie<a class="headerlink" href="#visualize-movie" title="Permanent link">¶</a></h3>
<div class="codehilite"><pre><span></span><code><span class="lineno" data-linenos="1 "></span><span class="c">%% Visualize slice of the movie</span>
<span class="lineno" data-linenos="2 "></span>
<span class="lineno" data-linenos="3 "></span><span class="n">ciapkg</span><span class="p">.</span><span class="n">api</span><span class="p">.</span><span class="n">playMovie</span><span class="p">(</span><span class="n">inputMovie</span><span class="p">(:,:,</span><span class="mi">1</span><span class="p">:</span><span class="mi">500</span><span class="p">),</span><span class="s">'extraTitleText'</span><span class="p">,</span><span class="s">'Raw movie'</span><span class="p">);</span>
<span class="lineno" data-linenos="4 "></span>
<span class="lineno" data-linenos="5 "></span><span class="c">% Alternatively, visualize by entering the file path</span>
<span class="lineno" data-linenos="6 "></span>
<span class="lineno" data-linenos="7 "></span><span class="n">ciapkg</span><span class="p">.</span><span class="n">api</span><span class="p">.</span><span class="n">playMovie</span><span class="p">(</span><span class="n">inputMoviePath</span><span class="p">,</span><span class="s">'extraTitleText'</span><span class="p">,</span><span class="s">'Raw movie directly from file'</span><span class="p">);</span>
</code></pre></div>
<h3 id="downsample-movie">Downsample movie<a class="headerlink" href="#downsample-movie" title="Permanent link">¶</a></h3>
<div class="codehilite"><pre><span></span><code><span class="lineno" data-linenos=" 1 "></span><span class="c">%% Downsample input movie if need to</span>
<span class="lineno" data-linenos=" 2 "></span>
<span class="lineno" data-linenos=" 3 "></span><span class="n">inputMovieD</span> <span class="p">=</span> <span class="n">ciapkg</span><span class="p">.</span><span class="n">api</span><span class="p">.</span><span class="n">downsampleMovie</span><span class="p">(</span><span class="n">inputMovie</span><span class="p">,</span><span class="s">'downsampleDimension'</span><span class="p">,</span><span class="s">'space'</span><span class="p">,</span><span class="s">'downsampleFactor'</span><span class="p">,</span><span class="mi">4</span><span class="p">);</span>
<span class="lineno" data-linenos=" 4 "></span>
<span class="lineno" data-linenos=" 5 "></span><span class="n">ciapkg</span><span class="p">.</span><span class="n">api</span><span class="p">.</span><span class="n">playMovie</span><span class="p">(</span><span class="n">inputMovie</span><span class="p">,</span><span class="s">'extraMovie'</span><span class="p">,</span><span class="n">inputMovieD</span><span class="p">,</span><span class="s">'extraTitleText'</span><span class="p">,</span><span class="s">'Raw movie vs. down-sampled movie'</span><span class="p">);</span>
<span class="lineno" data-linenos=" 6 "></span>
<span class="lineno" data-linenos=" 7 "></span>
<span class="lineno" data-linenos=" 8 "></span>
<span class="lineno" data-linenos=" 9 "></span><span class="c">% Alternatively, if you have Inscopix ISXD files, downsample by reading segments from disk using.</span>
<span class="lineno" data-linenos="10 "></span>
<span class="lineno" data-linenos="11 "></span><span class="n">moviePath</span> <span class="p">=</span> <span class="s">'PATH_TO_ISXD'</span><span class="p">;</span>
<span class="lineno" data-linenos="12 "></span>
<span class="lineno" data-linenos="13 "></span><span class="n">opts</span><span class="p">.</span><span class="n">maxChunkSize</span> <span class="p">=</span> <span class="mi">5000</span><span class="p">;</span> <span class="c">% Max chunk size in Mb to load into RAM.</span>
<span class="lineno" data-linenos="14 "></span>
<span class="lineno" data-linenos="15 "></span><span class="n">opts</span><span class="p">.</span><span class="n">downsampleFactor</span> <span class="p">=</span> <span class="mi">4</span><span class="p">;</span> <span class="c">% How much to downsample original movie, set to 1 for no downsampling.</span>
<span class="lineno" data-linenos="16 "></span>
<span class="lineno" data-linenos="17 "></span><span class="n">ciapkg</span><span class="p">.</span><span class="n">api</span><span class="p">.</span><span class="n">convertInscopixIsxdToHdf5</span><span class="p">(</span><span class="n">moviePath</span><span class="p">,</span><span class="s">'options'</span><span class="p">,</span><span class="n">opts</span><span class="p">);</span>
</code></pre></div>
<h3 id="remove-stripe-artifacts-eg-from-camera-from-movie">Remove stripe artifacts (e.g. from camera) from movie<a class="headerlink" href="#remove-stripe-artifacts-eg-from-camera-from-movie" title="Permanent link">¶</a></h3>
<div class="codehilite"><pre><span></span><code><span class="lineno" data-linenos=" 1 "></span><span class="c">%% Remove stripes from movie if needed</span>
<span class="lineno" data-linenos=" 2 "></span>
<span class="lineno" data-linenos=" 3 "></span><span class="c">% Show full filter sequence for one frame</span>
<span class="lineno" data-linenos=" 4 "></span>
<span class="lineno" data-linenos=" 5 "></span><span class="n">sopts</span><span class="p">.</span><span class="n">stripOrientation</span> <span class="p">=</span> <span class="s">'both'</span><span class="p">;</span>
<span class="lineno" data-linenos=" 6 "></span>
<span class="lineno" data-linenos=" 7 "></span><span class="n">sopts</span><span class="p">.</span><span class="n">meanFilterSize</span> <span class="p">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="lineno" data-linenos=" 8 "></span>
<span class="lineno" data-linenos=" 9 "></span><span class="n">sopts</span><span class="p">.</span><span class="n">freqLowExclude</span> <span class="p">=</span> <span class="mi">10</span><span class="p">;</span>
<span class="lineno" data-linenos="10 "></span>
<span class="lineno" data-linenos="11 "></span><span class="n">sopts</span><span class="p">.</span><span class="n">bandpassType</span> <span class="p">=</span> <span class="s">'highpass'</span><span class="p">;</span>
<span class="lineno" data-linenos="12 "></span>
<span class="lineno" data-linenos="13 "></span><span class="n">ciapkg</span><span class="p">.</span><span class="n">api</span><span class="p">.</span><span class="n">removeStripsFromMovie</span><span class="p">(</span><span class="n">inputMovie</span><span class="p">(:,:,</span><span class="mi">1</span><span class="p">),</span><span class="s">'options'</span><span class="p">,</span><span class="n">sopts</span><span class="p">,</span><span class="s">'showImages'</span><span class="p">,</span><span class="mi">1</span><span class="p">);</span>
<span class="lineno" data-linenos="14 "></span>
<span class="lineno" data-linenos="15 "></span><span class="c">% Run on the entire movie</span>
<span class="lineno" data-linenos="16 "></span>
<span class="lineno" data-linenos="17 "></span><span class="n">ciapkg</span><span class="p">.</span><span class="n">api</span><span class="p">.</span><span class="n">removeStripsFromMovie</span><span class="p">(</span><span class="n">inputMovie</span><span class="p">,</span><span class="s">'options'</span><span class="p">,</span><span class="n">sopts</span><span class="p">);</span>
</code></pre></div>
<h3 id="detrend-movie-if-needed-default-linear-trend-eg-to-compensate-for-bleaching-over-time">Detrend movie if needed (default linear trend), e.g. to compensate for bleaching over time.<a class="headerlink" href="#detrend-movie-if-needed-default-linear-trend-eg-to-compensate-for-bleaching-over-time" title="Permanent link">¶</a></h3>
<div class="codehilite"><pre><span></span><code><span class="lineno" data-linenos="1 "></span><span class="c">%% Detrend movie</span>
<span class="lineno" data-linenos="2 "></span>
<span class="lineno" data-linenos="3 "></span><span class="n">inputMovie</span> <span class="p">=</span> <span class="n">ciapkg</span><span class="p">.</span><span class="n">api</span><span class="p">.</span><span class="n">normalizeMovie</span><span class="p">(</span><span class="n">inputMovie</span><span class="p">,</span><span class="s">'normalizationType'</span><span class="p">,</span><span class="s">'detrend'</span><span class="p">,</span><span class="s">'detrendDegree'</span><span class="p">,</span><span class="mi">1</span><span class="p">);</span>
</code></pre></div>
<h3 id="run-motion-correction">Run motion correction<a class="headerlink" href="#run-motion-correction" title="Permanent link">¶</a></h3>
<div class="codehilite"><pre><span></span><code><span class="lineno" data-linenos=" 1 "></span><span class="c">%% Get coordinates to crop from the user separately or set automatically</span>
<span class="lineno" data-linenos=" 2 "></span>
<span class="lineno" data-linenos=" 3 "></span><span class="n">if</span> <span class="s">guiEnabled==1</span>
<span class="lineno" data-linenos=" 4 "></span>
<span class="lineno" data-linenos=" 5 "></span>    <span class="p">[</span><span class="n">cropCoords</span><span class="p">]</span> <span class="p">=</span> <span class="n">ciapkg</span><span class="p">.</span><span class="n">api</span><span class="p">.</span><span class="n">getCropCoords</span><span class="p">(</span><span class="nb">squeeze</span><span class="p">(</span><span class="n">inputMovie</span><span class="p">(:,:,</span><span class="mi">1</span><span class="p">)));</span>
<span class="lineno" data-linenos=" 6 "></span>
<span class="lineno" data-linenos=" 7 "></span>    <span class="n">toptions</span><span class="p">.</span><span class="n">cropCoords</span> <span class="p">=</span> <span class="n">cropCoords</span><span class="p">;</span>
<span class="lineno" data-linenos=" 8 "></span>
<span class="lineno" data-linenos=" 9 "></span>    <span class="c">% Or have turboreg function itself directly ask the user for manual area from which to obtain correction coordinates</span>
<span class="lineno" data-linenos="10 "></span>
<span class="lineno" data-linenos="11 "></span>    <span class="c">% toptions.cropCoords = 'manual';</span>
<span class="lineno" data-linenos="12 "></span>
<span class="lineno" data-linenos="13 "></span><span class="n">else</span>
<span class="lineno" data-linenos="14 "></span>
<span class="lineno" data-linenos="15 "></span>    <span class="s">toptions.cropCoords</span> <span class="s">=</span> <span class="s">[26</span> <span class="s">34</span> <span class="s">212</span> <span class="s">188]</span><span class="p">;</span>
<span class="lineno" data-linenos="16 "></span>
<span class="lineno" data-linenos="17 "></span><span class="n">end</span>
</code></pre></div>
<div class="codehilite"><pre><span></span><code><span class="lineno" data-linenos=" 1 "></span><span class="c">%% Motion correction</span>
<span class="lineno" data-linenos=" 2 "></span>
<span class="lineno" data-linenos=" 3 "></span><span class="c">% Or have turboreg run manual correction</span>
<span class="lineno" data-linenos=" 4 "></span>
<span class="lineno" data-linenos=" 5 "></span><span class="n">toptions</span><span class="p">.</span><span class="n">cropCoords</span> <span class="p">=</span> <span class="s">'manual'</span><span class="p">;</span>
<span class="lineno" data-linenos=" 6 "></span>
<span class="lineno" data-linenos=" 7 "></span><span class="n">toptions</span><span class="p">.</span><span class="n">turboregRotation</span> <span class="p">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="lineno" data-linenos=" 8 "></span>
<span class="lineno" data-linenos=" 9 "></span><span class="n">toptions</span><span class="p">.</span><span class="n">removeEdges</span> <span class="p">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="lineno" data-linenos="10 "></span>
<span class="lineno" data-linenos="11 "></span><span class="n">toptions</span><span class="p">.</span><span class="n">pxToCrop</span> <span class="p">=</span> <span class="mi">10</span><span class="p">;</span>
<span class="lineno" data-linenos="12 "></span>
<span class="lineno" data-linenos="13 "></span><span class="c">% Pre-motion correction</span>
<span class="lineno" data-linenos="14 "></span>
<span class="lineno" data-linenos="15 "></span>    <span class="n">toptions</span><span class="p">.</span><span class="n">complementMatrix</span> <span class="p">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="lineno" data-linenos="16 "></span>
<span class="lineno" data-linenos="17 "></span>    <span class="n">toptions</span><span class="p">.</span><span class="n">meanSubtract</span> <span class="p">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="lineno" data-linenos="18 "></span>
<span class="lineno" data-linenos="19 "></span>    <span class="n">toptions</span><span class="p">.</span><span class="n">meanSubtractNormalize</span> <span class="p">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="lineno" data-linenos="20 "></span>
<span class="lineno" data-linenos="21 "></span>    <span class="n">toptions</span><span class="p">.</span><span class="n">normalizeType</span> <span class="p">=</span> <span class="s">'matlabDisk'</span><span class="p">;</span>
<span class="lineno" data-linenos="22 "></span>
<span class="lineno" data-linenos="23 "></span><span class="c">% Spatial filter</span>
<span class="lineno" data-linenos="24 "></span>
<span class="lineno" data-linenos="25 "></span>    <span class="n">toptions</span><span class="p">.</span><span class="n">normalizeBeforeRegister</span> <span class="p">=</span> <span class="s">'divideByLowpass'</span><span class="p">;</span>
<span class="lineno" data-linenos="26 "></span>
<span class="lineno" data-linenos="27 "></span>    <span class="n">toptions</span><span class="p">.</span><span class="n">freqLow</span> <span class="p">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="lineno" data-linenos="28 "></span>
<span class="lineno" data-linenos="29 "></span>    <span class="n">toptions</span><span class="p">.</span><span class="n">freqHigh</span> <span class="p">=</span> <span class="mi">7</span><span class="p">;</span>
<span class="lineno" data-linenos="30 "></span>
<span class="lineno" data-linenos="31 "></span><span class="p">[</span><span class="n">inputMovie2</span><span class="p">,</span> <span class="o">~</span><span class="p">]</span> <span class="p">=</span> <span class="n">ciapkg</span><span class="p">.</span><span class="n">api</span><span class="p">.</span><span class="n">turboregMovie</span><span class="p">(</span><span class="n">inputMovie</span><span class="p">,</span><span class="s">'options'</span><span class="p">,</span><span class="n">toptions</span><span class="p">);</span>
</code></pre></div>
<div class="codehilite"><pre><span></span><code><span class="lineno" data-linenos="1 "></span><span class="c">%% Compare raw and motion corrected movies</span>
<span class="lineno" data-linenos="2 "></span>
<span class="lineno" data-linenos="3 "></span><span class="n">ciapkg</span><span class="p">.</span><span class="n">api</span><span class="p">.</span><span class="n">playMovie</span><span class="p">(</span><span class="n">inputMovie</span><span class="p">,</span><span class="s">'extraMovie'</span><span class="p">,</span><span class="n">inputMovie2</span><span class="p">);</span>
</code></pre></div>
<h3 id="convert-movie-to-units-of-relative-fluorescence">Convert movie to units of relative fluorescence<a class="headerlink" href="#convert-movie-to-units-of-relative-fluorescence" title="Permanent link">¶</a></h3>
<div class="codehilite"><pre><span></span><code><span class="lineno" data-linenos="1 "></span><span class="c">%% Run dF/F</span>
<span class="lineno" data-linenos="2 "></span>
<span class="lineno" data-linenos="3 "></span><span class="n">inputMovie3</span> <span class="p">=</span> <span class="n">ciapkg</span><span class="p">.</span><span class="n">api</span><span class="p">.</span><span class="n">dfofMovie</span><span class="p">(</span><span class="n">single</span><span class="p">(</span><span class="n">inputMovie2</span><span class="p">),</span><span class="s">'dfofType'</span><span class="p">,</span><span class="s">'dfof'</span><span class="p">);</span>
</code></pre></div>
<h3 id="downsample-movie_1">Downsample movie<a class="headerlink" href="#downsample-movie_1" title="Permanent link">¶</a></h3>
<div class="codehilite"><pre><span></span><code><span class="lineno" data-linenos="1 "></span><span class="c">%% Run temporal downsampling</span>
<span class="lineno" data-linenos="2 "></span>
<span class="lineno" data-linenos="3 "></span><span class="n">inputMovie3</span> <span class="p">=</span> <span class="n">ciapkg</span><span class="p">.</span><span class="n">api</span><span class="p">.</span><span class="n">downsampleMovie</span><span class="p">(</span><span class="n">inputMovie3</span><span class="p">,</span><span class="s">'downsampleDimension'</span><span class="p">,</span><span class="s">'time'</span><span class="p">,</span><span class="s">'downsampleFactor'</span><span class="p">,</span><span class="mi">4</span><span class="p">);</span>
</code></pre></div>
<div class="codehilite"><pre><span></span><code><span class="lineno" data-linenos="1 "></span><span class="c">%% Final check of movie before cell extraction</span>
<span class="lineno" data-linenos="2 "></span>
<span class="lineno" data-linenos="3 "></span><span class="n">ciapkg</span><span class="p">.</span><span class="n">api</span><span class="p">.</span><span class="n">playMovie</span><span class="p">(</span><span class="n">inputMovie3</span><span class="p">);</span>
</code></pre></div>
<h3 id="run-pca-ica">Run PCA-ICA<a class="headerlink" href="#run-pca-ica" title="Permanent link">¶</a></h3>
<div class="codehilite"><pre><span></span><code><span class="lineno" data-linenos="1 "></span><span class="c">%% Run PCA-ICA cell extraction. CNMF-e, CNMF, ROI, and other cell-extraction algorithms are also available.</span>
<span class="lineno" data-linenos="2 "></span>
<span class="lineno" data-linenos="3 "></span><span class="n">nPCs</span> <span class="p">=</span> <span class="mi">300</span><span class="p">;</span>
<span class="lineno" data-linenos="4 "></span>
<span class="lineno" data-linenos="5 "></span><span class="n">nICs</span> <span class="p">=</span> <span class="mi">225</span><span class="p">;</span>
<span class="lineno" data-linenos="6 "></span>
<span class="lineno" data-linenos="7 "></span><span class="n">pcaicaStruct</span> <span class="p">=</span> <span class="n">ciapkg</span><span class="p">.</span><span class="n">signal_extraction</span><span class="p">.</span><span class="n">runPcaIca</span><span class="p">(</span><span class="n">inputMovie3</span><span class="p">,</span><span class="n">nPCs</span><span class="p">,</span><span class="n">nICs</span><span class="p">,</span><span class="s">'version'</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="s">'output_units'</span><span class="p">,</span><span class="s">'fl'</span><span class="p">,</span><span class="s">'mu'</span><span class="p">,</span><span class="mf">0.1</span><span class="p">,</span><span class="s">'term_tol'</span><span class="p">,</span><span class="mf">5e-6</span><span class="p">,</span><span class="s">'max_iter'</span><span class="p">,</span><span class="mf">1e3</span><span class="p">);</span>
</code></pre></div>
<div class="codehilite"><pre><span></span><code><span class="lineno" data-linenos="1 "></span><span class="c">%% Save outputs to NWB format</span>
<span class="lineno" data-linenos="2 "></span>
<span class="lineno" data-linenos="3 "></span><span class="n">if</span> <span class="s">saveAnalysis==1</span>
<span class="lineno" data-linenos="4 "></span>
<span class="lineno" data-linenos="5 "></span>    <span class="n">ciapkg</span><span class="p">.</span><span class="n">api</span><span class="p">.</span><span class="n">saveNeurodataWithoutBorders</span><span class="p">(</span><span class="n">pcaicaStruct</span><span class="p">.</span><span class="n">IcaFilters</span><span class="p">,{</span><span class="n">pcaicaStruct</span><span class="p">.</span><span class="n">IcaTraces</span><span class="p">},</span><span class="s">'pcaica'</span><span class="p">,[</span><span class="n">nwbFilePath</span> <span class="s">'_pcaicaAnalysis.nwb'</span><span class="p">]);</span>
<span class="lineno" data-linenos="6 "></span>
<span class="lineno" data-linenos="7 "></span><span class="n">end</span>
</code></pre></div>
<h3 id="run-cnmf-or-cnmf-e-cell-extraction">Run CNMF or CNMF-e cell extraction.<a class="headerlink" href="#run-cnmf-or-cnmf-e-cell-extraction" title="Permanent link">¶</a></h3>
<div class="codehilite"><pre><span></span><code><span class="lineno" data-linenos=" 1 "></span><span class="c">%% Run CNMF or CNMF-e cell extraction</span>
<span class="lineno" data-linenos=" 2 "></span>
<span class="lineno" data-linenos=" 3 "></span><span class="n">numExpectedComponents</span> <span class="p">=</span> <span class="mi">225</span><span class="p">;</span>
<span class="lineno" data-linenos=" 4 "></span>
<span class="lineno" data-linenos=" 5 "></span><span class="n">cellWidth</span> <span class="p">=</span> <span class="mi">10</span><span class="p">;</span>
<span class="lineno" data-linenos=" 6 "></span>
<span class="lineno" data-linenos=" 7 "></span><span class="n">cnmfOptions</span><span class="p">.</span><span class="n">otherCNMF</span><span class="p">.</span><span class="n">tau</span> <span class="p">=</span> <span class="n">cellWidth</span><span class="o">/</span><span class="mi">2</span><span class="p">;</span> <span class="c">% expected width of cells</span>
<span class="lineno" data-linenos=" 8 "></span>
<span class="lineno" data-linenos=" 9 "></span>
<span class="lineno" data-linenos="10 "></span>
<span class="lineno" data-linenos="11 "></span><span class="c">% Run CNMF</span>
<span class="lineno" data-linenos="12 "></span>
<span class="lineno" data-linenos="13 "></span><span class="p">[</span><span class="n">success</span><span class="p">]</span> <span class="p">=</span> <span class="n">ciapkg</span><span class="p">.</span><span class="n">api</span><span class="p">.</span><span class="n">cnmfVersionDirLoad</span><span class="p">(</span><span class="s">'current'</span><span class="p">);</span>
<span class="lineno" data-linenos="14 "></span>
<span class="lineno" data-linenos="15 "></span><span class="p">[</span><span class="n">cnmfAnalysisOutput</span><span class="p">]</span> <span class="p">=</span> <span class="n">ciapkg</span><span class="p">.</span><span class="n">api</span><span class="p">.</span><span class="n">computeCnmfSignalExtractionClass</span><span class="p">(</span><span class="n">inputMovie3</span><span class="p">,</span><span class="n">numExpectedComponents</span><span class="p">,</span><span class="s">'options'</span><span class="p">,</span><span class="n">cnmfOptions</span><span class="p">);</span>
<span class="lineno" data-linenos="16 "></span>
<span class="lineno" data-linenos="17 "></span>
<span class="lineno" data-linenos="18 "></span>
<span class="lineno" data-linenos="19 "></span><span class="c">% Run CNMF-e</span>
<span class="lineno" data-linenos="20 "></span>
<span class="lineno" data-linenos="21 "></span><span class="p">[</span><span class="n">success</span><span class="p">]</span> <span class="p">=</span> <span class="n">ciapkg</span><span class="p">.</span><span class="n">api</span><span class="p">.</span><span class="n">cnmfVersionDirLoad</span><span class="p">(</span><span class="s">'cnmfe'</span><span class="p">);</span>
<span class="lineno" data-linenos="22 "></span>
<span class="lineno" data-linenos="23 "></span><span class="n">cnmfeOptions</span><span class="p">.</span><span class="n">gSiz</span> <span class="p">=</span> <span class="n">cellWidth</span><span class="p">;</span>
<span class="lineno" data-linenos="24 "></span>
<span class="lineno" data-linenos="25 "></span><span class="n">cnmfeOptions</span><span class="p">.</span><span class="n">gSig</span> <span class="p">=</span> <span class="nb">ceil</span><span class="p">(</span><span class="n">cellWidth</span><span class="o">/</span><span class="mi">4</span><span class="p">);</span>
<span class="lineno" data-linenos="26 "></span>
<span class="lineno" data-linenos="27 "></span><span class="p">[</span><span class="n">cnmfeAnalysisOutput</span><span class="p">]</span> <span class="p">=</span> <span class="n">ciapkg</span><span class="p">.</span><span class="n">api</span><span class="p">.</span><span class="n">computeCnmfeSignalExtraction_batch</span><span class="p">(</span><span class="n">outputMoviePath</span><span class="p">,</span><span class="s">'options'</span><span class="p">,</span><span class="n">cnmfeOptions</span><span class="p">);</span>
<span class="lineno" data-linenos="28 "></span>
<span class="lineno" data-linenos="29 "></span>
<span class="lineno" data-linenos="30 "></span>
<span class="lineno" data-linenos="31 "></span><span class="c">% Save outputs to NWB format</span>
<span class="lineno" data-linenos="32 "></span>
<span class="lineno" data-linenos="33 "></span><span class="n">if</span> <span class="s">saveAnalysis==1</span>
<span class="lineno" data-linenos="34 "></span>
<span class="lineno" data-linenos="35 "></span>    <span class="c">% Save CNMF</span>
<span class="lineno" data-linenos="36 "></span>
<span class="lineno" data-linenos="37 "></span>    <span class="n">ciapkg</span><span class="p">.</span><span class="n">api</span><span class="p">.</span><span class="n">saveNeurodataWithoutBorders</span><span class="p">(</span><span class="n">cnmfAnalysisOutput</span><span class="p">.</span><span class="n">extractedImages</span><span class="p">,{</span><span class="n">cnmfAnalysisOutput</span><span class="p">.</span><span class="n">extractedSignals</span><span class="p">,</span><span class="n">cnmfAnalysisOutput</span><span class="p">.</span><span class="n">extractedSignalsEst</span><span class="p">},</span><span class="s">'cnmf'</span><span class="p">,[</span><span class="n">nwbFilePath</span> <span class="s">'_cnmf.nwb'</span><span class="p">]);</span>
<span class="lineno" data-linenos="38 "></span>
<span class="lineno" data-linenos="39 "></span>
<span class="lineno" data-linenos="40 "></span>
<span class="lineno" data-linenos="41 "></span>    <span class="c">% Save CNMF-E</span>
<span class="lineno" data-linenos="42 "></span>
<span class="lineno" data-linenos="43 "></span>    <span class="n">ciapkg</span><span class="p">.</span><span class="n">api</span><span class="p">.</span><span class="n">saveNeurodataWithoutBorders</span><span class="p">(</span><span class="n">cnmfeAnalysisOutput</span><span class="p">.</span><span class="n">extractedImages</span><span class="p">,{</span><span class="n">cnmfeAnalysisOutput</span><span class="p">.</span><span class="n">extractedSignals</span><span class="p">,</span><span class="n">cnmfeAnalysisOutput</span><span class="p">.</span><span class="n">extractedSignalsEst</span><span class="p">},</span><span class="s">'cnmfe'</span><span class="p">,[</span><span class="n">nwbFilePath</span> <span class="s">'_cnmfe.nwb'</span><span class="p">]);</span>
<span class="lineno" data-linenos="44 "></span>
<span class="lineno" data-linenos="45 "></span><span class="n">end</span>
<span class="lineno" data-linenos="46 "></span>
<span class="lineno" data-linenos="47 "></span>
<span class="lineno" data-linenos="48 "></span>
<span class="lineno" data-linenos="49 "></span><span class="s">[success]</span> <span class="s">=</span> <span class="s">ciapkg.api.cnmfVersionDirLoad('none')</span><span class="p">;</span>
</code></pre></div>
<h3 id="run-extract-cell-extraction">Run EXTRACT cell extraction.<a class="headerlink" href="#run-extract-cell-extraction" title="Permanent link">¶</a></h3>
<div class="codehilite"><pre><span></span><code><span class="lineno" data-linenos=" 1 "></span><span class="c">%% Run EXTRACT cell extraction. Check each function with "edit" for options.</span>
<span class="lineno" data-linenos=" 2 "></span>
<span class="lineno" data-linenos=" 3 "></span><span class="c">% Load default configuration</span>
<span class="lineno" data-linenos=" 4 "></span>
<span class="lineno" data-linenos=" 5 "></span><span class="n">ciapkg</span><span class="p">.</span><span class="n">loadBatchFxns</span><span class="p">(</span><span class="s">'loadEverything'</span><span class="p">);</span>
<span class="lineno" data-linenos=" 6 "></span>
<span class="lineno" data-linenos=" 7 "></span><span class="n">extractConfig</span> <span class="p">=</span> <span class="n">get_defaults</span><span class="p">([]);</span>
<span class="lineno" data-linenos=" 8 "></span>
<span class="lineno" data-linenos=" 9 "></span>
<span class="lineno" data-linenos="10 "></span>
<span class="lineno" data-linenos="11 "></span><span class="c">% See https://github.com/schnitzer-lab/EXTRACT-public#configurations.</span>
<span class="lineno" data-linenos="12 "></span>
<span class="lineno" data-linenos="13 "></span><span class="n">cellWidth</span> <span class="p">=</span> <span class="mi">10</span><span class="p">;</span>
<span class="lineno" data-linenos="14 "></span>
<span class="lineno" data-linenos="15 "></span><span class="n">extractConfig</span><span class="p">.</span><span class="n">avg_cell_radius</span> <span class="p">=</span> <span class="n">cellWidth</span><span class="p">;</span>
<span class="lineno" data-linenos="16 "></span>
<span class="lineno" data-linenos="17 "></span><span class="n">extractConfig</span><span class="p">.</span><span class="n">num_partitions_x</span> <span class="p">=</span> <span class="mi">2</span><span class="p">;</span>
<span class="lineno" data-linenos="18 "></span>
<span class="lineno" data-linenos="19 "></span><span class="n">extractConfig</span><span class="p">.</span><span class="n">num_partitions_y</span> <span class="p">=</span> <span class="mi">2</span><span class="p">;</span>
<span class="lineno" data-linenos="20 "></span>
<span class="lineno" data-linenos="21 "></span><span class="n">extractConfig</span><span class="p">.</span><span class="n">use_sparse_arrays</span> <span class="p">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="lineno" data-linenos="22 "></span>
<span class="lineno" data-linenos="23 "></span>
<span class="lineno" data-linenos="24 "></span>
<span class="lineno" data-linenos="25 "></span><span class="n">outStruct</span> <span class="p">=</span> <span class="n">extractor</span><span class="p">(</span><span class="n">inputMovie3</span><span class="p">,</span><span class="n">extractConfig</span><span class="p">);</span>
<span class="lineno" data-linenos="26 "></span>
<span class="lineno" data-linenos="27 "></span>
<span class="lineno" data-linenos="28 "></span>
<span class="lineno" data-linenos="29 "></span><span class="c">% Grab outputs and put into standard format</span>
<span class="lineno" data-linenos="30 "></span>
<span class="lineno" data-linenos="31 "></span><span class="n">extractAnalysisOutput</span><span class="p">.</span><span class="n">filters</span> <span class="p">=</span> <span class="n">outStruct</span><span class="p">.</span><span class="n">spatial_weights</span><span class="p">;</span>
<span class="lineno" data-linenos="32 "></span>
<span class="lineno" data-linenos="33 "></span><span class="c">% permute so it is [nCells frames]</span>
<span class="lineno" data-linenos="34 "></span>
<span class="lineno" data-linenos="35 "></span><span class="n">extractAnalysisOutput</span><span class="p">.</span><span class="n">traces</span> <span class="p">=</span> <span class="nb">permute</span><span class="p">(</span><span class="n">outStruct</span><span class="p">.</span><span class="n">temporal_weights</span><span class="p">,</span> <span class="p">[</span><span class="mi">2</span> <span class="mi">1</span><span class="p">]);</span>
<span class="lineno" data-linenos="36 "></span>
<span class="lineno" data-linenos="37 "></span>
<span class="lineno" data-linenos="38 "></span>
<span class="lineno" data-linenos="39 "></span><span class="c">% Other run information if saving as a MAT-file.</span>
<span class="lineno" data-linenos="40 "></span>
<span class="lineno" data-linenos="41 "></span><span class="n">extractAnalysisOutput</span><span class="p">.</span><span class="n">info</span> <span class="p">=</span> <span class="n">outStruct</span><span class="p">.</span><span class="n">info</span><span class="p">;</span>
<span class="lineno" data-linenos="42 "></span>
<span class="lineno" data-linenos="43 "></span><span class="n">extractAnalysisOutput</span><span class="p">.</span><span class="n">config</span> <span class="p">=</span> <span class="n">outStruct</span><span class="p">.</span><span class="n">config</span><span class="p">;</span>
<span class="lineno" data-linenos="44 "></span>
<span class="lineno" data-linenos="45 "></span><span class="n">extractAnalysisOutput</span><span class="p">.</span><span class="n">info</span> <span class="p">=</span> <span class="n">outStruct</span><span class="p">.</span><span class="n">info</span><span class="p">;</span>
<span class="lineno" data-linenos="46 "></span>
<span class="lineno" data-linenos="47 "></span><span class="n">extractAnalysisOutput</span><span class="p">.</span><span class="n">userInputConfig</span> <span class="p">=</span> <span class="n">extractConfig</span><span class="p">;</span>
<span class="lineno" data-linenos="48 "></span>
<span class="lineno" data-linenos="49 "></span><span class="n">extractAnalysisOutput</span><span class="p">.</span><span class="n">opts</span> <span class="p">=</span> <span class="n">outStruct</span><span class="p">.</span><span class="n">config</span><span class="p">;</span>
<span class="lineno" data-linenos="50 "></span>
<span class="lineno" data-linenos="51 "></span>
<span class="lineno" data-linenos="52 "></span>
<span class="lineno" data-linenos="53 "></span><span class="c">% Save outputs to NWB format</span>
<span class="lineno" data-linenos="54 "></span>
<span class="lineno" data-linenos="55 "></span><span class="n">if</span> <span class="s">saveAnalysis==1</span>
<span class="lineno" data-linenos="56 "></span>
<span class="lineno" data-linenos="57 "></span>    <span class="n">ciapkg</span><span class="p">.</span><span class="n">api</span><span class="p">.</span><span class="n">saveNeurodataWithoutBorders</span><span class="p">(</span><span class="n">extractAnalysisOutput</span><span class="p">.</span><span class="n">filters</span><span class="p">,{</span><span class="n">extractAnalysisOutput</span><span class="p">.</span><span class="n">traces</span><span class="p">},</span><span class="s">'extract'</span><span class="p">,[</span><span class="n">nwbFilePath</span> <span class="s">'_extract.nwb'</span><span class="p">]);</span>
<span class="lineno" data-linenos="58 "></span>
<span class="lineno" data-linenos="59 "></span><span class="n">end</span>
<span class="lineno" data-linenos="60 "></span>
<span class="lineno" data-linenos="61 "></span>
<span class="lineno" data-linenos="62 "></span>
<span class="lineno" data-linenos="63 "></span><span class="s">%</span> <span class="s">Remove</span> <span class="s">EXTRACT</span> <span class="s">from</span> <span class="s">the</span> <span class="s">path.</span>
<span class="lineno" data-linenos="64 "></span>
<span class="lineno" data-linenos="65 "></span><span class="n">ciapkg</span><span class="p">.</span><span class="n">loadBatchFxns</span><span class="p">();</span>
</code></pre></div>
<h3 id="manual-sort-output-cells">Manual sort output cells<a class="headerlink" href="#manual-sort-output-cells" title="Permanent link">¶</a></h3>
<div class="codehilite"><pre><span></span><code><span class="lineno" data-linenos="1 "></span><span class="c">%% Run signal sorting using matrix inputs</span>
<span class="lineno" data-linenos="2 "></span>
<span class="lineno" data-linenos="3 "></span><span class="p">[</span><span class="n">outImages</span><span class="p">,</span> <span class="n">outSignals</span><span class="p">,</span> <span class="n">choices</span><span class="p">]</span> <span class="p">=</span> <span class="n">ciapkg</span><span class="p">.</span><span class="n">api</span><span class="p">.</span><span class="n">signalSorter</span><span class="p">(</span><span class="n">IcaFilters</span><span class="p">,</span><span class="n">IcaTraces</span><span class="p">,</span><span class="s">'inputMovie'</span><span class="p">,</span><span class="n">inputMovie3</span><span class="p">);</span>
</code></pre></div>
<h4 id="run-signal-sorting-using-nwb">Run signal sorting using NWB<a class="headerlink" href="#run-signal-sorting-using-nwb" title="Permanent link">¶</a></h4>
<div class="codehilite"><pre><span></span><code><span class="lineno" data-linenos="1 "></span><span class="c">%% Run signal sorting using NWB</span>
<span class="lineno" data-linenos="2 "></span>
<span class="lineno" data-linenos="3 "></span><span class="p">[</span><span class="n">outImages</span><span class="p">,</span> <span class="n">outSignals</span><span class="p">,</span> <span class="n">choices</span><span class="p">]</span> <span class="p">=</span> <span class="n">ciapkg</span><span class="p">.</span><span class="n">api</span><span class="p">.</span><span class="n">signalSorter</span><span class="p">([</span><span class="n">nwbFilePath</span> <span class="s">'_pcaicaAnalysis.nwb'</span><span class="p">],[],</span><span class="s">'inputMovie'</span><span class="p">,</span><span class="n">inputMovie3</span><span class="p">);</span>
</code></pre></div>
<div class="codehilite"><pre><span></span><code><span class="lineno" data-linenos="1 "></span><span class="c">%% Plot results of sorting</span>
<span class="lineno" data-linenos="2 "></span>
<span class="lineno" data-linenos="3 "></span><span class="n">figure</span><span class="p">;</span>
<span class="lineno" data-linenos="4 "></span>
<span class="lineno" data-linenos="5 "></span><span class="n">subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">);</span><span class="n">imagesc</span><span class="p">(</span><span class="n">max</span><span class="p">(</span><span class="n">IcaFilters</span><span class="p">,[],</span><span class="mi">3</span><span class="p">));</span><span class="n">axis</span> <span class="s">equal</span> <span class="s">tight</span><span class="p">;</span> <span class="n">title</span><span class="p">(</span><span class="s">'Raw filters'</span><span class="p">)</span>
<span class="lineno" data-linenos="6 "></span>
<span class="lineno" data-linenos="7 "></span><span class="n">subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">);</span><span class="n">imagesc</span><span class="p">(</span><span class="n">max</span><span class="p">(</span><span class="n">outImages</span><span class="p">,[],</span><span class="mi">3</span><span class="p">));</span><span class="n">axis</span> <span class="s">equal</span> <span class="s">tight</span><span class="p">;</span> <span class="n">title</span><span class="p">(</span><span class="s">'Sorted filters'</span><span class="p">)</span>
</code></pre></div>
<h4 id="run-signal-sorting-using-multiple-nwb-files-from-cell-extraction">Run signal sorting using multiple NWB files from cell extraction.<a class="headerlink" href="#run-signal-sorting-using-multiple-nwb-files-from-cell-extraction" title="Permanent link">¶</a></h4>
<div class="codehilite"><pre><span></span><code><span class="lineno" data-linenos=" 1 "></span><span class="c">% Run signal sorting using NWB files from cell extraction.</span>
<span class="lineno" data-linenos=" 2 "></span>
<span class="lineno" data-linenos=" 3 "></span><span class="n">if</span> <span class="s">saveAnalysis==1&amp;guiEnabled==1</span>
<span class="lineno" data-linenos=" 4 "></span>
<span class="lineno" data-linenos=" 5 "></span>    <span class="nb">disp</span><span class="p">(</span><span class="nb">repmat</span><span class="p">(</span><span class="s">'='</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">21</span><span class="p">));</span><span class="nb">disp</span><span class="p">(</span><span class="s">'Running signalSorter using NWB file input.'</span><span class="p">)</span>
<span class="lineno" data-linenos=" 6 "></span>
<span class="lineno" data-linenos=" 7 "></span>    <span class="n">nwbFileList</span> <span class="p">=</span> <span class="n">ciapkg</span><span class="p">.</span><span class="n">api</span><span class="p">.</span><span class="n">getFileList</span><span class="p">(</span><span class="n">nwbFileFolderPath</span><span class="p">,</span><span class="s">'.nwb'</span><span class="p">);</span>
<span class="lineno" data-linenos=" 8 "></span>
<span class="lineno" data-linenos=" 9 "></span>    <span class="n">if</span> <span class="s">~isempty(nwbFileList)</span>
<span class="lineno" data-linenos="10 "></span>
<span class="lineno" data-linenos="11 "></span>        <span class="n">nFiles</span> <span class="p">=</span> <span class="nb">length</span><span class="p">(</span><span class="n">nwbFileList</span><span class="p">);</span>
<span class="lineno" data-linenos="12 "></span>
<span class="lineno" data-linenos="13 "></span>        <span class="n">outImages</span> <span class="p">=</span> <span class="p">{};</span>
<span class="lineno" data-linenos="14 "></span>
<span class="lineno" data-linenos="15 "></span>        <span class="n">outSignals</span> <span class="p">=</span> <span class="p">{};</span>
<span class="lineno" data-linenos="16 "></span>
<span class="lineno" data-linenos="17 "></span>        <span class="n">choices</span> <span class="p">=</span> <span class="p">{};</span>
<span class="lineno" data-linenos="18 "></span>
<span class="lineno" data-linenos="19 "></span>        <span class="n">for</span> <span class="s">fileNo</span> <span class="s">=</span> <span class="s">1:nFiles</span>
<span class="lineno" data-linenos="20 "></span>
<span class="lineno" data-linenos="21 "></span>            <span class="p">[</span><span class="n">outImages</span><span class="p">{</span><span class="n">fileNo</span><span class="p">},</span> <span class="n">outSignals</span><span class="p">{</span><span class="n">fileNo</span><span class="p">},</span> <span class="n">choices</span><span class="p">{</span><span class="n">fileNo</span><span class="p">}]</span> <span class="p">=</span> <span class="n">ciapkg</span><span class="p">.</span><span class="n">api</span><span class="p">.</span><span class="n">signalSorter</span><span class="p">(</span><span class="n">nwbFileList</span><span class="p">{</span><span class="n">fileNo</span><span class="p">},[],</span><span class="s">'inputMovie'</span><span class="p">,</span><span class="n">inputMovie3</span><span class="p">);</span>
<span class="lineno" data-linenos="22 "></span>
<span class="lineno" data-linenos="23 "></span>        <span class="n">end</span>
<span class="lineno" data-linenos="24 "></span>
<span class="lineno" data-linenos="25 "></span>
<span class="lineno" data-linenos="26 "></span>
<span class="lineno" data-linenos="27 "></span>        <span class="s">%</span> <span class="s">Plot</span> <span class="s">results</span> <span class="s">of</span> <span class="s">sorting</span>
<span class="lineno" data-linenos="28 "></span>
<span class="lineno" data-linenos="29 "></span>        <span class="n">for</span> <span class="s">fileNo</span> <span class="s">=</span> <span class="s">1:nFiles</span>
<span class="lineno" data-linenos="30 "></span>
<span class="lineno" data-linenos="31 "></span>            <span class="n">try</span>
<span class="lineno" data-linenos="32 "></span>
<span class="lineno" data-linenos="33 "></span>                <span class="s">[inputImagesTmp,inputSignalsTmp,infoStructTmp,algorithmStrTmp,inputSignals2Tmp]</span> <span class="s">=</span> <span class="s">ciapkg.io.loadSignalExtraction(nwbFileList{fileNo})</span><span class="p">;</span>
<span class="lineno" data-linenos="34 "></span>
<span class="lineno" data-linenos="35 "></span>                <span class="n">figure</span><span class="p">;</span>
<span class="lineno" data-linenos="36 "></span>
<span class="lineno" data-linenos="37 "></span>                <span class="n">subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">);</span> 
<span class="lineno" data-linenos="38 "></span>
<span class="lineno" data-linenos="39 "></span>                    <span class="n">imagesc</span><span class="p">(</span><span class="n">max</span><span class="p">(</span><span class="n">inputImagesTmp</span><span class="p">,[],</span><span class="mi">3</span><span class="p">));</span>
<span class="lineno" data-linenos="40 "></span>
<span class="lineno" data-linenos="41 "></span>                    <span class="n">axis</span> <span class="s">equal</span> <span class="s">tight</span><span class="p">;</span> 
<span class="lineno" data-linenos="42 "></span>
<span class="lineno" data-linenos="43 "></span>                    <span class="n">title</span><span class="p">([</span><span class="n">algorithmStrTmp</span> <span class="s">' | Raw filters'</span><span class="p">])</span>
<span class="lineno" data-linenos="44 "></span>
<span class="lineno" data-linenos="45 "></span>                <span class="n">subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">);</span> 
<span class="lineno" data-linenos="46 "></span>
<span class="lineno" data-linenos="47 "></span>                    <span class="n">imagesc</span><span class="p">(</span><span class="n">max</span><span class="p">(</span><span class="n">outImages</span><span class="p">{</span><span class="n">fileNo</span><span class="p">},[],</span><span class="mi">3</span><span class="p">));</span>
<span class="lineno" data-linenos="48 "></span>
<span class="lineno" data-linenos="49 "></span>                    <span class="n">axis</span> <span class="s">equal</span> <span class="s">tight</span><span class="p">;</span> 
<span class="lineno" data-linenos="50 "></span>
<span class="lineno" data-linenos="51 "></span>                    <span class="n">title</span><span class="p">(</span><span class="s">'Sorted filters'</span><span class="p">)</span>
<span class="lineno" data-linenos="52 "></span>
<span class="lineno" data-linenos="53 "></span>            <span class="n">catch</span> <span class="s">err</span>
<span class="lineno" data-linenos="54 "></span>
<span class="lineno" data-linenos="55 "></span>                <span class="nb">disp</span><span class="p">(</span><span class="nb">repmat</span><span class="p">(</span><span class="s">'@'</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">7</span><span class="p">))</span>
<span class="lineno" data-linenos="56 "></span>
<span class="lineno" data-linenos="57 "></span>                <span class="nb">disp</span><span class="p">(</span><span class="n">getReport</span><span class="p">(</span><span class="n">err</span><span class="p">,</span><span class="s">'extended'</span><span class="p">,</span><span class="s">'hyperlinks'</span><span class="p">,</span><span class="s">'on'</span><span class="p">));</span>
<span class="lineno" data-linenos="58 "></span>
<span class="lineno" data-linenos="59 "></span>                <span class="nb">disp</span><span class="p">(</span><span class="nb">repmat</span><span class="p">(</span><span class="s">'@'</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">7</span><span class="p">))</span>
<span class="lineno" data-linenos="60 "></span>
<span class="lineno" data-linenos="61 "></span>            <span class="n">end</span>
<span class="lineno" data-linenos="62 "></span>
<span class="lineno" data-linenos="63 "></span>        <span class="s">end</span>
<span class="lineno" data-linenos="64 "></span>
<span class="lineno" data-linenos="65 "></span>    <span class="n">end</span>
<span class="lineno" data-linenos="66 "></span>
<span class="lineno" data-linenos="67 "></span><span class="s">end</span>
</code></pre></div>
<h3 id="overlay-cells-on-movies-as-sanity-check">Overlay cells on movies as sanity check<a class="headerlink" href="#overlay-cells-on-movies-as-sanity-check" title="Permanent link">¶</a></h3>
<div class="codehilite"><pre><span></span><code><span class="lineno" data-linenos="1 "></span><span class="c">%% Create an overlay of extraction outputs on the movie and signal-based movie</span>
<span class="lineno" data-linenos="2 "></span>
<span class="lineno" data-linenos="3 "></span><span class="p">[</span><span class="n">inputMovieO</span><span class="p">]</span> <span class="p">=</span> <span class="n">ciapkg</span><span class="p">.</span><span class="n">api</span><span class="p">.</span><span class="n">createImageOutlineOnMovie</span><span class="p">(</span><span class="n">inputMovie3</span><span class="p">,</span><span class="n">IcaFilters</span><span class="p">,</span><span class="s">'dilateOutlinesFactor'</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span>
<span class="lineno" data-linenos="4 "></span>
<span class="lineno" data-linenos="5 "></span><span class="p">[</span><span class="n">signalMovie</span><span class="p">]</span> <span class="p">=</span> <span class="n">ciapkg</span><span class="p">.</span><span class="n">api</span><span class="p">.</span><span class="n">createSignalBasedMovie</span><span class="p">(</span><span class="n">IcaTraces</span><span class="p">,</span><span class="n">IcaFilters</span><span class="p">,</span><span class="s">'signalType'</span><span class="p">,</span><span class="s">'peak'</span><span class="p">);</span>
</code></pre></div>
<div class="codehilite"><pre><span></span><code><span class="lineno" data-linenos="1 "></span><span class="c">%% Play all three movies</span>
<span class="lineno" data-linenos="2 "></span>
<span class="lineno" data-linenos="3 "></span><span class="c">% Normalize all the movies</span>
<span class="lineno" data-linenos="4 "></span>
<span class="lineno" data-linenos="5 "></span><span class="n">movieM</span> <span class="p">=</span> <span class="n">cellfun</span><span class="p">(@(</span><span class="n">x</span><span class="p">)</span> <span class="n">ciapkg</span><span class="p">.</span><span class="n">api</span><span class="p">.</span><span class="n">normalizeVector</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="s">'normRange'</span><span class="p">,</span><span class="s">'zeroToOne'</span><span class="p">),{</span><span class="n">inputMovie3</span><span class="p">,</span><span class="n">inputMovieO</span><span class="p">,</span><span class="n">signalMovie</span><span class="p">},</span><span class="s">'UniformOutput'</span><span class="p">,</span><span class="n">false</span><span class="p">);</span>
<span class="lineno" data-linenos="6 "></span>
<span class="lineno" data-linenos="7 "></span><span class="n">ciapkg</span><span class="p">.</span><span class="n">api</span><span class="p">.</span><span class="n">playMovie</span><span class="p">(</span><span class="nb">cat</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="n">movieM</span><span class="p">{:}));</span>
</code></pre></div>
<h3 id="batch-process-example-movies-and-perform-cross-session-cell-alignment">Batch process example movies and perform cross-session cell alignment<a class="headerlink" href="#batch-process-example-movies-and-perform-cross-session-cell-alignment" title="Permanent link">¶</a></h3>
<div class="codehilite"><pre><span></span><code><span class="lineno" data-linenos=" 1 "></span><span class="c">%% Run pre-processing on 3 batch movies then do cross-session alignment</span>
<span class="lineno" data-linenos=" 2 "></span>
<span class="lineno" data-linenos=" 3 "></span><span class="n">batchMovieList</span> <span class="p">=</span> <span class="p">{</span><span class="c">...</span>
<span class="lineno" data-linenos=" 4 "></span>
<span class="lineno" data-linenos=" 5 "></span><span class="p">[</span><span class="n">ciapkg</span><span class="p">.</span><span class="n">getDir</span><span class="p">()</span> <span class="n">filesep</span> <span class="s">'data'</span> <span class="n">filesep</span> <span class="s">'batch'</span> <span class="n">filesep</span> <span class="s">'2014_08_05_p104_m19_PAV08'</span><span class="p">],</span><span class="c">...</span>
<span class="lineno" data-linenos=" 6 "></span>
<span class="lineno" data-linenos=" 7 "></span><span class="p">[</span><span class="n">ciapkg</span><span class="p">.</span><span class="n">getDir</span><span class="p">()</span> <span class="n">filesep</span> <span class="s">'data'</span> <span class="n">filesep</span> <span class="s">'batch'</span> <span class="n">filesep</span> <span class="s">'2014_08_06_p104_m19_PAV09'</span><span class="p">],</span><span class="c">...</span>
<span class="lineno" data-linenos=" 8 "></span>
<span class="lineno" data-linenos=" 9 "></span><span class="p">[</span><span class="n">ciapkg</span><span class="p">.</span><span class="n">getDir</span><span class="p">()</span> <span class="n">filesep</span> <span class="s">'data'</span> <span class="n">filesep</span> <span class="s">'batch'</span> <span class="n">filesep</span> <span class="s">'2014_08_07_p104_m19_PAV10'</span><span class="p">]</span><span class="c">...</span>
<span class="lineno" data-linenos="10 "></span>
<span class="lineno" data-linenos="11 "></span><span class="p">};</span>
</code></pre></div>
<div class="codehilite"><pre><span></span><code><span class="lineno" data-linenos=" 1 "></span><span class="c">% USER INTERFACE Get the motion correction crop coordinates</span>
<span class="lineno" data-linenos=" 2 "></span>
<span class="lineno" data-linenos=" 3 "></span><span class="n">cropCoordsCell</span> <span class="p">=</span> <span class="p">{};</span>
<span class="lineno" data-linenos=" 4 "></span>
<span class="lineno" data-linenos=" 5 "></span><span class="n">nFolders</span> <span class="p">=</span> <span class="nb">length</span><span class="p">(</span><span class="n">batchMovieList</span><span class="p">);</span>
<span class="lineno" data-linenos=" 6 "></span>
<span class="lineno" data-linenos=" 7 "></span><span class="n">for</span> <span class="s">folderNo</span> <span class="s">=</span> <span class="s">1:nFolders</span>
<span class="lineno" data-linenos=" 8 "></span>
<span class="lineno" data-linenos=" 9 "></span>    <span class="n">analysisFolderPath</span> <span class="p">=</span> <span class="n">batchMovieList</span><span class="p">{</span><span class="n">folderNo</span><span class="p">};</span>
<span class="lineno" data-linenos="10 "></span>
<span class="lineno" data-linenos="11 "></span>    <span class="n">inputMoviePath</span> <span class="p">=</span> <span class="n">ciapkg</span><span class="p">.</span><span class="n">api</span><span class="p">.</span><span class="n">getFileList</span><span class="p">(</span><span class="n">analysisFolderPath</span><span class="p">,</span><span class="n">rawFileRegexp</span><span class="p">,</span><span class="s">'sortMethod'</span><span class="p">,</span><span class="s">'natural'</span><span class="p">);</span>
<span class="lineno" data-linenos="12 "></span>
<span class="lineno" data-linenos="13 "></span>    <span class="c">% inputMoviePath = [analysisFolderPath filesep 'concat_recording_20140401_180333.h5'];</span>
<span class="lineno" data-linenos="14 "></span>
<span class="lineno" data-linenos="15 "></span>    <span class="n">inputMovie</span> <span class="p">=</span> <span class="n">ciapkg</span><span class="p">.</span><span class="n">api</span><span class="p">.</span><span class="n">loadMovieList</span><span class="p">(</span><span class="n">inputMoviePath</span><span class="p">,</span><span class="s">'inputDatasetName'</span><span class="p">,</span><span class="n">inputDatasetName</span><span class="p">,</span><span class="s">'frameList'</span><span class="p">,</span><span class="mi">1</span><span class="p">:</span><span class="mi">2</span><span class="p">);</span>
<span class="lineno" data-linenos="16 "></span>
<span class="lineno" data-linenos="17 "></span>
<span class="lineno" data-linenos="18 "></span>
<span class="lineno" data-linenos="19 "></span>    <span class="p">[</span><span class="n">cropCoords</span><span class="p">]</span> <span class="p">=</span> <span class="n">ciapkg</span><span class="p">.</span><span class="n">api</span><span class="p">.</span><span class="n">getCropCoords</span><span class="p">(</span><span class="nb">squeeze</span><span class="p">(</span><span class="n">inputMovie</span><span class="p">(:,:,</span><span class="mi">1</span><span class="p">)));</span>
<span class="lineno" data-linenos="20 "></span>
<span class="lineno" data-linenos="21 "></span>    <span class="c">% toptions.cropCoords = cropCoords;</span>
<span class="lineno" data-linenos="22 "></span>
<span class="lineno" data-linenos="23 "></span>    <span class="n">cropCoordsCell</span><span class="p">{</span><span class="n">folderNo</span><span class="p">}</span> <span class="p">=</span> <span class="n">cropCoords</span><span class="p">;</span>
<span class="lineno" data-linenos="24 "></span>
<span class="lineno" data-linenos="25 "></span><span class="n">end</span>
</code></pre></div>
<div class="codehilite"><pre><span></span><code><span class="lineno" data-linenos=" 1 "></span><span class="c">%% Run pre-processing on each of the movies.</span>
<span class="lineno" data-linenos=" 2 "></span>
<span class="lineno" data-linenos=" 3 "></span><span class="n">procMovieCell</span> <span class="p">=</span> <span class="n">cell</span><span class="p">([</span><span class="mi">1</span> <span class="n">nFolders</span><span class="p">]);</span>
<span class="lineno" data-linenos=" 4 "></span>
<span class="lineno" data-linenos=" 5 "></span><span class="n">for</span> <span class="s">folderNo</span> <span class="s">=</span> <span class="s">1:nFolders</span>
<span class="lineno" data-linenos=" 6 "></span>
<span class="lineno" data-linenos=" 7 "></span>    <span class="n">inputMoviePath</span> <span class="p">=</span> <span class="n">ciapkg</span><span class="p">.</span><span class="n">api</span><span class="p">.</span><span class="n">getFileList</span><span class="p">(</span><span class="n">analysisFolderPath</span><span class="p">,</span><span class="n">rawFileRegexp</span><span class="p">,</span><span class="s">'sortMethod'</span><span class="p">,</span><span class="s">'natural'</span><span class="p">);</span>
<span class="lineno" data-linenos=" 8 "></span>
<span class="lineno" data-linenos=" 9 "></span>    <span class="n">inputMovie</span> <span class="p">=</span> <span class="n">ciapkg</span><span class="p">.</span><span class="n">api</span><span class="p">.</span><span class="n">loadMovieList</span><span class="p">(</span><span class="n">inputMoviePath</span><span class="p">,</span><span class="s">'inputDatasetName'</span><span class="p">,</span><span class="n">inputDatasetName</span><span class="p">,</span><span class="s">'frameList'</span><span class="p">,[]);</span>
<span class="lineno" data-linenos="10 "></span>
<span class="lineno" data-linenos="11 "></span>    <span class="n">procOpts</span><span class="p">.</span><span class="n">motionCorrectionCropCoords</span> <span class="p">=</span> <span class="n">cropCoordsCell</span><span class="p">{</span><span class="n">folderNo</span><span class="p">};</span>
<span class="lineno" data-linenos="12 "></span>
<span class="lineno" data-linenos="13 "></span>    <span class="n">procOpts</span><span class="p">.</span><span class="n">dfofMovie</span> <span class="p">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="lineno" data-linenos="14 "></span>
<span class="lineno" data-linenos="15 "></span>    <span class="n">procOpts</span><span class="p">.</span><span class="n">motionCorrectionFlag</span> <span class="p">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="lineno" data-linenos="16 "></span>
<span class="lineno" data-linenos="17 "></span>    <span class="n">procOpts</span><span class="p">.</span><span class="n">normalizeMovieFlag</span> <span class="p">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="lineno" data-linenos="18 "></span>
<span class="lineno" data-linenos="19 "></span>    <span class="n">procOpts</span><span class="p">.</span><span class="n">normalizeType</span> <span class="p">=</span> <span class="s">'divideByLowpass'</span><span class="p">;</span>
<span class="lineno" data-linenos="20 "></span>
<span class="lineno" data-linenos="21 "></span>    <span class="n">procOpts</span><span class="p">.</span><span class="n">freqLow</span> <span class="p">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="lineno" data-linenos="22 "></span>
<span class="lineno" data-linenos="23 "></span>    <span class="n">procOpts</span><span class="p">.</span><span class="n">freqHigh</span> <span class="p">=</span> <span class="mi">7</span><span class="p">;</span>
<span class="lineno" data-linenos="24 "></span>
<span class="lineno" data-linenos="25 "></span>    <span class="n">procOpts</span><span class="p">.</span><span class="n">downsampleTimeFactor</span> <span class="p">=</span> <span class="mi">4</span><span class="p">;</span>
<span class="lineno" data-linenos="26 "></span>
<span class="lineno" data-linenos="27 "></span>    <span class="n">procMovieCell</span><span class="p">{</span><span class="n">folderNo</span><span class="p">}</span> <span class="p">=</span> <span class="n">ciapkg</span><span class="p">.</span><span class="n">demo</span><span class="p">.</span><span class="n">runPreprocessing</span><span class="p">(</span><span class="n">inputMovie</span><span class="p">,</span><span class="s">'options'</span><span class="p">,</span><span class="n">procOpts</span><span class="p">);</span>
<span class="lineno" data-linenos="28 "></span>
<span class="lineno" data-linenos="29 "></span><span class="n">end</span>
<span class="lineno" data-linenos="30 "></span>
<span class="lineno" data-linenos="31 "></span><span class="s">disp('Done with pre-processing!')</span>
</code></pre></div>
<div class="codehilite"><pre><span></span><code><span class="lineno" data-linenos=" 1 "></span><span class="c">%% Run cell-extraction on the movies</span>
<span class="lineno" data-linenos=" 2 "></span>
<span class="lineno" data-linenos=" 3 "></span><span class="n">pcaicaStructCell</span> <span class="p">=</span> <span class="n">cell</span><span class="p">([</span><span class="mi">1</span> <span class="n">nFolders</span><span class="p">]);</span>
<span class="lineno" data-linenos=" 4 "></span>
<span class="lineno" data-linenos=" 5 "></span><span class="n">nPCs</span> <span class="p">=</span> <span class="mi">300</span><span class="p">;</span>
<span class="lineno" data-linenos=" 6 "></span>
<span class="lineno" data-linenos=" 7 "></span><span class="n">nICs</span> <span class="p">=</span> <span class="mi">225</span><span class="p">;</span>
<span class="lineno" data-linenos=" 8 "></span>
<span class="lineno" data-linenos=" 9 "></span><span class="n">for</span> <span class="s">folderNo</span> <span class="s">=</span> <span class="s">1:nFolders</span>
<span class="lineno" data-linenos="10 "></span>
<span class="lineno" data-linenos="11 "></span>    <span class="n">inputMoviePath</span> <span class="p">=</span> <span class="n">ciapkg</span><span class="p">.</span><span class="n">api</span><span class="p">.</span><span class="n">getFileList</span><span class="p">(</span><span class="n">analysisFolderPath</span><span class="p">,</span><span class="n">rawFileRegexp</span><span class="p">,</span><span class="s">'sortMethod'</span><span class="p">,</span><span class="s">'natural'</span><span class="p">);</span>
<span class="lineno" data-linenos="12 "></span>
<span class="lineno" data-linenos="13 "></span>    <span class="n">pcaicaStruct</span><span class="p">{</span><span class="n">folderNo</span><span class="p">}</span> <span class="p">=</span> <span class="n">ciapkg</span><span class="p">.</span><span class="n">signal_extraction</span><span class="p">.</span><span class="n">runPcaIca</span><span class="p">(</span><span class="n">procMovieCell</span><span class="p">{</span><span class="n">folderNo</span><span class="p">},</span><span class="n">nPCs</span><span class="p">,</span><span class="n">nICs</span><span class="p">,</span><span class="s">'version'</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="s">'outputUnits'</span><span class="p">,</span><span class="s">'fl'</span><span class="p">,</span><span class="s">'mu'</span><span class="p">,</span><span class="mf">0.1</span><span class="p">,</span><span class="s">'term_tol'</span><span class="p">,</span><span class="mf">5e-6</span><span class="p">,</span><span class="s">'max_iter'</span><span class="p">,</span><span class="mf">1e3</span><span class="p">);</span>
<span class="lineno" data-linenos="14 "></span>
<span class="lineno" data-linenos="15 "></span><span class="n">end</span>
<span class="lineno" data-linenos="16 "></span>
<span class="lineno" data-linenos="17 "></span><span class="s">disp('Done with PCA-ICA analysis pre-processing!')</span>
</code></pre></div>
<div class="codehilite"><pre><span></span><code><span class="lineno" data-linenos=" 1 "></span><span class="c">%% Run cross-session alignment of cells</span>
<span class="lineno" data-linenos=" 2 "></span>
<span class="lineno" data-linenos=" 3 "></span><span class="c">% Create input images, cell array of [x y nCells] matrices</span>
<span class="lineno" data-linenos=" 4 "></span>
<span class="lineno" data-linenos=" 5 "></span><span class="n">inputImages</span> <span class="p">=</span> <span class="n">cellfun</span><span class="p">(@(</span><span class="n">x</span><span class="p">)</span> <span class="n">x</span><span class="p">.</span><span class="n">IcaFilters</span><span class="p">,</span><span class="n">pcaicaStruct</span><span class="p">,</span><span class="s">'UniformOutput'</span><span class="p">,</span><span class="n">false</span><span class="p">);</span>
<span class="lineno" data-linenos=" 6 "></span>
<span class="lineno" data-linenos=" 7 "></span>
<span class="lineno" data-linenos=" 8 "></span>
<span class="lineno" data-linenos=" 9 "></span><span class="c">% options to change</span>
<span class="lineno" data-linenos="10 "></span>
<span class="lineno" data-linenos="11 "></span><span class="n">opts</span><span class="p">.</span><span class="n">maxDistance</span> <span class="p">=</span> <span class="mi">5</span><span class="p">;</span> <span class="c">% distance in pixels between centroids for them to be grouped</span>
<span class="lineno" data-linenos="12 "></span>
<span class="lineno" data-linenos="13 "></span><span class="n">opts</span><span class="p">.</span><span class="n">trialToAlign</span> <span class="p">=</span> <span class="mi">1</span><span class="p">;</span> <span class="c">% which session to start alignment on</span>
<span class="lineno" data-linenos="14 "></span>
<span class="lineno" data-linenos="15 "></span><span class="n">opts</span><span class="p">.</span><span class="n">nCorrections</span> <span class="p">=</span> <span class="mi">1</span><span class="p">;</span> <span class="c">%number of rounds to register session cell maps.</span>
<span class="lineno" data-linenos="16 "></span>
<span class="lineno" data-linenos="17 "></span><span class="n">opts</span><span class="p">.</span><span class="n">RegisTypeFinal</span> <span class="p">=</span> <span class="mi">2</span><span class="p">;</span> <span class="c">% 3 = rotation/translation and iso scaling; 2 = rotation/translation, no iso scaling</span>
<span class="lineno" data-linenos="18 "></span>
<span class="lineno" data-linenos="19 "></span>
<span class="lineno" data-linenos="20 "></span>
<span class="lineno" data-linenos="21 "></span><span class="c">% Run alignment code</span>
<span class="lineno" data-linenos="22 "></span>
<span class="lineno" data-linenos="23 "></span><span class="p">[</span><span class="n">alignmentStruct</span><span class="p">]</span> <span class="p">=</span> <span class="n">ciapkg</span><span class="p">.</span><span class="n">api</span><span class="p">.</span><span class="n">matchObjBtwnTrials</span><span class="p">(</span><span class="n">inputImages</span><span class="p">,</span><span class="s">'options'</span><span class="p">,</span><span class="n">opts</span><span class="p">);</span>
<span class="lineno" data-linenos="24 "></span>
<span class="lineno" data-linenos="25 "></span>
<span class="lineno" data-linenos="26 "></span>
<span class="lineno" data-linenos="27 "></span><span class="c">% Global IDs is a matrix of [globalID sessionID]</span>
<span class="lineno" data-linenos="28 "></span>
<span class="lineno" data-linenos="29 "></span><span class="c">% Each (globalID, sessionID) pair gives the within session ID for that particular global ID</span>
<span class="lineno" data-linenos="30 "></span>
<span class="lineno" data-linenos="31 "></span><span class="n">globalIDs</span> <span class="p">=</span> <span class="n">alignmentStruct</span><span class="p">.</span><span class="n">globalIDs</span><span class="p">;</span>
<span class="lineno" data-linenos="32 "></span>
<span class="lineno" data-linenos="33 "></span>
<span class="lineno" data-linenos="34 "></span>
<span class="lineno" data-linenos="35 "></span><span class="c">% View the cross-session matched cells, saved to `private\_tmpFiles` sub-folder.</span>
<span class="lineno" data-linenos="36 "></span>
<span class="lineno" data-linenos="37 "></span><span class="p">[</span><span class="n">success</span><span class="p">]</span> <span class="p">=</span> <span class="n">ciapkg</span><span class="p">.</span><span class="n">api</span><span class="p">.</span><span class="n">createMatchObjBtwnTrialsMaps</span><span class="p">(</span><span class="n">inputImages</span><span class="p">,</span><span class="n">alignmentStruct</span><span class="p">);</span>
</code></pre></div>
<div class="codehilite"><pre><span></span><code><span class="lineno" data-linenos="1 "></span><span class="c">%% Display cross-session matching movies</span>
<span class="lineno" data-linenos="2 "></span>
<span class="lineno" data-linenos="3 "></span><span class="nb">disp</span><span class="p">(</span><span class="s">'Playing movie frames'</span><span class="p">)</span>
<span class="lineno" data-linenos="4 "></span>
<span class="lineno" data-linenos="5 "></span><span class="n">crossSessionMovie1</span> <span class="p">=</span> <span class="p">[</span><span class="n">ciapkg</span><span class="p">.</span><span class="n">getDir</span> <span class="n">filesep</span> <span class="s">'private'</span> <span class="n">filesep</span> <span class="s">'_tmpFiles'</span> <span class="n">filesep</span> <span class="s">'matchObjColorMap50percentMatchedSession_matchedCells.avi'</span><span class="p">];</span>
<span class="lineno" data-linenos="6 "></span>
<span class="lineno" data-linenos="7 "></span><span class="n">crossSessionMovie2</span> <span class="p">=</span> <span class="p">[</span><span class="n">ciapkg</span><span class="p">.</span><span class="n">getDir</span> <span class="n">filesep</span> <span class="s">'private'</span> <span class="n">filesep</span> <span class="s">'_tmpFiles'</span> <span class="n">filesep</span> <span class="s">'matchObjColorMapAllMatchedSession_matchedCells.avi'</span><span class="p">];</span>
<span class="lineno" data-linenos="8 "></span>
<span class="lineno" data-linenos="9 "></span><span class="n">ciapkg</span><span class="p">.</span><span class="n">api</span><span class="p">.</span><span class="n">playMovie</span><span class="p">(</span><span class="n">crossSessionMovie1</span><span class="p">,</span><span class="s">'extraMovie'</span><span class="p">,</span><span class="n">crossSessionMovie2</span><span class="p">,</span><span class="s">'rgbDisplay'</span><span class="p">,</span><span class="mi">1</span><span class="p">);</span>
</code></pre></div>
<h2 id="sitename-functions-within-codepackage-sub-package"><code>CIAtah</code> functions within <code>{{ code.package }}</code> sub-package.<a class="headerlink" href="#sitename-functions-within-codepackage-sub-package" title="Permanent link">¶</a></h2>
<p><code>CIAtah</code> contains many functions for imaging analysis, from processing videos to wrappers for running cell extraction algorithms and GUIs for visualizing movies and evaluating cell extraction outputs. Several are detailed below. For each users can visualize options with <code>help FUN</code> or <code>edit FUN</code>. If attempting to load a non-package function (e.g. it does not start with <code>{{ code.package }}</code>), then append <code>{{ code.package }}.api.</code>, e.g. <code>playMovie</code> would become <code>{{ code.package }}.api.playMovie</code>. Alternatively, load all the functions into the workspace with <code>import ciapkg.api.*</code>.</p>
<p>This page will be further updated with information soon.</p>
<h3 id="visualizing-movies">Visualizing movies<a class="headerlink" href="#visualizing-movies" title="Permanent link">¶</a></h3>
<p><code>playMovie</code></p>
<p><code>ciapkg.io.loadMovie</code> or <code>loadMovieList</code></p>
<p><code>createImageOutlineOnMovie</code></p>
<p><code>createSignalBasedMovie</code></p>
<p><code>ciapkg.io.readFrame</code></p>
<h3 id="get-movie-information">Get movie information<a class="headerlink" href="#get-movie-information" title="Permanent link">¶</a></h3>
<p><code>ciapkg.io.getMovieInfo</code></p>
<h3 id="sorting-cells">Sorting cells<a class="headerlink" href="#sorting-cells" title="Permanent link">¶</a></h3>
<p><code>signalSorter</code></p>
<h3 id="pre-processing">Pre-processing<a class="headerlink" href="#pre-processing" title="Permanent link">¶</a></h3>
<p><code>ciapkg.demo.runPreprocessing</code></p>
<p><code>downsampleHdf5Movie</code></p>
<p><code>removeStripsFromMovie</code></p>
<p><code>turboregMovie</code></p>
<p><code>dfofMovie</code></p>
<p><code>downsampleMovie</code></p>
<p><code>normalizeMovie</code></p>
<h3 id="cell-extraction">Cell extraction<a class="headerlink" href="#cell-extraction" title="Permanent link">¶</a></h3>
<ul>
<li><em>PCA-ICA</em> - <code>ciapkg.signal_extraction.runPcaIca</code>.</li>
</ul>
<!-- - _CNMF_ - ``.

- _CNMF-E_ - ``.

- _EXTRACT_ - ``.

- _ROI_ - ``. -->
<h3 id="cross-session-alignment">Cross-session alignment<a class="headerlink" href="#cross-session-alignment" title="Permanent link">¶</a></h3>
<p><code>matchObjBtwnTrials</code></p>
<p><code>createMatchObjBtwnTrialsMaps</code></p>
<h2 id="help"><div class="subsection1"><em>â€”Helpâ€”</em></div><a class="headerlink" href="#help" title="Permanent link">¶</a></h2>
<h2 id="common-issues-and-fixes">Common issues and fixes<a class="headerlink" href="#common-issues-and-fixes" title="Permanent link">¶</a></h2>
<p>Page outlines some common issues and fixes to them that may be encountered while using <code>CIAtah</code>. These are mostly due to quirks specific to MATLAB, Fiji, or the computing environment <code>CIAtah</code> is used on.</p>
<hr/>
<h3 id="contents">Contents<a class="headerlink" href="#contents" title="Permanent link">¶</a></h3>
<ul>
<li><a href="#pca-ica-cnmf-e-or-other-cell-extraction-algorithms-dont-produce-sensible-output">PCA-ICA, CNMF-E, or other cell extraction algorithm's don't produce sensible output.</a></li>
</ul>
<ul>
<li><a href="#out-of-memory-using-miji">Out of memory using Miji</a></li>
</ul>
<ul>
<li><a href="#selecting-scripts-folder-in-fijiapp-on-mac-os-x">Selecting scripts folder in Fiji.app on Mac OS X</a></li>
</ul>
<ul>
<li><a href="#fiji-wont-start-using-miji-or-mijstart">Fiji won't start using Miji or MIJ.start</a></li>
</ul>
<ul>
<li><a href="#downloadcnmfgithubrepositoriesm-not-downloading-correctly">downloadCnmfGithubRepositories.m not downloading correctly</a></li>
</ul>
<ul>
<li><a href="#modelpreprocessmovie-analysis-options-list-not-showing">modelPreprocessMovie analysis options list not showing</a></li>
</ul>
<ul>
<li><a href="#miji-not-loading-correctly">Miji not loading correctly</a></li>
</ul>
<ul>
<li><a href="#viewmovie-or-other-functions-where-movies-need-to-be-loaded-end-without-executing">viewMovie or other functions where movies need to be loaded end without executing</a></li>
</ul>
<ul>
<li><a href="#contrast-is-low-on-cell-transient-Î”ff-movies-using-computemanualsortsignals">Contrast is low on cell transient Î”F/F movies using computeManualSortSignals</a></li>
</ul>
<ul>
<li>
<p><a href="#traces-in-computemanualsortsignals-gui-are-flat">Traces in computeManualSortSignals GUI are flat.</a></p>
<ul>
<li><a href="#cant-see-transients">Can't see transients.</a></li>
</ul>
<ul>
<li><a href="#change-the-minmax">Change the min/max.</a></li>
</ul>
<ul>
<li><a href="#can-now-see-transients">Can now see transients.</a></li>
</ul>
</li>
</ul>
<ul>
<li><a href="#blank-frames-or-entire-frames-have-baseline-shifted-after-motion-correction-in-modelpreprocessmovie">Blank frames or entire frames have baseline shifted after motion correction in modelPreprocessMovie</a></li>
</ul>
<ul>
<li><a href="#file-or-folder-dialog-box-with-no-instructions">File or folder dialog box with no instructions</a></li>
</ul>
<hr/>
<h3 id="error-opening-avi-or-other-files-due-to-codec-issues">Error opening AVI or other files due to codec issues<a class="headerlink" href="#error-opening-avi-or-other-files-due-to-codec-issues" title="Permanent link">¶</a></h3>
<p>If run into issues opening certain AVI files (e.g. due to codec issues) with CIAtah/MATLAB:</p>
<div class="codehilite"><pre><span></span><code><span class="lineno" data-linenos=" 1 "></span><span class="n">Error</span> <span class="s">using</span> <span class="s">VideoReader/initReader</span> <span class="s">(line</span> <span class="s">734)</span>
<span class="lineno" data-linenos=" 2 "></span>
<span class="lineno" data-linenos=" 3 "></span><span class="n">Unable</span> <span class="s">to</span> <span class="s">determine</span> <span class="s">the</span> <span class="s">required</span> <span class="s">codec.</span>
<span class="lineno" data-linenos=" 4 "></span>
<span class="lineno" data-linenos=" 5 "></span>
<span class="lineno" data-linenos=" 6 "></span>
<span class="lineno" data-linenos=" 7 "></span><span class="n">Error</span> <span class="s">in</span> <span class="s">audiovideo.internal.IVideoReader</span> <span class="s">(line</span> <span class="s">136)</span>
<span class="lineno" data-linenos=" 8 "></span>
<span class="lineno" data-linenos=" 9 "></span>            <span class="n">initReader</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">fileName</span><span class="p">,</span> <span class="n">currentTime</span><span class="p">);</span>
<span class="lineno" data-linenos="10 "></span>
<span class="lineno" data-linenos="11 "></span>
<span class="lineno" data-linenos="12 "></span>
<span class="lineno" data-linenos="13 "></span><span class="n">Error</span> <span class="s">in</span> <span class="s">VideoReader</span> <span class="s">(line</span> <span class="s">104)</span>
<span class="lineno" data-linenos="14 "></span>
<span class="lineno" data-linenos="15 "></span>            <span class="n">obj</span><span class="p">@</span><span class="n">audiovideo</span><span class="p">.</span><span class="n">internal</span><span class="p">.</span><span class="n">IVideoReader</span><span class="p">(</span><span class="n">varargin</span><span class="p">{:});</span>
</code></pre></div>
<p>, install <code>K-Lite Codec Pack</code> (<a href="https://codecguide.com/download_kl.htm">https://codecguide.com/download_kl.htm</a>) or similar for added support.</p>
<h3 id="pca-ica-cnmf-e-or-other-cell-extraction-algorithms-dont-produce-sensible-output">PCA-ICA, CNMF-E, or other cell extraction algorithm's don't produce sensible output.<a class="headerlink" href="#pca-ica-cnmf-e-or-other-cell-extraction-algorithms-dont-produce-sensible-output" title="Permanent link">¶</a></h3>
<ul>
<li>When running <code>modelPreprocessMovie</code> a dialog box appears showing the available analysis steps. Certain combinations of these steps make sense while others should be avoided.</li>
</ul>
<ul>
<li>For example, normally users want <code>turboreg-&gt;crop-&gt;dfof-&gt;downsampleTime</code>.</li>
</ul>
<ul>
<li>An invalid input would be <code>turboreg-&gt;crop-&gt;dfof-&gt;dfstd-&gt;downsampleTime</code>. Since calculating the dF/F then dF/std is problematic.</li>
</ul>
<ul>
<li>For two photon data, it is sometimes desired to have <code>medianFilter-&gt;turboreg-&gt;crop-&gt;dfstd (or dfof)-&gt;downsampleTime</code>.</li>
</ul>
<ul>
<li>In general, <code>fft_highpass</code> and <code>fft_lowpass</code> should be avoided since they are meant to be run on stand-alone movies for specific purposes rather than included in the general pipeline.</li>
</ul>
<p><img alt="image" src="https://user-images.githubusercontent.com/5241605/51938177-54cea580-23c1-11e9-9d5d-2e7cf6170c5b.png"/></p>
<ul>
<li>Remember at the options screen (see below) to select a spatial filtering there under the option <code>filterBeforeRegister</code> instead of selecting the <code>spatialFilter</code> option before the <code>turboreg</code> option in the analysis steps screen.</li>
</ul>
<p><img alt="image" src="https://user-images.githubusercontent.com/5241605/51938312-9fe8b880-23c1-11e9-9592-54d29160f8e6.png"/></p>
<h3 id="out-of-memory-using-miji">Out of memory using <code>Miji</code><a class="headerlink" href="#out-of-memory-using-miji" title="Permanent link">¶</a></h3>
<ul>
<li>If you get a <code>java.lang.OutOfMemoryError: GC overhead limit exceeded</code> style error (see below code) when trying to open a movie with <code>Miji</code>, make sure that you initialize MATLAB in the <code>CIAtah</code> path or place the <code>java.opts</code> file in your MATLAB start-up folder.</li>
</ul>
<div class="codehilite"><pre><span></span><code><span class="lineno" data-linenos="1 "></span><span class="n">java</span><span class="p">.</span><span class="n">lang</span><span class="p">.</span><span class="n">OutOfMemoryError</span><span class="p">:</span> <span class="n">GC</span> <span class="n">overhead</span> <span class="n">limit</span> <span class="n">exceeded</span>
<span class="lineno" data-linenos="2 "></span>
<span class="lineno" data-linenos="3 "></span>    <span class="n">at</span> <span class="s">java.lang.AbstractStringBuilder.&lt;init&gt;(Unknown</span> <span class="s">Source)</span>
<span class="lineno" data-linenos="4 "></span>
<span class="lineno" data-linenos="5 "></span>    <span class="n">at</span> <span class="s">java.lang.StringBuilder.&lt;init&gt;(Unknown</span> <span class="s">Source)</span>
</code></pre></div>
<ul>
<li>On Windows, you can change the start-up folder as below or in general see <a href="https://www.mathworks.com/help/matlab/matlab_env/matlab-startup-folder.html">https://www.mathworks.com/help/matlab/matlab_env/matlab-startup-folder.html</a>.</li>
</ul>
<p><img alt="image" src="https://user-images.githubusercontent.com/5241605/64047075-94f63200-cb22-11e9-890b-6b43db669412.png"/></p>
<ul>
<li><code>java.opts</code> increases the amount of memory allocated so that Java doesn't run out when using Miji to load movies. To change the amount of memory allocated (CIAtah sets to 7 Gb by default), change the below to a higher or lower number, e.g. 9 Gb would be <code>-Xmx9000m</code>.</li>
</ul>
<div class="codehilite"><pre><span></span><code><span class="lineno" data-linenos="1 "></span><span class="o">-</span><span class="n">Xmx7000m</span>
</code></pre></div>
<h3 id="selecting-scripts-folder-in-fijiapp-on-mac-os-x">Selecting <code>scripts</code> folder in <code>Fiji.app</code> on Mac OS X<a class="headerlink" href="#selecting-scripts-folder-in-fijiapp-on-mac-os-x" title="Permanent link">¶</a></h3>
<p>Navigate to the applications folder and select <code>Fiji.app</code> and <code>Show Package Contents</code>.</p>
<p><img alt="screen shot 2019-02-12 at 6 46 45 pm" src="https://user-images.githubusercontent.com/5241605/52684369-e2021600-2efa-11e9-90ec-83d861841182.png"/></p>
<p>Then navigate to <code>/Fiji.app/scripts</code> and select <code>Miji.m</code> then <code>Get Info</code>. Select and copy the path as below.</p>
<p><img alt="screen shot 2019-02-12 at 6 49 11 pm" src="https://user-images.githubusercontent.com/5241605/52684378-e4fd0680-2efa-11e9-9240-825f5d7824af.png"/></p>
<p>When Matlab ask for the Fiji path, press <code>command + shift + G</code> in the dialog box to enter the full path manually, press enter, then select open.</p>
<p><img alt="screen shot 2019-02-12 at 6 52 42 pm" src="https://user-images.githubusercontent.com/5241605/52684381-ea5a5100-2efa-11e9-9652-30f7b220117c.png"/></p>
<h3 id="fiji-wont-start-using-miji-or-mijstart">Fiji won't start using <code>Miji</code> or <code>MIJ.start</code><a class="headerlink" href="#fiji-wont-start-using-miji-or-mijstart" title="Permanent link">¶</a></h3>
<ul>
<li>If calling <code>Miji</code> or <code>MIJ.start</code> does not lead to a Fiji GUI appearing (e.g. the below output is seen in the command window), this is likely because the last Fiji/ImageJ instance was closed improperly (e.g. by closing ImageJ with <code>File-&gt;Quit</code> or pressing the close button instead of <code>MIJ.exit</code> in the Matlab command window), leading to a headless Fiji that cannot be properly closed by Miji/Matlab.</li>
</ul>
<div class="codehilite"><pre><span></span><code><span class="lineno" data-linenos="1 "></span><span class="o">--------------------------------------------------------------</span>
<span class="lineno" data-linenos="2 "></span>
<span class="lineno" data-linenos="3 "></span><span class="n">Status</span><span class="o">&gt;</span> <span class="n">ImageJ</span> <span class="n">is</span> <span class="n">already</span> <span class="n">started</span><span class="p">.</span>
<span class="lineno" data-linenos="4 "></span>
<span class="lineno" data-linenos="5 "></span><span class="o">--------------------------------------------------------------</span>
</code></pre></div>
<p>If this occurs, run the following commands one at a time:</p>
<div class="codehilite"><pre><span></span><code><span class="lineno" data-linenos="1 "></span><span class="n">resetMiji</span>
<span class="lineno" data-linenos="2 "></span>
<span class="lineno" data-linenos="3 "></span><span class="s">%</span> <span class="s">An</span> <span class="s">instance</span> <span class="s">of</span> <span class="s">Miji</span> <span class="s">should</span> <span class="s">appear.</span>
<span class="lineno" data-linenos="4 "></span>
<span class="lineno" data-linenos="5 "></span><span class="n">currP</span><span class="p">=</span><span class="n">pwd</span><span class="p">;</span><span class="n">Miji</span><span class="p">;</span><span class="n">cd</span><span class="p">(</span><span class="n">currP</span><span class="p">);</span>
<span class="lineno" data-linenos="6 "></span>
<span class="lineno" data-linenos="7 "></span><span class="n">MIJ</span><span class="p">.</span><span class="n">exit</span>
</code></pre></div>
<h3 id="downloadcnmfgithubrepositoriesm-not-downloading-correctly"><code>downloadCnmfGithubRepositories.m</code> not downloading correctly<a class="headerlink" href="#downloadcnmfgithubrepositoriesm-not-downloading-correctly" title="Permanent link">¶</a></h3>
<ul>
<li>If when trying to download using <code>downloadCnmfGithubRepositories.m</code> the below error is encountered, try to run <code>downloadCnmfGithubRepositories</code> several more times as <code>websave</code> (MATLAB built-in function) sometimes momentarily does not obtain the correct write permissions and fails.</li>
</ul>
<div class="codehilite"><pre><span></span><code><span class="lineno" data-linenos="1 "></span><span class="p">@@@@@@@</span>
<span class="lineno" data-linenos="2 "></span>
<span class="lineno" data-linenos="3 "></span><span class="n">Error</span> <span class="s">using</span> <span class="s">websave</span> <span class="s">(line</span> <span class="s">104)</span>
<span class="lineno" data-linenos="4 "></span>
<span class="lineno" data-linenos="5 "></span><span class="n">Unable</span> <span class="s">to</span> <span class="s">open</span> <span class="s">output</span> <span class="s">file:</span> <span class="s">'signal_extraction\cnmfe.zip'</span> <span class="s">for</span> <span class="s">writing.</span> <span class="s">Common</span> <span class="s">reasons</span> <span class="s">include</span> <span class="s">that</span> <span class="s">the</span> <span class="s">file</span> <span class="s">exists</span> <span class="s">and</span> <span class="s">does</span> <span class="s">not</span> <span class="s">have</span> <span class="s">write</span> <span class="s">permission</span> <span class="s">or</span> <span class="s">the</span> <span class="s">folder</span> <span class="s">does</span> <span class="s">not</span> <span class="s">have</span> <span class="s">write</span> <span class="s">permissions.</span>
</code></pre></div>
<h3 id="modelpreprocessmovie-analysis-options-list-not-showing"><code>modelPreprocessMovie</code> analysis options list not showing<a class="headerlink" href="#modelpreprocessmovie-analysis-options-list-not-showing" title="Permanent link">¶</a></h3>
<ul>
<li>MATLAB changed <code>uitables</code> internal implementation, hence <code>findjobj</code> (File Exchange function) broke causing <code>reorderableListbox</code> (File Exchange function) to also break. An updated <code>findjobj</code> has been added to the <code>CIAtah</code> repository and this error (see below) should no longer occur.</li>
</ul>
<div class="codehilite"><pre><span></span><code><span class="lineno" data-linenos="1 "></span><span class="n">Error</span> <span class="s">in</span> <span class="s">reorderableListbox</span> <span class="s">(line</span> <span class="s">127)</span>
<span class="lineno" data-linenos="2 "></span>
<span class="lineno" data-linenos="3 "></span><span class="n">jScrollPane</span> <span class="p">=</span> <span class="n">jScrollPane</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
</code></pre></div>
<h3 id="miji-not-loading-correctly"><code>Miji</code> not loading correctly<a class="headerlink" href="#miji-not-loading-correctly" title="Permanent link">¶</a></h3>
<ul>
<li>The below error occurs when the wrong version of <code>Fiji</code> is downloaded. Please <strong>2015 December 22</strong> version download from <a href="https://imagej.net/Fiji/Downloads">https://imagej.net/Fiji/Downloads</a> as that implementation of <code>Miji.m</code> appears to work correctly with MATLAB.</li>
</ul>
<div class="codehilite"><pre><span></span><code><span class="lineno" data-linenos="1 "></span><span class="p">@@@@@@@</span>
<span class="lineno" data-linenos="2 "></span>
<span class="lineno" data-linenos="3 "></span><span class="n">Error</span> <span class="s">using</span> <span class="s">javaObject</span>
<span class="lineno" data-linenos="4 "></span>
<span class="lineno" data-linenos="5 "></span><span class="n">No</span> <span class="s">class</span> <span class="s">MIJ</span> <span class="s">can</span> <span class="s">be</span> <span class="s">located</span> <span class="s">on</span> <span class="s">the</span> <span class="s">Java</span> <span class="s">class</span> <span class="s">path</span>
</code></pre></div>
<h3 id="viewmovie-or-other-functions-where-movies-need-to-be-loaded-end-without-executing"><code>viewMovie</code> or other functions where movies need to be loaded end without executing<a class="headerlink" href="#viewmovie-or-other-functions-where-movies-need-to-be-loaded-end-without-executing" title="Permanent link">¶</a></h3>
<ul>
<li>It is likely that the regular expression given to <code>CIAtah</code> does not match any of the files in the folder being analyzed.</li>
</ul>
<ul>
<li>For example, in <code>viewMovie</code>, the below <code>Image movie regexp</code> setting should be changed to <code>concat</code> correspond to the demo raw imaging data's name.</li>
</ul>
<p><img alt="image" src="https://user-images.githubusercontent.com/5241605/51725501-63ab0600-2017-11e9-94e3-182fcd55fa22.png"/></p>
<h3 id="contrast-is-low-on-cell-transient-ff-movies-using-computemanualsortsignals">Contrast is low on cell transient Î”F/F movies using <code>computeManualSortSignals</code><a class="headerlink" href="#contrast-is-low-on-cell-transient-ff-movies-using-computemanualsortsignals" title="Permanent link">¶</a></h3>
<ul>
<li>The contrast (e.g. min/max) are estimated automatically from movie data, but will not always be the optimal display for manual human sorting of data. To improve the contrast, press <code>q</code> while in the interface and adjust the min/max values until you are in a satisfactory range. See below.</li>
</ul>
<p>Default contrast:</p>
<p><img alt="image" src="https://user-images.githubusercontent.com/5241605/51729221-9e1c9f00-2027-11e9-9b78-1a49420b717a.png"/></p>
<p>Contrast after user editing:</p>
<p><img alt="image" src="https://user-images.githubusercontent.com/5241605/51729256-c0162180-2027-11e9-9966-605d114591d0.png"/></p>
<h3 id="traces-in-computemanualsortsignals-gui-are-flat">Traces in <code>computeManualSortSignals</code> GUI are flat.<a class="headerlink" href="#traces-in-computemanualsortsignals-gui-are-flat" title="Permanent link">¶</a></h3>
<ul>
<li>Likely this is due to one of the traces having values that are very high, throwing off the estimate used set the y-axis in the GUI (which is constant across all candidate cells). This can be changed by pressing <code>w</code>, see below.</li>
</ul>
<h4 id="cant-see-transients">Can't see transients.<a class="headerlink" href="#cant-see-transients" title="Permanent link">¶</a></h4>
<p><img alt="image" src="https://user-images.githubusercontent.com/5241605/51950315-d84dbe00-23e4-11e9-9a5d-5d34e7c6ed39.png"/></p>
<h4 id="change-the-minmax">Change the min/max.<a class="headerlink" href="#change-the-minmax" title="Permanent link">¶</a></h4>
<p><img alt="image" src="https://user-images.githubusercontent.com/5241605/51950356-07fcc600-23e5-11e9-9166-71282d774cea.png"/></p>
<h4 id="can-now-see-transients">Can now see transients.<a class="headerlink" href="#can-now-see-transients" title="Permanent link">¶</a></h4>
<p><img alt="image" src="https://user-images.githubusercontent.com/5241605/51950282-bb18ef80-23e4-11e9-8c52-5649175fb0fb.png"/></p>
<h3 id="blank-frames-or-entire-frames-have-baseline-shifted-after-motion-correction-in-modelpreprocessmovie">Blank frames or entire frames have baseline shifted after motion correction in <code>modelPreprocessMovie</code><a class="headerlink" href="#blank-frames-or-entire-frames-have-baseline-shifted-after-motion-correction-in-modelpreprocessmovie" title="Permanent link">¶</a></h3>
<ul>
<li>This normally occurs when <code>transfturboreg</code> is selected as the <code>registrationFxn</code>, in some Windows editions and OSX versions this leads to random baseline shifts. If this occurs change <code>registrationFxn</code> to <code>imtransform</code>. See below (green selected option).</li>
</ul>
<p><img alt="image" src="https://user-images.githubusercontent.com/5241605/51861116-3f3d7b00-22f0-11e9-8998-3a3224152214.png"/></p>
<h3 id="file-or-folder-dialog-box-with-no-instructions">File or folder dialog box with no instructions<a class="headerlink" href="#file-or-folder-dialog-box-with-no-instructions" title="Permanent link">¶</a></h3>
<ul>
<li>This is mainly on <code>OS X</code>, where in some versions the dialog boxes are not styled with title bars (see below). This is outside of MATLAB's control. If this occurs, check the command window as the instructions should also be provided there (e.g. with <code>Dialog box: [TITLE]</code> style text).</li>
</ul>
<p><img alt="image" src="https://user-images.githubusercontent.com/5241605/51950743-8d34aa80-23e6-11e9-892a-1138ace4f655.png"/></p>
<h2 id="inscopix">Inscopix<a class="headerlink" href="#inscopix" title="Permanent link">¶</a></h2>
<p>Documentation related to Inscopix-specific functions on the repository.</p>
<h3 id="visualizing-isxd-files">Visualizing ISXD files<a class="headerlink" href="#visualizing-isxd-files" title="Permanent link">¶</a></h3>
<p>ISXD files can be directly visualized from disk by running <code>playMovie</code> from MATLAB command line:</p>
<div class="codehilite"><pre><span></span><code><span class="lineno" data-linenos="1 "></span><span class="n">playMovie</span><span class="p">(</span><span class="s">'path\to\youMovie.isxd'</span><span class="p">);</span>
</code></pre></div>
<h3 id="converting-isxd-files-to-hdf5">Converting ISXD files to HDF5<a class="headerlink" href="#converting-isxd-files-to-hdf5" title="Permanent link">¶</a></h3>
<p>To convert ISXD files to HDF5, see <code>convertInscopixIsxdToHdf5</code> function in the <code>inscopix</code> folder or <code>modelDownsampleRawMovies</code> module in CIAtah.</p>
<p><strong>Note</strong>: By default the Inscopix API gives out a frame full of 0s for dropped frames. So those 0s frames are maintained after converting/downsampling to HDF5 or you will also get a frame with 0s if you use <code>loadMovieList</code> to read frames that were dropped from isxd files. Adjust analysis accordingly.</p>
<p>To use this function call it as below:</p>
<div class="codehilite"><pre><span></span><code><span class="lineno" data-linenos="1 "></span><span class="n">moviePath</span> <span class="p">=</span> <span class="s">'PATH_TO_ISXD'</span><span class="p">;</span>
<span class="lineno" data-linenos="2 "></span>
<span class="lineno" data-linenos="3 "></span><span class="n">opts</span><span class="p">.</span><span class="n">maxChunkSize</span> <span class="p">=</span> <span class="mi">5000</span><span class="p">;</span> <span class="c">% Max chunk size in Mb to load into RAM.</span>
<span class="lineno" data-linenos="4 "></span>
<span class="lineno" data-linenos="5 "></span><span class="n">opts</span><span class="p">.</span><span class="n">downsampleFactor</span> <span class="p">=</span> <span class="mi">4</span><span class="p">;</span> <span class="c">% How much to downsample original movie, set to 1 for no downsampling.</span>
<span class="lineno" data-linenos="6 "></span>
<span class="lineno" data-linenos="7 "></span><span class="n">convertInscopixIsxdToHdf5</span><span class="p">(</span><span class="n">moviePath</span><span class="p">,</span><span class="s">'options'</span><span class="p">,</span><span class="n">opts</span><span class="p">);</span>
</code></pre></div>
<p>If you want to save to a custom folder, use <code>saveFolder</code> input.</p>
<div class="codehilite"><pre><span></span><code><span class="lineno" data-linenos="1 "></span><span class="n">moviePath</span> <span class="p">=</span> <span class="s">'PATH_TO_ISXD'</span><span class="p">;</span>
<span class="lineno" data-linenos="2 "></span>
<span class="lineno" data-linenos="3 "></span><span class="n">opts</span><span class="p">.</span><span class="n">maxChunkSize</span> <span class="p">=</span> <span class="mi">5000</span><span class="p">;</span> <span class="c">% Max chunk size in Mb to load into RAM.</span>
<span class="lineno" data-linenos="4 "></span>
<span class="lineno" data-linenos="5 "></span><span class="n">opts</span><span class="p">.</span><span class="n">downsampleFactor</span> <span class="p">=</span> <span class="mi">4</span><span class="p">;</span> <span class="c">% How much to downsample original movie, set to 1 for no downsampling.</span>
<span class="lineno" data-linenos="6 "></span>
<span class="lineno" data-linenos="7 "></span><span class="n">opts</span><span class="p">.</span><span class="n">saveFolder</span> <span class="p">=</span> <span class="s">'ALT_FOLDER_PATH'</span><span class="p">;</span> <span class="c">% Char: alternative file path</span>
<span class="lineno" data-linenos="8 "></span>
<span class="lineno" data-linenos="9 "></span><span class="n">convertInscopixIsxdToHdf5</span><span class="p">(</span><span class="n">moviePath</span><span class="p">,</span><span class="s">'options'</span><span class="p">,</span><span class="n">opts</span><span class="p">);</span>
</code></pre></div>
<p>The same functionality can be achieved by loading a <code>CIAtah</code> module using the below commands. By default <code>modelDownsampleRawMovies</code> module will see <code>.isxd</code> files and call <code>convertInscopixIsxdToHdf5</code>. This can be done on multiple folders by separating them with commas in the <code>modelDownsampleRawMovies</code> menu.</p>
<div class="codehilite"><pre><span></span><code><span class="lineno" data-linenos="1 "></span><span class="n">obj</span> <span class="p">=</span> <span class="p">ciatah;</span>
<span class="lineno" data-linenos="2 "></span>
<span class="lineno" data-linenos="3 "></span><span class="n">obj</span><span class="p">.</span><span class="n">modelDownsampleRawMovies</span><span class="p">;</span>
</code></pre></div>
<h2 id="neurodata-without-borders-nwb">Neurodata Without Borders (NWB)<a class="headerlink" href="#neurodata-without-borders-nwb" title="Permanent link">¶</a></h2>
<p>NWB is a data standard</p>
<p>Some movies are larger than the available RAM on users analysis computer. Below are several ways that the underlying functions in <code>CIAPKG</code> can be used to analyze large movies.</p>
<p><a href="https://neurodatawithoutborders.github.io/matnwb/tutorials/html/ophys.html">https://neurodatawithoutborders.github.io/matnwb/tutorials/html/ophys.html</a></p>
<h3 id="saving-nwb">Saving NWB<a class="headerlink" href="#saving-nwb" title="Permanent link">¶</a></h3>
<div class="codehilite"><pre><span></span><code><span class="lineno" data-linenos="1 "></span><span class="c">% Full path to the movie</span>
<span class="lineno" data-linenos="2 "></span>
<span class="lineno" data-linenos="3 "></span><span class="n">saveNeurodataWithoutBorders</span><span class="p">(</span><span class="n">cellExtractionImages</span><span class="p">,{</span><span class="n">cellExtractionSignals</span><span class="p">},</span><span class="n">cellExtractionAlgorithm</span><span class="p">,</span><span class="n">nwbFilePath</span><span class="p">);</span>
</code></pre></div>
<p>Where <code>cellExtractionAlgorithm</code> is the algorithm used, consisting of:</p>
<ul>
<li></li>
</ul>
<h3 id="loading-nwb">Loading NWB<a class="headerlink" href="#loading-nwb" title="Permanent link">¶</a></h3>
<div class="codehilite"><pre><span></span><code><span class="lineno" data-linenos="1 "></span><span class="c">% Full path to the movie</span>
<span class="lineno" data-linenos="2 "></span>
<span class="lineno" data-linenos="3 "></span><span class="p">[</span><span class="n">inputImages</span><span class="p">,</span><span class="n">inputTraces</span><span class="p">,</span><span class="n">infoStruct</span><span class="p">,</span> <span class="n">algorithmStr</span><span class="p">]</span> <span class="p">=</span> <span class="n">loadNeurodataWithoutBorders</span><span class="p">(</span><span class="n">nwbFilePath</span><span class="p">);</span>
</code></pre></div>
<p>Outputs mean:</p>
<ul>
<li><code>inputImages</code> - 3D or 4D matrix containing cells and their spatial information.</li>
</ul>
<ul>
<li><code>inputTraces</code> - 2D matrix containing trace outputs.</li>
</ul>
<ul>
<li><code>infoStruct</code> - contains information about the file, e.g. the 'description' property that can contain information about the algorithm.</li>
</ul>
<ul>
<li><code>algorithmStr</code> - String of the algorithm name.</li>
</ul>
<h3 id="using-nwb-with-signalsorter">Using NWB with <code>signalSorter</code><a class="headerlink" href="#using-nwb-with-signalsorter" title="Permanent link">¶</a></h3>
<p>For manual sorting, users can directly input path to NWB file as below:</p>
<div class="codehilite"><pre><span></span><code><span class="lineno" data-linenos="1 "></span><span class="p">[</span><span class="n">outImages</span><span class="p">,</span> <span class="n">outSignals</span><span class="p">,</span> <span class="n">choices</span><span class="p">]</span> <span class="p">=</span> <span class="n">signalSorter</span><span class="p">(</span><span class="s">'pcaica.nwb'</span><span class="p">,[],</span><span class="s">'inputMovie'</span><span class="p">,</span><span class="n">inputMoviePath</span><span class="p">);</span>
</code></pre></div>
<h2 id="interpreting-displayed-movies">Interpreting displayed movies<a class="headerlink" href="#interpreting-displayed-movies" title="Permanent link">¶</a></h2>
<p>It may appear at times that <code>CIAtah</code> has introduced noise into movies after processing. However, normally that noise is already there in the movie. In the case of one-photon miniature microscope movies that noise is often small relative to the baseline background fluorescence, hence not noticeable. However, after dF/F0 or spatial filtering users will be able to see the noise more easily as it will have a relatively greater magnitude compared to the signal now present in the movie.</p>
<p>Further, in many cases the contrast is automatically adjusted in <code>CIAtah</code> GUIs to boost likelihood users will see cells and other biologically relevant features (even though underlying matrix values are not changed), which can sometimes lead to the perception that noise is being added depending on viewing raw vs. dF/F0 or other preprocessed movies.</p>
<h3 id="example">Example<a class="headerlink" href="#example" title="Permanent link">¶</a></h3>
<p>For example of what this looks like, take one of the example movies in the CIAtah repository: <code>2014_04_01_p203_m19_check01</code>.</p>
<h4 id="raw-movie">Raw movie<a class="headerlink" href="#raw-movie" title="Permanent link">¶</a></h4>
<p>A frame from the raw movie looks like:</p>
<p><img alt="image" src="https://user-images.githubusercontent.com/5241605/104547545-a9d24900-55e3-11eb-8a91-5f4ee00b9813.png"/></p>
<p>Applying a simple bandpass or highpass filter (to remove the low frequency background) leads to the below (keeping contrast/brightness the same as the raw movie image):</p>
<p><img alt="image" src="https://user-images.githubusercontent.com/5241605/104547910-852aa100-55e4-11eb-8528-5b4f29052ec2.png"/></p>
<p>However, if we adjust the contrast, we can now see some of the noise present in the higher frequency components of the raw movie that was otherwise obscured or would be hard to see in the raw movie with the high baseline present:</p>
<p><img alt="image" src="https://user-images.githubusercontent.com/5241605/104547900-7c39cf80-55e4-11eb-86d8-9e6e80758d01.png"/></p>
<h4 id="dff0">dF/F0<a class="headerlink" href="#dff0" title="Permanent link">¶</a></h4>
<p>Now compare to dF/F0 of that same raw movie without any motion correction, etc. we see the below:</p>
<p><img alt="image" src="https://user-images.githubusercontent.com/5241605/104547830-5280a880-55e4-11eb-8b35-ad114d12a2ff.png"/></p>
<p>However, if you adjust the contrast, you get the below image, where the noise is much more pronounced:</p>
<p><img alt="image" src="https://user-images.githubusercontent.com/5241605/104547778-37159d80-55e4-11eb-8b06-643508cb38ad.png"/></p>
<h2 id="imaging-analysis-methods-and-code">Imaging analysis methods and code<a class="headerlink" href="#imaging-analysis-methods-and-code" title="Permanent link">¶</a></h2>
<p>Outline of outside code, software packages, or techniques relevant to calcium imaging analysis. Also includes links to papers or GitHub code repositories.</p>
<p>Find an overview of calcium imaging analysis methods at <a href="https://bahanonu.com/brain/#c20181209">https://bahanonu.com/brain/#c20181209</a>. Or see below.</p>
<p><img alt="image" src="https://user-images.githubusercontent.com/5241605/51403860-954b3b00-1b06-11e9-8b36-78c7d5420c1d.png"/></p>
<h3 id="image-registration">Image Registration<a class="headerlink" href="#image-registration" title="Permanent link">¶</a></h3>
<ul>
<li>
<p>Turboreg</p>
<ul>
<li><a href="http://bigwww.epfl.ch/thevenaz/turboreg/">http://bigwww.epfl.ch/thevenaz/turboreg/</a></li>
</ul>
</li>
</ul>
<ul>
<li>
<p>NoRMCorre</p>
<ul>
<li><a href="https://github.com/simonsfoundation/NoRMCorre">https://github.com/simonsfoundation/NoRMCorre</a></li>
</ul>
</li>
</ul>
<ul>
<li>
<p>moco</p>
<ul>
<li><a href="https://github.com/NTCColumbia/moco">https://github.com/NTCColumbia/moco</a></li>
</ul>
</li>
</ul>
<h3 id="cross-day-alignment">Cross-day alignment<a class="headerlink" href="#cross-day-alignment" title="Permanent link">¶</a></h3>
<ul>
<li>
<p>CellReg (Ziv lab)</p>
<ul>
<li><a href="https://github.com/zivlab/CellReg/issues/1">https://github.com/zivlab/CellReg/issues/1</a></li>
</ul>
</li>
</ul>
<h3 id="cell-segmentation-static-image">Cell segmentation (static image)<a class="headerlink" href="#cell-segmentation-static-image" title="Permanent link">¶</a></h3>
<ul>
<li>
<p>NeuroSeg: automated cell detection and segmentation for in vivo two-photon Ca2+ imaging data</p>
<ul>
<li><a href="https://link.springer.com/article/10.1007/s00429-017-1545-5">https://link.springer.com/article/10.1007/s00429-017-1545-5</a></li>
</ul>
<ul>
<li><a href="https://github.com/baidatong/NeuroSeg">https://github.com/baidatong/NeuroSeg</a></li>
</ul>
</li>
</ul>
<h3 id="cell-extraction-dynamic-movie">Cell extraction (dynamic movie)<a class="headerlink" href="#cell-extraction-dynamic-movie" title="Permanent link">¶</a></h3>
<ul>
<li>
<p>PCA-ICA (Schnitzer)</p>
<ul>
<li><a href="https://www.ncbi.nlm.nih.gov/pmc/articles/PMC3282191/">https://www.ncbi.nlm.nih.gov/pmc/articles/PMC3282191/</a></li>
</ul>
<ul>
<li><a href="https://github.com/schnitzer-lab/miniscope_analysis/tree/master/signal_extraction/pca_ica">https://github.com/schnitzer-lab/miniscope_analysis/tree/master/signal_extraction/pca_ica</a></li>
</ul>
</li>
</ul>
<ul>
<li>
<p>CELLMax (Schnitzer)</p>
<ul>
<li><a href="https://github.com/schnitzer-lab/CELLMax">https://github.com/schnitzer-lab/CELLMax</a></li>
</ul>
</li>
</ul>
<ul>
<li>
<p>CNMF (Paninski)</p>
<ul>
<li><a href="https://github.com/epnev/ca_source_extraction">https://github.com/epnev/ca_source_extraction</a></li>
</ul>
<ul>
<li><a href="https://github.com/flatironinstitute/CaImAn-MATLAB">https://github.com/flatironinstitute/CaImAn-MATLAB</a></li>
</ul>
</li>
</ul>
<ul>
<li>
<p>CNMF-E (Paninski) - for miniscope data</p>
<ul>
<li><a href="https://github.com/zhoupc/CNMF_E">https://github.com/zhoupc/CNMF_E</a></li>
</ul>
</li>
</ul>
<ul>
<li>
<p>CNMF-E+ (Fukai)</p>
<ul>
<li>Automatic sorting system for large calcium imaging data</li>
</ul>
<ul>
<li><a href="https://www.biorxiv.org/content/early/2017/11/09/215145">https://www.biorxiv.org/content/early/2017/11/09/215145</a></li>
</ul>
</li>
</ul>
<ul>
<li>
<p>Automatic Neuron Detection in Calcium Imaging Data Using Convolutional Networks</p>
<ul>
<li><a href="http://papers.nips.cc/paper/6137-automatic-neuron-detection-in-calcium-imaging-data-using-convolutional-networks">http://papers.nips.cc/paper/6137-automatic-neuron-detection-in-calcium-imaging-data-using-convolutional-networks</a></li>
</ul>
</li>
</ul>
<ul>
<li>
<p>SCALPEL: Extracting Neurons from Calcium Imaging Data</p>
<ul>
<li><a href="https://arxiv.org/abs/1703.06946">https://arxiv.org/abs/1703.06946</a></li>
</ul>
</li>
</ul>
<ul>
<li>
<p>HNCcorr: A Novel Combinatorial Approach for Cell Identification in Calcium-Imaging Movies</p>
<ul>
<li><a href="https://arxiv.org/abs/1703.01999">https://arxiv.org/abs/1703.01999</a></li>
</ul>
</li>
</ul>
<ul>
<li>
<p>Seeds Cleansing CNMF for Spatiotemporal Neural Signals Extraction of Miniscope Imaging Data (Simon email this one out recently)</p>
<ul>
<li><a href="https://arxiv.org/abs/1704.00793">https://arxiv.org/abs/1704.00793</a></li>
</ul>
</li>
</ul>
<ul>
<li>
<p>ABLE: An Activity-Based Level Set Segmentation Algorithm for Two-Photon Calcium Imaging Data</p>
<ul>
<li><a href="http://www.eneuro.org/content/4/5/ENEURO.0012-17.2017">http://www.eneuro.org/content/4/5/ENEURO.0012-17.2017</a></li>
</ul>
<ul>
<li><a href="https://github.com/StephanieRey/ABLE">https://github.com/StephanieRey/ABLE</a>.</li>
</ul>
</li>
</ul>
<ul>
<li>
<p>STNeuroNet: Fast and robust active neuron segmentation in two-photon calcium imaging using spatiotemporal deep learning</p>
<ul>
<li><a href="https://www.pnas.org/content/116/17/8554.short">https://www.pnas.org/content/116/17/8554.short</a></li>
</ul>
</li>
</ul>
<h3 id="cell-extraction-correction">Cell-extraction correction<a class="headerlink" href="#cell-extraction-correction" title="Permanent link">¶</a></h3>
<ul>
<li>
<p>NAOMi (Neural Anatomy and Optical Microscopy)</p>
<ul>
<li><a href="https://www.biorxiv.org/content/10.1101/726174v1.full">https://www.biorxiv.org/content/10.1101/726174v1.full</a></li>
</ul>
</li>
</ul>
<h3 id="full-packages">Full packages<a class="headerlink" href="#full-packages" title="Permanent link">¶</a></h3>
<ul>
<li>
<p>Suite2P</p>
<ul>
<li><a href="https://github.com/cortex-lab/Suite2P">https://github.com/cortex-lab/Suite2P</a></li>
</ul>
</li>
</ul>
<ul>
<li>
<p>OnACID â€” OnACID: Online Analysis of Calcium Imaging Data in Real Time</p>
<ul>
<li><a href="https://www.biorxiv.org/content/early/2017/10/02/193383">https://www.biorxiv.org/content/early/2017/10/02/193383</a></li>
</ul>
</li>
</ul>
<ul>
<li>
<p>CaImAn (Computational toolbox for large scale Calcium Imaging Analysis)</p>
<ul>
<li><a href="https://github.com/simonsfoundation/CaImAn">https://github.com/simonsfoundation/CaImAn</a></li>
</ul>
</li>
</ul>
<ul>
<li>
<p>CALIMA: The Semi-automated open-source Calcium imaging analyzer</p>
<ul>
<li><a href="https://doi.org/10.1016/j.cmpb.2019.104991">https://doi.org/10.1016/j.cmpb.2019.104991</a></li>
</ul>
<ul>
<li><a href="https://aethelraed.nl/calciumimaginganalyser/index.html">https://aethelraed.nl/calciumimaginganalyser/index.html</a></li>
</ul>
</li>
</ul>
<ul>
<li>
<p>NETCAL: An interactive platform for large-scale, NETwork and population dynamics analysis of CALcium imaging recordings</p>
<ul>
<li><a href="https://zenodo.org/record/1119026#.XT9GdxSYVds">https://zenodo.org/record/1119026#.XT9GdxSYVds</a></li>
</ul>
<ul>
<li><a href="http://www.itsnetcal.com/">http://www.itsnetcal.com/</a></li>
</ul>
</li>
</ul>
<ul>
<li>
<p>Minian: An open-source miniscope analysis pipeline</p>
<ul>
<li><a href="https://www.biorxiv.org/content/10.1101/2021.05.03.442492v1.abstract">https://www.biorxiv.org/content/10.1101/2021.05.03.442492v1.abstract</a></li>
</ul>
<ul>
<li><a href="https://github.com/DeniseCaiLab/minian">https://github.com/DeniseCaiLab/minian</a></li>
</ul>
</li>
</ul>
<h3 id="standards">Standards<a class="headerlink" href="#standards" title="Permanent link">¶</a></h3>
<ul>
<li><a href="https://github.com/NeurodataWithoutBorders/api-matlab">https://github.com/NeurodataWithoutBorders/api-matlab</a></li>
</ul>
<h2 id="analyzing-large-movies">Analyzing large movies<a class="headerlink" href="#analyzing-large-movies" title="Permanent link">¶</a></h2>
<p>Some movies are larger than the available RAM on users analysis computer. Below are several ways that the underlying functions in <code>CIAPKG</code> can be used to analyze large movies.</p>
<h3 id="playing-large-movies-from-disk">Playing large movies from disk<a class="headerlink" href="#playing-large-movies-from-disk" title="Permanent link">¶</a></h3>
<p>To directly and quickly visualize large or long movies from disk, directly input the movie path into <code>playMovie</code> as below.</p>
<div class="codehilite"><pre><span></span><code><span class="lineno" data-linenos="1 "></span><span class="c">% Full path to the movie</span>
<span class="lineno" data-linenos="2 "></span>
<span class="lineno" data-linenos="3 "></span><span class="n">inputMoviePath</span> <span class="p">=</span> <span class="s">'path/to/movie.h5'</span><span class="p">;</span>
<span class="lineno" data-linenos="4 "></span>
<span class="lineno" data-linenos="5 "></span>
<span class="lineno" data-linenos="6 "></span>
<span class="lineno" data-linenos="7 "></span><span class="n">playMovie</span><span class="p">(</span><span class="n">inputMoviePath</span><span class="p">);</span>
</code></pre></div>
<p>Which will produce a GUI as below that will play the movie back.</p>
<p><img alt="image" src="https://user-images.githubusercontent.com/5241605/97789968-fdef9480-1b81-11eb-938c-863fa5159fb5.png"/></p>
<h3 id="roi-signal-extraction">ROI signal extraction<a class="headerlink" href="#roi-signal-extraction" title="Permanent link">¶</a></h3>
<p>The below code is an example ROI signal extraction for large movie in chunks from disk after analyzing a small chunk with PCA-ICA to obtain reference masks. Modify <code>inputMoviePath</code> to a full path to your movie (HDF5, TIF, AVI, and ISXD supported).</p>
<div class="codehilite"><pre><span></span><code><span class="lineno" data-linenos=" 1 "></span><span class="c">% Full path to the movie</span>
<span class="lineno" data-linenos=" 2 "></span>
<span class="lineno" data-linenos=" 3 "></span><span class="n">inputMoviePath</span> <span class="p">=</span> <span class="s">'path/to/movie.h5'</span><span class="p">;</span>
<span class="lineno" data-linenos=" 4 "></span>
<span class="lineno" data-linenos=" 5 "></span>
<span class="lineno" data-linenos=" 6 "></span>
<span class="lineno" data-linenos=" 7 "></span><span class="c">%% =======PCA-ICA</span>
<span class="lineno" data-linenos=" 8 "></span>
<span class="lineno" data-linenos=" 9 "></span><span class="c">% Run PCA-ICA on only a subset of frames.</span>
<span class="lineno" data-linenos="10 "></span>
<span class="lineno" data-linenos="11 "></span><span class="c">% OPTIONS</span>
<span class="lineno" data-linenos="12 "></span>
<span class="lineno" data-linenos="13 "></span>    <span class="c">% Vector of frames to analyze for PCA-ICA</span>
<span class="lineno" data-linenos="14 "></span>
<span class="lineno" data-linenos="15 "></span>    <span class="n">framesToAnalyzePcaIca</span> <span class="p">=</span> <span class="mi">1</span><span class="p">:</span><span class="mi">300</span><span class="p">;</span>
<span class="lineno" data-linenos="16 "></span>
<span class="lineno" data-linenos="17 "></span>    <span class="c">% Number of PCs and ICs to request</span>
<span class="lineno" data-linenos="18 "></span>
<span class="lineno" data-linenos="19 "></span>    <span class="n">nPCs</span> <span class="p">=</span> <span class="mi">250</span><span class="p">;</span> <span class="n">nICs</span> <span class="p">=</span> <span class="mi">200</span><span class="p">;</span>
<span class="lineno" data-linenos="20 "></span>
<span class="lineno" data-linenos="21 "></span><span class="p">[</span><span class="n">pcaicaAnalysisOutput</span><span class="p">]</span> <span class="p">=</span> <span class="n">ciapkg</span><span class="p">.</span><span class="n">signal_extraction</span><span class="p">.</span><span class="n">runPcaIca</span><span class="p">(</span><span class="n">inputMoviePath</span><span class="p">,</span><span class="n">nPCs</span><span class="p">,</span><span class="n">nICs</span><span class="p">,</span><span class="s">'frameList'</span><span class="p">,</span><span class="n">framesToAnalyzePcaIca</span><span class="p">,</span><span class="s">'mu'</span><span class="p">,</span><span class="mf">0.1</span><span class="p">,</span><span class="s">'max_iter'</span><span class="p">,</span><span class="mf">1e3</span><span class="p">);</span>
<span class="lineno" data-linenos="22 "></span>
<span class="lineno" data-linenos="23 "></span>
<span class="lineno" data-linenos="24 "></span>
<span class="lineno" data-linenos="25 "></span><span class="c">%% =======ROI extraction new version</span>
<span class="lineno" data-linenos="26 "></span>
<span class="lineno" data-linenos="27 "></span><span class="c">% OPTIONS</span>
<span class="lineno" data-linenos="28 "></span>
<span class="lineno" data-linenos="29 "></span>    <span class="c">% Number of frames to chunk from movie when doing ROI estimation, to reduce RAM usage.</span>
<span class="lineno" data-linenos="30 "></span>
<span class="lineno" data-linenos="31 "></span>    <span class="n">movieChunks</span> <span class="p">=</span> <span class="mi">100</span><span class="p">;</span>
<span class="lineno" data-linenos="32 "></span>
<span class="lineno" data-linenos="33 "></span><span class="c">% Normal PCA-ICA, binary masks</span>
<span class="lineno" data-linenos="34 "></span>
<span class="lineno" data-linenos="35 "></span><span class="p">[</span><span class="n">roiSignals</span><span class="p">,</span> <span class="o">~</span><span class="p">]</span> <span class="p">=</span> <span class="n">ciapkg</span><span class="p">.</span><span class="n">signal_extraction</span><span class="p">.</span><span class="n">computeSignalsFromImages</span><span class="p">(</span><span class="n">pcaicaAnalysisOutput</span><span class="p">.</span><span class="n">IcaFilters</span><span class="p">,</span><span class="n">inputMoviePath</span><span class="p">,</span><span class="s">'frameList'</span><span class="p">,[],</span><span class="s">'readMovieChunks'</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="s">'threshold'</span><span class="p">,</span><span class="mf">0.4</span><span class="p">,</span><span class="s">'nFramesPerChunk'</span><span class="p">,</span><span class="n">movieChunks</span><span class="p">,</span><span class="s">'weightSignalByImage'</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span>
<span class="lineno" data-linenos="36 "></span>
<span class="lineno" data-linenos="37 "></span><span class="c">% Weighted PCA-ICA, trace based on weighted pixel values of eahc ROI</span>
<span class="lineno" data-linenos="38 "></span>
<span class="lineno" data-linenos="39 "></span><span class="p">[</span><span class="n">roiSignalsWeighted</span><span class="p">,</span> <span class="o">~</span><span class="p">]</span> <span class="p">=</span> <span class="n">ciapkg</span><span class="p">.</span><span class="n">signal_extraction</span><span class="p">.</span><span class="n">computeSignalsFromImages</span><span class="p">(</span><span class="n">pcaicaAnalysisOutput</span><span class="p">.</span><span class="n">IcaFilters</span><span class="p">,</span><span class="n">inputMoviePath</span><span class="p">,</span><span class="s">'frameList'</span><span class="p">,[],</span><span class="s">'readMovieChunks'</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="s">'threshold'</span><span class="p">,</span><span class="mf">0.4</span><span class="p">,</span><span class="s">'nFramesPerChunk'</span><span class="p">,</span><span class="n">movieChunks</span><span class="p">,</span><span class="s">'weightSignalByImage'</span><span class="p">,</span><span class="mi">1</span><span class="p">);</span>
</code></pre></div>
<h2 id="stripe-removal-from-movies">Stripe removal from movies<a class="headerlink" href="#stripe-removal-from-movies" title="Permanent link">¶</a></h2>
<p>Some cameras will produce vertical and/or horizontal stripes in the movies that users will want to remove. Below is an example of process to remove strip from movies. The underlying function is <code>removeStripsFromMovie</code> and users can remove using <code>modelPreprocessMovie</code> module in the <code>CIAtah</code> class.</p>
<p>Vertical and horizontal stripes can be removed with the vertical and horizontal aspect of the the Fourier spectrum. In my default implementation for users I attenuate at lower frequencies since those usually do not contain the camera-induced stripes. If users have experimental induced stripes, they should lower the frequency threshold to include low frequency (spatially large) stripes.</p>
<h3 id="example-implementation">Example implementation<a class="headerlink" href="#example-implementation" title="Permanent link">¶</a></h3>
<p>Below is an example removal of stripes showing both the Fourier domain analysis in the top row and the real domain processing in the bottom row. Bottom right shows the difference between the original and filtered movie, indicating where the stripes have been removed.</p>
<p><a href="https://user-images.githubusercontent.com/5241605/51817825-4e391480-2281-11e9-9a17-cc972c26230a.png" target="_blank"><img alt="picture1" src="https://user-images.githubusercontent.com/5241605/51817825-4e391480-2281-11e9-9a17-cc972c26230a.png"/></a></p>
<!-- ![picture1](https://user-images.githubusercontent.com/5241605/51817825-4e391480-2281-11e9-9a17-cc972c26230a.png) -->
<h3 id="removestripsfrommovie">removeStripsFromMovie<a class="headerlink" href="#removestripsfrommovie" title="Permanent link">¶</a></h3>
<p>To run stripe removal on any <code>inputMovie</code> movie matrix already loaded in MATLAB, run the below code. Details on each option can be found within the <code>removeStripsFromMovie</code> function.</p>
<div class="codehilite"><pre><span></span><code><span class="lineno" data-linenos="1 "></span><span class="c">% This will produce a result similar to above.</span>
<span class="lineno" data-linenos="2 "></span>
<span class="lineno" data-linenos="3 "></span><span class="n">removeStripsFromMovie</span><span class="p">(</span><span class="n">inputMovie</span><span class="p">,</span><span class="s">'stripOrientation'</span><span class="p">,</span><span class="n">both</span><span class="p">,</span><span class="s">'meanFilterSize'</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="s">'freqLowExclude'</span><span class="p">,</span><span class="mi">10</span><span class="p">,</span><span class="s">'bandpassType'</span><span class="p">,</span><span class="s">'highpass'</span><span class="p">)</span>
</code></pre></div>
<h3 id="sitename">CIAtah<a class="headerlink" href="#sitename" title="Permanent link">¶</a></h3>
<p>To use within the <code>CIAtah</code> class, select <code>modelPreprocessMovie</code> module and have <code>stripeRemoval</code> selected then on the options page, choose whether to remove vertical, horizontal, or both stripes.</p>
<p><img alt="image" src="https://user-images.githubusercontent.com/5241605/71019922-1bbe2300-20b0-11ea-9c5f-232326884db4.png"/></p>
<p><img alt="image" src="https://user-images.githubusercontent.com/5241605/71020018-5922b080-20b0-11ea-9637-abead3c26110.png"/></p>
<p>A second example of how stripe removal can improve image quality using <code>removeStripsFromMovie</code>.</p>
<p><img alt="image" src="https://user-images.githubusercontent.com/5241605/100809655-75b41780-33eb-11eb-8b58-99bf79924528.png"/></p>
<p><img alt="image" src="https://user-images.githubusercontent.com/5241605/100809673-7f3d7f80-33eb-11eb-8b44-db510ff6a974.png"/></p>
<h2 id="preprocessing-improving-snr">Preprocessing: Improving SNR<a class="headerlink" href="#preprocessing-improving-snr" title="Permanent link">¶</a></h2>
<p>This relates to methods within the <code>CIAtah</code> class for checking Î”F/F during cell sorting and ways to improve SNR (esp. in miniscope movies), also see <a href="../Preprocessing:-Spatial-filtering">Preprocessing:-Spatial-filtering</a>.</p>
<h3 id="movie-cell-roi-trace-during-cell-sorting">Movie cell ROI trace during cell sorting<a class="headerlink" href="#movie-cell-roi-trace-during-cell-sorting" title="Permanent link">¶</a></h3>
<ul>
<li>If users press <code>r</code> while in the interface, it will show users a ROI calculated trace (which will contain more cross-talk, but will give you a direct measure of Î”F/F from your movie compared to ICA/CNMF-E/etc. traces.</li>
</ul>
<p><img alt="image" src="https://user-images.githubusercontent.com/5241605/52152675-0ffa7700-262c-11e9-9800-e53517cde869.png"/></p>
<p><img alt="image" src="https://user-images.githubusercontent.com/5241605/52152685-1a1c7580-262c-11e9-9beb-e47fa5ffeac9.png"/></p>
<h3 id="spatial-filtering-during-modelpreprocessmovie-preprocessing">Spatial filtering during <code>modelPreprocessMovie</code> preprocessing<a class="headerlink" href="#spatial-filtering-during-modelpreprocessmovie-preprocessing" title="Permanent link">¶</a></h3>
<ul>
<li>The other is that in the <code>modelPreprocessMovie</code> preprocessing module, when you are on the 1st page of the options, in the <code>filterBeforeRegister</code> setting select <code>matlab divide by lowpass before registering</code> or <code>matlab bandpass before registering</code>.</li>
</ul>
<ul>
<li>See also the spatial filtering wiki page: <a href="https://github.com/bahanonu/calciumImagingAnalysis/wiki/Preprocessing:-Spatial-filtering#dark-halos-around-cells">https://github.com/bahanonu/calciumImagingAnalysis/wiki/Preprocessing:-Spatial-filtering#dark-halos-around-cells</a>.</li>
</ul>
<p><img alt="image" src="https://user-images.githubusercontent.com/5241605/52152666-06710f00-262c-11e9-89fe-6f517632f384.png"/></p>
<h3 id="viewmovieregistrationtest">viewMovieRegistrationTest<a class="headerlink" href="#viewmovieregistrationtest" title="Permanent link">¶</a></h3>
<ul>
<li>To get a feel for how the different filtering affects SNR/movie data, run <code>viewMovieRegistrationTest</code> module and select either <code>matlab divide by lowpass before registering</code> or <code>matlab bandpass before registering</code> then change <code>filterBeforeRegFreqLow</code> and <code>filterBeforeRegFreqHigh</code> settings, see below.</li>
</ul>
<p><img alt="image" src="https://user-images.githubusercontent.com/5241605/52153165-cb6fdb00-262d-11e9-8c9f-8e7953c02eee.png"/></p>
<p><img alt="image" src="https://user-images.githubusercontent.com/5241605/52152814-a62e9d00-262c-11e9-99da-981377a4b7b9.png"/></p>
<ul>
<li>You'll get an output like the below (top left is without any filtering, other 3 are with different bandpass filtering options).</li>
</ul>
<p><img alt="image" src="https://user-images.githubusercontent.com/5241605/52153455-f3137300-262e-11e9-9858-45445f44e7f5.png"/></p>
<p><img alt="image" src="https://user-images.githubusercontent.com/5241605/52153507-2d7d1000-262f-11e9-9662-182331b555c0.png"/></p>
<ul>
<li>Cell Î”F/F intensity profile from the raw movie</li>
</ul>
<p><img alt="image" src="https://user-images.githubusercontent.com/5241605/52153427-d7a86800-262e-11e9-983f-fa3879adca9a.png"/></p>
<ul>
<li>Same cell Î”F/F intensity profile from the bottom/left movie (not the y-axis is the same as above):</li>
</ul>
<p><img alt="image" src="https://user-images.githubusercontent.com/5241605/52153392-ba739980-262e-11e9-8750-04ef2c11861b.png"/></p>
<h2 id="movie-filtering">Movie Filtering<a class="headerlink" href="#movie-filtering" title="Permanent link">¶</a></h2>
<p>This page documents different features and functions in the CIAtah repository variable for filtering (spatial high/low/bandpass) movies to remove neuropil, cells, or other features.</p>
<p><img alt="2014_04_01_p203_m19_check01_spatialFilter" src="https://user-images.githubusercontent.com/5241605/111711340-af792480-8808-11eb-85d1-8c76479995bb.gif"/></p>
<h3 id="why-conduct-spatial-filtering">Why conduct spatial filtering?<a class="headerlink" href="#why-conduct-spatial-filtering" title="Permanent link">¶</a></h3>
<p>Spatial filtering can have a large impact on the resulting cell activity traces extracted from the movies and can lead to erroneous conclusions if not properly applied during pre-processing.</p>
<p>For example, below are the correlations  between all cell-extraction outputs from PCA-ICA, ROI back-application of ICA filters, and CNMF-e on a miniature microscope one-photon movie. As can be seen, especially in the case of ROI analysis, the correlation between the activity traces is rendered artificially high due to the correlated background noise. This is greatly reduced in many instances after proper spatial filtering.</p>
<p><img alt="image" src="https://user-images.githubusercontent.com/5241605/111710928-e864c980-8807-11eb-9d29-81341290d108.png"/></p>
<!-- (Chebychev clustering, n = 5 clusters) -->
<!-- <hr> -->
<h3 id="filtering-movies-with-normalizemovie">Filtering movies with <code>normalizeMovie</code><a class="headerlink" href="#filtering-movies-with-normalizemovie" title="Permanent link">¶</a></h3>
<p>Users can quickly filter movies using the <code>normalizeMovie</code> function. See below for usage.</p>
<div class="codehilite"><pre><span></span><code><span class="lineno" data-linenos=" 1 "></span><span class="c">% Load the movie (be in TIF, HDF5, AVI, etc.). Change HDF5 input dataset name as needed.</span>
<span class="lineno" data-linenos=" 2 "></span>
<span class="lineno" data-linenos=" 3 "></span><span class="n">inputMovie</span> <span class="p">=</span> <span class="n">loadMovieList</span><span class="p">(</span><span class="s">'pathToMovie'</span><span class="p">,</span><span class="s">'inputDatasetName'</span><span class="p">,</span><span class="s">'/1'</span><span class="p">);</span> 
<span class="lineno" data-linenos=" 4 "></span>
<span class="lineno" data-linenos=" 5 "></span>
<span class="lineno" data-linenos=" 6 "></span>
<span class="lineno" data-linenos=" 7 "></span><span class="c">% Set options for dividing movie by lowpass version of the movie</span>
<span class="lineno" data-linenos=" 8 "></span>
<span class="lineno" data-linenos=" 9 "></span><span class="n">options</span><span class="p">.</span><span class="n">freqLow</span> <span class="p">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="lineno" data-linenos="10 "></span>
<span class="lineno" data-linenos="11 "></span><span class="n">options</span><span class="p">.</span><span class="n">freqHigh</span> <span class="p">=</span> <span class="mi">4</span><span class="p">;</span>
<span class="lineno" data-linenos="12 "></span>
<span class="lineno" data-linenos="13 "></span><span class="n">options</span><span class="p">.</span><span class="n">normalizationType</span> <span class="p">=</span> <span class="s">'lowpassFFTDivisive'</span><span class="p">;</span>
<span class="lineno" data-linenos="14 "></span>
<span class="lineno" data-linenos="15 "></span><span class="n">options</span><span class="p">.</span><span class="n">waitbarOn</span> <span class="p">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="lineno" data-linenos="16 "></span>
<span class="lineno" data-linenos="17 "></span><span class="n">options</span><span class="p">.</span><span class="n">bandpassMask</span> <span class="p">=</span> <span class="s">'gaussian'</span><span class="p">;</span>
<span class="lineno" data-linenos="18 "></span>
<span class="lineno" data-linenos="19 "></span>
<span class="lineno" data-linenos="20 "></span>
<span class="lineno" data-linenos="21 "></span><span class="c">% Options for normal bandpass filter</span>
<span class="lineno" data-linenos="22 "></span>
<span class="lineno" data-linenos="23 "></span><span class="n">options</span><span class="p">.</span><span class="n">freqLow</span> <span class="p">=</span> <span class="mi">10</span><span class="p">;</span>
<span class="lineno" data-linenos="24 "></span>
<span class="lineno" data-linenos="25 "></span><span class="n">options</span><span class="p">.</span><span class="n">freqHigh</span> <span class="p">=</span> <span class="mi">50</span><span class="p">;</span>
<span class="lineno" data-linenos="26 "></span>
<span class="lineno" data-linenos="27 "></span><span class="n">options</span><span class="p">.</span><span class="n">normalizationType</span> <span class="p">=</span> <span class="s">'fft'</span><span class="p">;</span>
<span class="lineno" data-linenos="28 "></span>
<span class="lineno" data-linenos="29 "></span><span class="n">options</span><span class="p">.</span><span class="n">waitbarOn</span> <span class="p">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="lineno" data-linenos="30 "></span>
<span class="lineno" data-linenos="31 "></span><span class="n">options</span><span class="p">.</span><span class="n">bandpassMask</span> <span class="p">=</span> <span class="s">'gaussian'</span><span class="p">;</span>
<span class="lineno" data-linenos="32 "></span>
<span class="lineno" data-linenos="33 "></span>
<span class="lineno" data-linenos="34 "></span>
<span class="lineno" data-linenos="35 "></span><span class="c">% Set additional common options</span>
<span class="lineno" data-linenos="36 "></span>
<span class="lineno" data-linenos="37 "></span><span class="n">options</span><span class="p">.</span><span class="n">showImages</span> <span class="p">=</span> <span class="mi">0</span><span class="p">;</span> <span class="c">% Set to 1 if you want to view</span>
<span class="lineno" data-linenos="38 "></span>
<span class="lineno" data-linenos="39 "></span>
<span class="lineno" data-linenos="40 "></span>
<span class="lineno" data-linenos="41 "></span><span class="c">% Run analysis</span>
<span class="lineno" data-linenos="42 "></span>
<span class="lineno" data-linenos="43 "></span><span class="n">inputMovie</span> <span class="p">=</span> <span class="n">normalizeMovie</span><span class="p">(</span><span class="n">single</span><span class="p">(</span><span class="n">inputMovie</span><span class="p">),</span><span class="s">'options'</span><span class="p">,</span><span class="n">options</span><span class="p">);</span>
</code></pre></div>
<p>If users set <code>options.showImages = 0;</code>, then <code>normalizeMovie</code> will update a figure containing both real and frequency space before and after the filter has been applied along with an example of the filter in frequency space. This allows users to get a sense of what their filter is doing. See below for examples.</p>
<!-- ![image](https://user-images.githubusercontent.com/5241605/111677991-049f4100-87dd-11eb-9bb6-1ba46894ea70.png) -->
<h4 id="fft-bandpass-filtering">FFT bandpass filtering<a class="headerlink" href="#fft-bandpass-filtering" title="Permanent link">¶</a></h4>
<p>Bandpass filtering where only <code>red</code> frequencies in <code>filter</code> image (FFT of bottom left input image) are kept producing an image as in <code>fft image</code>.</p>
<p><img alt="image" src="https://github.com/bahanonu/ciatah/assets/5241605/78fda2d7-a041-4622-a9b6-3b667f24bc49"/></p>
<h4 id="divide-by-lowpass-filtering">Divide by lowpass filtering<a class="headerlink" href="#divide-by-lowpass-filtering" title="Permanent link">¶</a></h4>
<p>Another method is <code>lowpassFFTDivisive</code>, which involves dividing the image by a lowpass version of itself. In the below example, the <code>filter</code> image shows that only low frequencies will be kept. This will produce an image as in <code>fft image</code> that when divided or subtracted from the <code>input image</code> will produce <code>difference</code> image.</p>
<p><img alt="image" src="https://github.com/bahanonu/ciatah/assets/5241605/cde8556b-e009-4e92-b28f-b277f331a9a5"/></p>
<h3 id="images-from-unit-test">Images from unit test<a class="headerlink" href="#images-from-unit-test" title="Permanent link">¶</a></h3>
<h4 id="main-filtering-functions">Main filtering functions.<a class="headerlink" href="#main-filtering-functions" title="Permanent link">¶</a></h4>
<p>Below is a screen grab from a random frame using all the filtering functions. A nice way to quickly see the many differences between each functions filtering.</p>
<!-- ![image](https://user-images.githubusercontent.com/5241605/32477562-18b7d9d4-c334-11e7-988f-accdf99a22f2.png) -->
<p><img alt="image" src="https://github.com/bahanonu/ciatah/assets/5241605/51356dea-deb6-4bbe-904b-2a79577ffcdf"/></p>
<h4 id="test-function-filtering">Test function filtering<a class="headerlink" href="#test-function-filtering" title="Permanent link">¶</a></h4>
<p>This function will take a movie and conduct multiple spatial filtering operations on it then display for the user. </p>
<!-- This is currently only for the Matlab fft, but I'll see about expanding to others. -->
<div class="codehilite"><pre><span></span><code><span class="lineno" data-linenos="1 "></span><span class="n">ciapkg</span><span class="p">.</span><span class="n">unit</span><span class="p">.</span><span class="n">unitNormalizeMovie</span><span class="p">;</span>
</code></pre></div>
<p>After running that function, below is an example movie from a prefrontal cortex animal (miniature microscope, GCaMP) showing the difference in results with different spatial filtering.</p>
<p><img alt="image" src="https://github.com/bahanonu/ciatah/assets/5241605/a09e959e-da75-49c3-8c89-7ee1e42ac004"/></p>
<h4 id="matlab-test-function">Matlab test function<a class="headerlink" href="#matlab-test-function" title="Permanent link">¶</a></h4>
<p>I've also added the ability to test the parameter space of the Matlab fft, use the below command.</p>
<div class="codehilite"><pre><span></span><code><span class="lineno" data-linenos="1 "></span><span class="n">testMovieFFT</span> <span class="p">=</span> <span class="n">normalizeMovie</span><span class="p">(</span><span class="n">testMovie</span><span class="p">,</span><span class="s">'normalizationType'</span><span class="p">,</span><span class="s">'matlabFFT_test'</span><span class="p">,</span><span class="s">'secondaryNormalizationType'</span><span class="p">,</span><span class="s">'lowpassFFTDivisive'</span><span class="p">,</span><span class="s">'bandpassMask'</span><span class="p">,</span><span class="s">'gaussian'</span><span class="p">,</span><span class="s">'bandpassType'</span><span class="p">,</span><span class="s">'lowpass'</span><span class="p">);</span>
</code></pre></div>
<p>Should get a movie output similar to the below, where there is the original movie, the FFT movie, the original/FFT movie, and the dfof of original/FFT movie.</p>
<p><img alt="image" src="https://cloud.githubusercontent.com/assets/5241605/11490967/559152e2-9792-11e5-839b-a93811df70ce.png"/></p>
<p>This can also be expanded to look at the effects of different spatial frequency filters on the resulting output, as indicated below.</p>
<p><img alt="image" src="https://user-images.githubusercontent.com/5241605/32477571-26620546-c334-11e7-8ce0-aa5269fcb5f3.png"/></p>
<h4 id="matlab-test-function-movie-output">Matlab test function movie output<a class="headerlink" href="#matlab-test-function-movie-output" title="Permanent link">¶</a></h4>
<p>Similar to above, showing results when using <code>lowpassFFTDivisive</code> normalization (using the <code>matlab divide by lowpass before registering</code> option in <code>modelPreprocessMovie</code> and <code>viewMovieRegistrationTest</code> functions) with <code>freqLow = 0</code> and <code>freqHigh</code> set to <code>1</code>, <code>4</code>, and <code>20</code>. This corresponds to removing increasingly smaller features from the movie.</p>
<!-- 2014_04_01_p203_m19_check01_fft_example-3 -->
<!-- ![image](https://user-images.githubusercontent.com/5241605/71422606-aec30400-2640-11ea-8ffb-41cdeea771c1.gif) -->
<!-- ![image](https://github.com/bahanonu/ciatah/assets/5241605/c6ffeb2b-db03-413c-8a58-e35e3543e5db) -->
<p><img alt="image" src="https://github.com/bahanonu/ciatah/assets/5241605/2534544b-7519-4d17-b4f5-088ee5582a87"/></p>
<h4 id="imagej-test-function">ImageJ test function<a class="headerlink" href="#imagej-test-function" title="Permanent link">¶</a></h4>
<p>To test the ImageJ FFT and determine the best parameters for a given set of movies, run the following function on a test movie matrix:</p>
<div class="codehilite"><pre><span></span><code><span class="lineno" data-linenos="1 "></span><span class="n">inputMovieTest</span> <span class="p">=</span> <span class="n">normalizeMovie</span><span class="p">(</span><span class="n">inputMovie</span><span class="p">,</span><span class="s">'normalizationType'</span><span class="p">,</span><span class="s">'imagejFFT_test'</span><span class="p">);</span>
</code></pre></div>
<p>The output should look like the below:</p>
<p><img alt="image" src="https://cloud.githubusercontent.com/assets/5241605/11154743/14dd385a-89f6-11e5-8d56-c349e8c4f3f8.png"/></p>
<!-- <hr> -->
<h3 id="common-issues">Common Issues<a class="headerlink" href="#common-issues" title="Permanent link">¶</a></h3>
<p>A list of some common issues.</p>
<h4 id="dark-halos-around-cells">Dark halos around cells<a class="headerlink" href="#dark-halos-around-cells" title="Permanent link">¶</a></h4>
<p>If the spatial filter is not properly configured then dark halos will appear around high SNR cells, potentially obscuring nearby, low SNR cells.</p>
<p><img alt="image" src="https://cloud.githubusercontent.com/assets/5241605/11329062/1232a886-914b-11e5-9cca-85ec6162319b.png"/></p>
<!-- https://github.com/schnitzer-lab/miniscope_analysis/pull/30 -->
<ul>
<li>FYI, for 4x downsampled movies, <code>highFreq</code> parameter of 4 (which corresponds to a <code>fspecial</code> gaussian with std of 4) produces the closest results to ImageJ <code>Process-&gt;FFT-&gt;Bandpass Filter...</code> with inputs of <code>filter_large=10000 filter_small=80 suppress=None tolerance=5</code> (the current default in <code>normalizeMovie</code>).</li>
</ul>
<h4 id="comparison-of-matlab-and-imagej-fft-based-spatial-filtering">Comparison of MATLAB and ImageJ FFT-based spatial filtering<a class="headerlink" href="#comparison-of-matlab-and-imagej-fft-based-spatial-filtering" title="Permanent link">¶</a></h4>
<ul>
<li>Example frame from ImageJ and Matlab FFTs.</li>
</ul>
<p><img alt="image" src="https://cloud.githubusercontent.com/assets/5241605/11519196/fbcd561e-984c-11e5-95b9-3a23085c2e44.png"/></p>
<ul>
<li>Distribution of pixel differences between ImageJ and Matlab FFT movies.</li>
</ul>
<p><img alt="image" src="https://cloud.githubusercontent.com/assets/5241605/11519037/8bcae88c-984b-11e5-84dd-097c61ccd756.png"/></p>
<ul>
<li>This matches the filter that ImageJ says it uses, which is fairly close to the Matlab filter.</li>
</ul>
<p><img alt="image" src="https://cloud.githubusercontent.com/assets/5241605/11519329/22b3af8e-984e-11e5-9379-5b5d4092cee0.png"/></p>
<p><strong>Example video: Basolateral amygdala miniature microscope imaging in open field</strong></p>
<!-- 2015_11_25_p384_m610_openfield01 -->
<ul>
<li>Below is an example comparison using the following Matlab commands to produce the filtered inputs:</li>
</ul>
<div class="codehilite"><pre><span></span><code><span class="lineno" data-linenos="1 "></span><span class="n">testMovieFFT</span> <span class="p">=</span> <span class="n">normalizeMovie</span><span class="p">(</span><span class="n">testMovie</span><span class="p">,</span><span class="s">'normalizationType'</span><span class="p">,</span><span class="s">'lowpassFFTDivisive'</span><span class="p">,</span><span class="s">'freqHigh'</span><span class="p">,</span><span class="mi">7</span><span class="p">);</span>
<span class="lineno" data-linenos="2 "></span>
<span class="lineno" data-linenos="3 "></span><span class="n">testMovieFFTImageJ</span> <span class="p">=</span> <span class="n">normalizeMovie</span><span class="p">(</span><span class="n">testMovie</span><span class="p">,</span><span class="s">'normalizationType'</span><span class="p">,</span><span class="s">'imagejFFT'</span><span class="p">);</span>
<span class="lineno" data-linenos="4 "></span>
<span class="lineno" data-linenos="5 "></span><span class="n">diffMovie</span> <span class="p">=</span> <span class="n">testMovieFFT</span><span class="o">-</span><span class="n">testMovieFFTImageJ</span> <span class="p">;</span>
</code></pre></div>
<ul>
<li>With some tweaking of the <code>freqHigh</code> and other parameters, should hopefully be able to get closer to macheps and say that the two are identical for our purposes.</li>
</ul>
<p><img alt="image" src="https://cloud.githubusercontent.com/assets/5241605/11490643/618983b0-978f-11e5-944c-14c049d9d17e.png"/></p>
<ul>
<li>This is the histogram of the difference movie (Matlab - ImageJ). Notice most of the values are centered around zero with stdev ~0.2% df/f.</li>
</ul>
<p><img alt="image" src="https://cloud.githubusercontent.com/assets/5241605/11490647/68fbc8a6-978f-11e5-985d-1f07101840de.png"/></p>
<h2 id="preprocessing-temporal-downsampling">Preprocessing: Temporal downsampling<a class="headerlink" href="#preprocessing-temporal-downsampling" title="Permanent link">¶</a></h2>
<p>Next, temporally smooth each movie by downsampling from the original 20 or 30 Hz to 5 Hz</p>
<p>Example code to run the downsample test function with the following commands:</p>
<div class="codehilite"><pre><span></span><code><span class="lineno" data-linenos="1 "></span><span class="n">loadRepoFunctions</span><span class="p">;</span>
<span class="lineno" data-linenos="2 "></span>
<span class="lineno" data-linenos="3 "></span><span class="n">testMovie</span> <span class="p">=</span> <span class="n">loadMovieList</span><span class="p">(</span><span class="s">'pathToMovieFile'</span><span class="p">);</span>
<span class="lineno" data-linenos="4 "></span>
<span class="lineno" data-linenos="5 "></span><span class="n">unitTestDownsampleMovie</span><span class="p">(</span><span class="n">testMovie</span><span class="p">,</span><span class="s">'interp1Method'</span><span class="p">,</span><span class="s">'linear'</span><span class="p">,</span><span class="s">'cropSize'</span><span class="p">,</span><span class="mi">5</span><span class="p">);</span>
</code></pre></div>
<p>Below is an example pixel from a cell in a BLA animal. Note:</p>
<ul>
<li>ImageJ <code>Scale...</code>+bilinear+averaging (blue) and Matlab <code>imresize</code>+bilinear (red) both produce pretty much identical results.</li>
</ul>
<ul>
<li><code>imresize</code> using bilinear and bicubic produce similar results with bicubic having slower runtimes (e.g. on my machine 3.46 vs. 4.31 sec if set <code>cropSize</code> to 100).</li>
</ul>
<ul>
<li>The number next to each name is the vector's variance.</li>
</ul>
<p><img alt="image" src="https://cloud.githubusercontent.com/assets/5241605/13099409/b85b119c-d4e6-11e5-91d4-f6f7c74fed18.png"/></p>
<p><img alt="image" src="https://cloud.githubusercontent.com/assets/5241605/13099409/b85b119c-d4e6-11e5-91d4-f6f7c74fed18.png"/></p>
<p>img
Scripts to register movies to remove motion.</p>
<h3 id="calculating-final-transformation-after-multiple-registration-iterations">Calculating final transformation after multiple registration iterations.<a class="headerlink" href="#calculating-final-transformation-after-multiple-registration-iterations" title="Permanent link">¶</a></h3>
<p>It is possible to use the output from motion correction (often done with <code>turboregMovie</code> or <code>modelPreprocessMovieFunction</code>) to transform the movie at later times if needed. There are two ways to do this:</p>
<ul>
<li>iteratively perform each motion correction step (e.g. same order as in <code>modelPreprocessMovieFunction</code>) or</li>
</ul>
<ul>
<li>create the translation/skew/rotation matrices for each step using <code>ResultsOutOriginal</code> and combine for all iterations as <code>totalTranformMatrix = (R2'*S2'*T2'*R1'*S1'*T1')'</code>. Note the order matters.<p>- Where <code>1, 2, ...</code> indicate matrix for iterations <code>1,2,...</code> and <code>R, S, T</code> are rotation, skew (shear + scale) and translation matrices, respectively.</p>
<p>- For 3 iterations would be <code>(R3'*S3'*T3'*R2'*S2'*T2'*R1'*S1'*T1')'</code>  or alternatively <code>T1*S1*R1*T3*S3*R2*T3*S3*R3</code>.</p>
<p>- For translation/rotation matrices, use definitions in <a href="https://www.mathworks.com/help/images/matrix-representation-of-geometric-transformations.html">https://www.mathworks.com/help/images/matrix-representation-of-geometric-transformations.html</a> to construct them.</p>
</li>
</ul>
<h3 id="turboreg">Turboreg<a class="headerlink" href="#turboreg" title="Permanent link">¶</a></h3>
<h4 id="compiling-turboreg-and-transfturboreg-mex-file">Compiling <code>turboreg</code> and <code>transfturboreg</code> mex file<a class="headerlink" href="#compiling-turboreg-and-transfturboreg-mex-file" title="Permanent link">¶</a></h4>
<ul>
<li>Can compile on your system using the following command</li>
</ul>
<div class="codehilite"><pre><span></span><code><span class="lineno" data-linenos="1 "></span><span class="n">mex</span><span class="p">(</span><span class="s">'-v'</span><span class="p">,</span> <span class="s">'-largeArrayDims'</span><span class="p">,</span><span class="s">'-I.'</span><span class="p">,</span> <span class="s">'turboreg.c'</span><span class="p">,</span><span class="s">'.\BsplnTrf.c'</span><span class="p">,</span><span class="s">'.\BsplnWgt.c'</span><span class="p">,</span><span class="s">'.\convolve.c'</span><span class="p">,</span><span class="s">'.\getPut.c'</span><span class="p">,</span><span class="s">'.\main.c'</span><span class="p">,</span><span class="s">'.\phil.c'</span><span class="p">,</span><span class="s">'.\pyrFilt.c'</span><span class="p">,</span><span class="s">'.\pyrGetSz.c'</span><span class="p">,</span><span class="s">'.\quant.c'</span><span class="p">,</span><span class="s">'.\reg0.c'</span><span class="p">,</span><span class="s">'.\reg1.c'</span><span class="p">,</span><span class="s">'.\reg2.c'</span><span class="p">,</span><span class="s">'.\reg3.c'</span><span class="p">,</span><span class="s">'.\regFlt3d.c'</span><span class="p">,</span><span class="s">'.\svdcmp.c'</span><span class="p">)</span>
<span class="lineno" data-linenos="2 "></span>
<span class="lineno" data-linenos="3 "></span>
<span class="lineno" data-linenos="4 "></span>
<span class="lineno" data-linenos="5 "></span><span class="n">mex</span><span class="p">(</span><span class="s">'-v'</span><span class="p">,</span> <span class="s">'-largeArrayDims'</span><span class="p">,</span><span class="s">'-I.'</span><span class="p">,</span> <span class="s">'transfturboreg.c'</span><span class="p">,</span><span class="s">'.\BsplnTrf.c'</span><span class="p">,</span><span class="s">'.\BsplnWgt.c'</span><span class="p">,</span><span class="s">'.\convolve.c'</span><span class="p">,</span><span class="s">'.\getPut.c'</span><span class="p">,</span><span class="s">'.\main.c'</span><span class="p">,</span><span class="s">'.\phil.c'</span><span class="p">,</span><span class="s">'.\pyrFilt.c'</span><span class="p">,</span><span class="s">'.\pyrGetSz.c'</span><span class="p">,</span><span class="s">'.\quant.c'</span><span class="p">,</span><span class="s">'.\reg0.c'</span><span class="p">,</span><span class="s">'.\reg1.c'</span><span class="p">,</span><span class="s">'.\reg2.c'</span><span class="p">,</span><span class="s">'.\reg3.c'</span><span class="p">,</span><span class="s">'.\regFlt3d.c'</span><span class="p">,</span><span class="s">'.\svdcmp.c'</span><span class="p">)</span>
</code></pre></div>
<ul>
<li>For Linux users: <a href="http://www.walkingrandomly.com/?p=2694">http://www.walkingrandomly.com/?p=2694</a></li>
</ul>
<div class="codehilite"><pre><span></span><code><span class="lineno" data-linenos="1 "></span><span class="n">mex</span><span class="p">(</span><span class="s">'-v'</span><span class="p">,</span> <span class="s">'GCC="/usr/bin/gcc-4.9"'</span><span class="p">,</span> <span class="s">'-largeArrayDims'</span><span class="p">,</span><span class="s">'CFLAGS="\$CFLAGS -std=c99"'</span><span class="p">,</span><span class="s">'-I.'</span><span class="p">,</span> <span class="s">'turboreg.c'</span><span class="p">,</span><span class="s">'./BsplnTrf.c'</span><span class="p">,</span><span class="s">'./BsplnWgt.c'</span><span class="p">,</span><span class="s">'./convolve.c'</span><span class="p">,</span><span class="s">'./getPut.c'</span><span class="p">,</span><span class="s">'./main.c'</span><span class="p">,</span><span class="s">'./phil.c'</span><span class="p">,</span><span class="s">'./pyrFilt.c'</span><span class="p">,</span><span class="s">'./pyrGetSz.c'</span><span class="p">,</span><span class="s">'./quant.c'</span><span class="p">,</span><span class="s">'./reg0.c'</span><span class="p">,</span><span class="s">'./reg1.c'</span><span class="p">,</span><span class="s">'./reg2.c'</span><span class="p">,</span><span class="s">'./reg3.c'</span><span class="p">,</span><span class="s">'./regFlt3d.c'</span><span class="p">,</span><span class="s">'./svdcmp.c'</span><span class="p">)</span>
<span class="lineno" data-linenos="2 "></span>
<span class="lineno" data-linenos="3 "></span>
<span class="lineno" data-linenos="4 "></span>
<span class="lineno" data-linenos="5 "></span><span class="n">mex</span><span class="p">(</span><span class="s">'-v'</span><span class="p">,</span> <span class="s">'GCC="/usr/bin/gcc-4.9"'</span><span class="p">,</span> <span class="s">'-largeArrayDims'</span><span class="p">,</span><span class="s">'CFLAGS="\$CFLAGS -std=c99"'</span><span class="p">,</span><span class="s">'-I.'</span><span class="p">,</span> <span class="s">'transfturboreg.c'</span><span class="p">,</span><span class="s">'./BsplnTrf.c'</span><span class="p">,</span><span class="s">'./BsplnWgt.c'</span><span class="p">,</span><span class="s">'./convolve.c'</span><span class="p">,</span><span class="s">'./getPut.c'</span><span class="p">,</span><span class="s">'./main.c'</span><span class="p">,</span><span class="s">'./phil.c'</span><span class="p">,</span><span class="s">'./pyrFilt.c'</span><span class="p">,</span><span class="s">'./pyrGetSz.c'</span><span class="p">,</span><span class="s">'./quant.c'</span><span class="p">,</span><span class="s">'./reg0.c'</span><span class="p">,</span><span class="s">'./reg1.c'</span><span class="p">,</span><span class="s">'./reg2.c'</span><span class="p">,</span><span class="s">'./reg3.c'</span><span class="p">,</span><span class="s">'./regFlt3d.c'</span><span class="p">,</span><span class="s">'./svdcmp.c'</span><span class="p">)</span>
</code></pre></div>
<ul>
<li>Below is an example usage of <code>turboregMovie</code>.</li>
</ul>
<ul>
<li>To use imageJ in Matlab, download Fiji (<a href="http://fiji.sc">http://fiji.sc</a>) and add Miji.m to your filepath, see <a href="http://fiji.sc/Miji">http://fiji.sc/Miji</a>.</li>
</ul>
<h4 id="running-turboreg">Running turboreg<a class="headerlink" href="#running-turboreg" title="Permanent link">¶</a></h4>
<p><strong>Note this input was from 2017.04.19 update</strong></p>
<div class="codehilite"><pre><span></span><code><span class="lineno" data-linenos=" 1 "></span><span class="c">% set turboreg options</span>
<span class="lineno" data-linenos=" 2 "></span>
<span class="lineno" data-linenos=" 3 "></span><span class="n">ioptions</span><span class="p">.</span><span class="n">inputDatasetName</span> <span class="p">=</span> <span class="s">'/1'</span><span class="p">;</span>
<span class="lineno" data-linenos=" 4 "></span>
<span class="lineno" data-linenos=" 5 "></span><span class="n">ioptions</span><span class="p">.</span><span class="n">turboregRotation</span> <span class="p">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="lineno" data-linenos=" 6 "></span>
<span class="lineno" data-linenos=" 7 "></span><span class="n">ioptions</span><span class="p">.</span><span class="n">RegisType</span> <span class="p">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="lineno" data-linenos=" 8 "></span>
<span class="lineno" data-linenos=" 9 "></span><span class="n">ioptions</span><span class="p">.</span><span class="n">parallel</span> <span class="p">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="lineno" data-linenos="10 "></span>
<span class="lineno" data-linenos="11 "></span><span class="n">ioptions</span><span class="p">.</span><span class="n">meanSubtract</span> <span class="p">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="lineno" data-linenos="12 "></span>
<span class="lineno" data-linenos="13 "></span><span class="n">ioptions</span><span class="p">.</span><span class="n">normalizeType</span> <span class="p">=</span> <span class="s">'bandpass'</span><span class="p">;</span> <span class="c">% matlabDisk is alternative input. Done on input to turboreg but NOT on final movie.</span>
<span class="lineno" data-linenos="14 "></span>
<span class="lineno" data-linenos="15 "></span><span class="n">ioptions</span><span class="p">.</span><span class="n">registrationFxn</span> <span class="p">=</span> <span class="s">'transfturboreg'</span><span class="p">;</span>
<span class="lineno" data-linenos="16 "></span>
<span class="lineno" data-linenos="17 "></span><span class="n">ioptions</span><span class="p">.</span><span class="n">normalizeBeforeRegister</span> <span class="p">=</span> <span class="s">'divideByLowpass'</span><span class="p">;</span> <span class="c">% set to blank if don't want any filtering on output movie</span>
<span class="lineno" data-linenos="18 "></span>
<span class="lineno" data-linenos="19 "></span><span class="n">ioptions</span><span class="p">.</span><span class="n">imagejFFTLarge</span> <span class="p">=</span> <span class="mi">10000</span><span class="p">;</span>
<span class="lineno" data-linenos="20 "></span>
<span class="lineno" data-linenos="21 "></span><span class="n">ioptions</span><span class="p">.</span><span class="n">imagejFFTSmall</span> <span class="p">=</span> <span class="mi">80</span><span class="p">;</span>
<span class="lineno" data-linenos="22 "></span>
<span class="lineno" data-linenos="23 "></span><span class="n">ioptions</span><span class="p">.</span><span class="n">saveNormalizeBeforeRegister</span> <span class="p">=</span> <span class="p">[];</span>
<span class="lineno" data-linenos="24 "></span>
<span class="lineno" data-linenos="25 "></span><span class="n">ioptions</span><span class="p">.</span><span class="n">cropCoords</span> <span class="p">=</span> <span class="p">[];</span>
<span class="lineno" data-linenos="26 "></span>
<span class="lineno" data-linenos="27 "></span><span class="n">ioptions</span><span class="p">.</span><span class="n">closeMatlabPool</span> <span class="p">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="lineno" data-linenos="28 "></span>
<span class="lineno" data-linenos="29 "></span><span class="n">ioptions</span><span class="p">.</span><span class="n">refFrame</span> <span class="p">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="lineno" data-linenos="30 "></span>
<span class="lineno" data-linenos="31 "></span><span class="n">ioptions</span><span class="p">.</span><span class="n">refFrameMatrix</span> <span class="p">=</span> <span class="p">[];</span>
<span class="lineno" data-linenos="32 "></span>
<span class="lineno" data-linenos="33 "></span>
<span class="lineno" data-linenos="34 "></span>
<span class="lineno" data-linenos="35 "></span><span class="c">% load the movie and run turboreg</span>
<span class="lineno" data-linenos="36 "></span>
<span class="lineno" data-linenos="37 "></span><span class="n">inputMovieMatrix</span> <span class="p">=</span> <span class="n">loadMovieList</span><span class="p">(</span><span class="s">'data\2014_04_01_p203_m19_check01\concat_recording_20140401_180333.h5'</span><span class="p">);</span>
<span class="lineno" data-linenos="38 "></span>
<span class="lineno" data-linenos="39 "></span><span class="n">regMovie</span> <span class="p">=</span> <span class="n">turboregMovie</span><span class="p">(</span><span class="n">inputMovieMatrix</span><span class="p">,</span><span class="s">'options'</span><span class="p">,</span><span class="n">ioptions</span><span class="p">);</span>
<span class="lineno" data-linenos="40 "></span>
<span class="lineno" data-linenos="41 "></span>
<span class="lineno" data-linenos="42 "></span>
<span class="lineno" data-linenos="43 "></span><span class="c">% or run turboreg function by loading movie directly within function</span>
<span class="lineno" data-linenos="44 "></span>
<span class="lineno" data-linenos="45 "></span><span class="n">regMovie</span> <span class="p">=</span> <span class="n">turboregMovie</span><span class="p">(</span><span class="s">'pathToDir\filename.h5'</span><span class="p">,</span><span class="s">'options'</span><span class="p">,</span><span class="n">ioptions</span><span class="p">);</span>
</code></pre></div>
<h4 id="old-input">Old input<a class="headerlink" href="#old-input" title="Permanent link">¶</a></h4>
<div class="codehilite"><pre><span></span><code><span class="lineno" data-linenos=" 1 "></span><span class="n">ioptions</span><span class="p">.</span><span class="n">inputDatasetName</span> <span class="p">=</span> <span class="s">'/1'</span><span class="p">;</span>
<span class="lineno" data-linenos=" 2 "></span>
<span class="lineno" data-linenos=" 3 "></span><span class="n">ioptions</span><span class="p">.</span><span class="n">turboregRotation</span> <span class="p">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="lineno" data-linenos=" 4 "></span>
<span class="lineno" data-linenos=" 5 "></span><span class="n">ioptions</span><span class="p">.</span><span class="n">RegisType</span> <span class="p">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="lineno" data-linenos=" 6 "></span>
<span class="lineno" data-linenos=" 7 "></span><span class="n">ioptions</span><span class="p">.</span><span class="n">parallel</span> <span class="p">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="lineno" data-linenos=" 8 "></span>
<span class="lineno" data-linenos=" 9 "></span><span class="n">ioptions</span><span class="p">.</span><span class="n">meanSubtract</span> <span class="p">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="lineno" data-linenos="10 "></span>
<span class="lineno" data-linenos="11 "></span><span class="n">ioptions</span><span class="p">.</span><span class="n">normalizeType</span> <span class="p">=</span> <span class="s">'divideByLowpass'</span><span class="p">;</span>
<span class="lineno" data-linenos="12 "></span>
<span class="lineno" data-linenos="13 "></span><span class="n">ioptions</span><span class="p">.</span><span class="n">registrationFxn</span> <span class="p">=</span> <span class="s">'transfturboreg'</span><span class="p">;</span>
<span class="lineno" data-linenos="14 "></span>
<span class="lineno" data-linenos="15 "></span><span class="n">ioptions</span><span class="p">.</span><span class="n">normalizeBeforeRegister</span> <span class="p">=</span> <span class="s">'imagejFFT'</span><span class="p">;</span>
<span class="lineno" data-linenos="16 "></span>
<span class="lineno" data-linenos="17 "></span><span class="n">ioptions</span><span class="p">.</span><span class="n">imagejFFTLarge</span> <span class="p">=</span> <span class="mi">10000</span><span class="p">;</span>
<span class="lineno" data-linenos="18 "></span>
<span class="lineno" data-linenos="19 "></span><span class="n">ioptions</span><span class="p">.</span><span class="n">imagejFFTSmall</span> <span class="p">=</span> <span class="mi">80</span><span class="p">;</span>
<span class="lineno" data-linenos="20 "></span>
<span class="lineno" data-linenos="21 "></span><span class="n">ioptions</span><span class="p">.</span><span class="n">saveNormalizeBeforeRegister</span> <span class="p">=</span> <span class="p">[];</span>
<span class="lineno" data-linenos="22 "></span>
<span class="lineno" data-linenos="23 "></span><span class="n">ioptions</span><span class="p">.</span><span class="n">cropCoords</span> <span class="p">=</span> <span class="p">[];</span>
<span class="lineno" data-linenos="24 "></span>
<span class="lineno" data-linenos="25 "></span><span class="n">ioptions</span><span class="p">.</span><span class="n">closeMatlabPool</span> <span class="p">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="lineno" data-linenos="26 "></span>
<span class="lineno" data-linenos="27 "></span><span class="n">ioptions</span><span class="p">.</span><span class="n">refFrame</span> <span class="p">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="lineno" data-linenos="28 "></span>
<span class="lineno" data-linenos="29 "></span><span class="n">ioptions</span><span class="p">.</span><span class="n">refFrameMatrix</span> <span class="p">=</span> <span class="p">[];</span>
<span class="lineno" data-linenos="30 "></span>
<span class="lineno" data-linenos="31 "></span><span class="n">regMovie</span> <span class="p">=</span> <span class="n">turboregMovie</span><span class="p">(</span><span class="s">'pathToDir\filename.h5'</span><span class="p">,</span><span class="s">'options'</span><span class="p">,</span><span class="n">ioptions</span><span class="p">);</span>
<span class="lineno" data-linenos="32 "></span>
<span class="lineno" data-linenos="33 "></span><span class="c">% OR</span>
<span class="lineno" data-linenos="34 "></span>
<span class="lineno" data-linenos="35 "></span><span class="n">regMovie</span> <span class="p">=</span> <span class="n">turboregMovie</span><span class="p">(</span><span class="n">inputMovieMatrix</span><span class="p">,</span><span class="s">'options'</span><span class="p">,</span><span class="n">ioptions</span><span class="p">);</span>
</code></pre></div>
<h2 id="cell-extraction_1">Cell extraction<a class="headerlink" href="#cell-extraction_1" title="Permanent link">¶</a></h2>
<h2 id="manual-cell-sorting-of-cell-extraction-outputs">Manual cell sorting of cell extraction outputs<a class="headerlink" href="#manual-cell-sorting-of-cell-extraction-outputs" title="Permanent link">¶</a></h2>
<p>This page will go over best practices and common issues seen when sorting cells from PCA-ICA. Advice can also apply to other cell sorting algorithms (CNMF, etc.).</p>
<p>As a general note, it is a bad idea to bias users by using heuristics or computational models to pre-select or guess whether a cell extraction output is a cell or non-cell. This will skew results toward whatever the heuristics or model are looking for rather than reveal the true preferences of the user.</p>
<h3 id="usage">Usage<a class="headerlink" href="#usage" title="Permanent link">¶</a></h3>
<p>Usage instructions below for <code>signalSorter.m</code>:</p>
<p><strong>Main inputs</strong></p>
<ul>
<li><code>inputImages</code> - [x y N] matrix where N = number of images, x/y are dimensions.</li>
</ul>
<ul>
<li><code>inputSignals</code> - [N frames] <em>double</em> matrix where N = number of signals (traces).</li>
</ul>
<ul>
<li><code>inputMovie</code> - [x y frames] matrix</li>
</ul>
<p><strong>Main outputs</strong></p>
<ul>
<li><code>choices</code> - [N 1] vector of 1 = cell, 0 = not a cell</li>
</ul>
<ul>
<li><code>inputImagesSorted</code> - [x y N] filtered by `choices'</li>
</ul>
<ul>
<li><code>inputSignalsSorted</code> - [N frames] filtered by <code>choice</code></li>
</ul>
<div class="codehilite"><pre><span></span><code><span class="lineno" data-linenos=" 1 "></span><span class="n">iopts</span><span class="p">.</span><span class="n">inputMovie</span> <span class="p">=</span> <span class="n">inputMovie</span><span class="p">;</span> <span class="c">% movie associated with traces</span>
<span class="lineno" data-linenos=" 2 "></span>
<span class="lineno" data-linenos=" 3 "></span><span class="n">iopts</span><span class="p">.</span><span class="n">valid</span> <span class="p">=</span> <span class="s">'neutralStart'</span><span class="p">;</span> <span class="c">% all choices start out gray or neutral to not bias user</span>
<span class="lineno" data-linenos=" 4 "></span>
<span class="lineno" data-linenos=" 5 "></span><span class="n">iopts</span><span class="p">.</span><span class="n">cropSizeLength</span> <span class="p">=</span> <span class="mi">20</span><span class="p">;</span> <span class="c">% region, in px, around a signal source for transient cut movies (subplot 2)</span>
<span class="lineno" data-linenos=" 6 "></span>
<span class="lineno" data-linenos=" 7 "></span><span class="n">iopts</span><span class="p">.</span><span class="n">cropSize</span> <span class="p">=</span> <span class="mi">20</span><span class="p">;</span> <span class="c">% see above</span>
<span class="lineno" data-linenos=" 8 "></span>
<span class="lineno" data-linenos=" 9 "></span><span class="n">iopts</span><span class="p">.</span><span class="n">medianFilterTrace</span> <span class="p">=</span> <span class="mi">0</span><span class="p">;</span> <span class="c">% whether to subtract a rolling median from trace</span>
<span class="lineno" data-linenos="10 "></span>
<span class="lineno" data-linenos="11 "></span><span class="n">iopts</span><span class="p">.</span><span class="n">subtractMean</span> <span class="p">=</span> <span class="mi">0</span><span class="p">;</span> <span class="c">% whether to subtract the trace mean</span>
<span class="lineno" data-linenos="12 "></span>
<span class="lineno" data-linenos="13 "></span><span class="n">iopts</span><span class="p">.</span><span class="n">movieMin</span> <span class="p">=</span> <span class="o">-</span><span class="mf">0.01</span><span class="p">;</span> <span class="c">% helps set contrast for subplot 2, preset movie min here or it is calculated</span>
<span class="lineno" data-linenos="14 "></span>
<span class="lineno" data-linenos="15 "></span><span class="n">iopts</span><span class="p">.</span><span class="n">movieMax</span> <span class="p">=</span> <span class="mf">0.05</span><span class="p">;</span> <span class="c">% helps set contrast for subplot 2, preset movie max here or it is calculated</span>
<span class="lineno" data-linenos="16 "></span>
<span class="lineno" data-linenos="17 "></span><span class="n">iopts</span><span class="p">.</span><span class="n">backgroundGood</span> <span class="p">=</span> <span class="p">[</span><span class="mi">208</span><span class="p">,</span><span class="mi">229</span><span class="p">,</span><span class="mi">180</span><span class="p">]</span><span class="o">/</span><span class="mi">255</span><span class="p">;</span>
<span class="lineno" data-linenos="18 "></span>
<span class="lineno" data-linenos="19 "></span><span class="n">iopts</span><span class="p">.</span><span class="n">backgroundBad</span> <span class="p">=</span> <span class="p">[</span><span class="mi">244</span><span class="p">,</span><span class="mi">166</span><span class="p">,</span><span class="mi">166</span><span class="p">]</span><span class="o">/</span><span class="mi">255</span><span class="p">;</span>
<span class="lineno" data-linenos="20 "></span>
<span class="lineno" data-linenos="21 "></span><span class="n">iopts</span><span class="p">.</span><span class="n">backgroundNeutral</span> <span class="p">=</span> <span class="nb">repmat</span><span class="p">(</span><span class="mi">230</span><span class="p">,[</span><span class="mi">1</span> <span class="mi">3</span><span class="p">])</span><span class="o">/</span><span class="mi">255</span><span class="p">;</span>
<span class="lineno" data-linenos="22 "></span>
<span class="lineno" data-linenos="23 "></span><span class="p">[</span><span class="n">inputImagesSorted</span><span class="p">,</span> <span class="n">inputSignalsSorted</span><span class="p">,</span> <span class="n">choices</span><span class="p">]</span> <span class="p">=</span> <span class="n">signalSorter</span><span class="p">(</span><span class="n">inputImages</span><span class="p">,</span> <span class="n">inputSignals</span><span class="p">,</span> <span class="s">'options'</span><span class="p">,</span><span class="n">iopts</span><span class="p">);</span>
</code></pre></div>
<h4 id="signalsorter-use-with-large-or-remote-server-imaging-movies"><code>signalSorter</code> use with large or remote server imaging movies<a class="headerlink" href="#signalsorter-use-with-large-or-remote-server-imaging-movies" title="Permanent link">¶</a></h4>
<p>For imaging movies that are too large to fit into RAM or that are stored on remote systems, run the below commands. Remember to change <code>inputImages</code>, <code>inputSignals</code>, <code>iopts.inputMovie</code>, and <code>iopts.inputDatasetName</code> to values appropriate for your data). <strong>Note: only HDF5 files are supported with this feature due to use of spatial chunking.</strong></p>
<div class="codehilite"><pre><span></span><code><span class="lineno" data-linenos=" 1 "></span><span class="c">% CRITICAL USER PARAMETERS</span>
<span class="lineno" data-linenos=" 2 "></span>
<span class="lineno" data-linenos=" 3 "></span><span class="c">% Input images and signals, change from PCA-ICA to whatever is appropriate for input from user's cell extraction algorithm.</span>
<span class="lineno" data-linenos=" 4 "></span>
<span class="lineno" data-linenos=" 5 "></span><span class="n">inputImages</span> <span class="p">=</span> <span class="n">pcaicaAnalysisOutput</span><span class="p">.</span><span class="n">IcaFilters</span><span class="p">;</span> <span class="c">% cell array of [x y nSignals] matrices containing each set of images corresponding to inputSignals objects.</span>
<span class="lineno" data-linenos=" 6 "></span>
<span class="lineno" data-linenos=" 7 "></span><span class="n">inputSignals</span> <span class="p">=</span> <span class="n">pcaicaAnalysisOutput</span><span class="p">.</span><span class="n">IcaTraces</span><span class="p">;</span> <span class="c">% cell array of [nSignals frames] matrices containing each set of inputImages signals.</span>
<span class="lineno" data-linenos=" 8 "></span>
<span class="lineno" data-linenos=" 9 "></span><span class="n">iopts</span><span class="p">.</span><span class="n">inputMovie</span> <span class="p">=</span> <span class="p">[</span><span class="s">'pathToImagingSessionFolder'</span> <span class="n">filesep</span> <span class="s">'MOVIE_FILE_NAME.h5'</span><span class="p">];</span>
<span class="lineno" data-linenos="10 "></span>
<span class="lineno" data-linenos="11 "></span><span class="n">iopts</span><span class="p">.</span><span class="n">inputDatasetName</span> <span class="p">=</span> <span class="s">'/1'</span><span class="p">;</span> <span class="c">% HDF5 dataset name</span>
<span class="lineno" data-linenos="12 "></span>
<span class="lineno" data-linenos="13 "></span>
<span class="lineno" data-linenos="14 "></span>
<span class="lineno" data-linenos="15 "></span><span class="c">% MAIN USER parameters: change these as needed</span>
<span class="lineno" data-linenos="16 "></span>
<span class="lineno" data-linenos="17 "></span><span class="n">iopts</span><span class="p">.</span><span class="n">preComputeImageCutMovies</span> <span class="p">=</span> <span class="mi">0</span><span class="p">;</span> <span class="c">% Binary: 0 recommended. 1 = pre-compute movies aligned to signal transients, 0 = do not pre-compute.</span>
<span class="lineno" data-linenos="18 "></span>
<span class="lineno" data-linenos="19 "></span><span class="n">iopts</span><span class="p">.</span><span class="n">readMovieChunks</span> <span class="p">=</span> <span class="mi">1</span><span class="p">;</span> <span class="c">% Binary: 1 recommended. 1 = read movie from HDD, 0 = load entire movie into RAM.</span>
<span class="lineno" data-linenos="20 "></span>
<span class="lineno" data-linenos="21 "></span><span class="n">iopts</span><span class="p">.</span><span class="n">showImageCorrWithCharInputMovie</span> <span class="p">=</span> <span class="mi">0</span><span class="p">;</span> <span class="c">% Binary: 0 recommended. 1 = show the image correlation value when input path to options.inputMovie (e.g. when not loading entire movie into RAM).</span>
<span class="lineno" data-linenos="22 "></span>
<span class="lineno" data-linenos="23 "></span><span class="n">iopts</span><span class="p">.</span><span class="n">maxSignalsToShow</span> <span class="p">=</span> <span class="mi">9</span><span class="p">;</span> <span class="c">%Int: max movie cut images to show</span>
<span class="lineno" data-linenos="24 "></span>
<span class="lineno" data-linenos="25 "></span><span class="n">iopts</span><span class="p">.</span><span class="n">nSignalsLoadAsync</span> <span class="p">=</span> <span class="mi">30</span><span class="p">;</span> <span class="c">% Int: number of signals ahead of current to asynchronously load imageCutMovies, might make the first couple signal selections slow while loading takes place</span>
<span class="lineno" data-linenos="26 "></span>
<span class="lineno" data-linenos="27 "></span><span class="n">iopts</span><span class="p">.</span><span class="n">threshold</span> <span class="p">=</span> <span class="mf">0.3</span><span class="p">;</span> <span class="c">% threshold for thresholding images</span>
<span class="lineno" data-linenos="28 "></span>
<span class="lineno" data-linenos="29 "></span><span class="n">iopts</span><span class="p">.</span><span class="n">thresholdOutline</span> <span class="p">=</span> <span class="mf">0.3</span><span class="p">;</span> <span class="c">% threshold for thresholding images</span>
<span class="lineno" data-linenos="30 "></span>
<span class="lineno" data-linenos="31 "></span>
<span class="lineno" data-linenos="32 "></span>
<span class="lineno" data-linenos="33 "></span><span class="c">% OPTIONAL</span>
<span class="lineno" data-linenos="34 "></span>
<span class="lineno" data-linenos="35 "></span><span class="n">iopts</span><span class="p">.</span><span class="n">valid</span> <span class="p">=</span> <span class="s">'neutralStart'</span><span class="p">;</span> <span class="c">% all choices start out gray or neutral to not bias user</span>
<span class="lineno" data-linenos="36 "></span>
<span class="lineno" data-linenos="37 "></span><span class="n">iopts</span><span class="p">.</span><span class="n">cropSizeLength</span> <span class="p">=</span> <span class="mi">20</span><span class="p">;</span> <span class="c">% region, in px, around a signal source for transient cut movies (subplot 2)</span>
<span class="lineno" data-linenos="38 "></span>
<span class="lineno" data-linenos="39 "></span><span class="n">iopts</span><span class="p">.</span><span class="n">cropSize</span> <span class="p">=</span> <span class="mi">20</span><span class="p">;</span> <span class="c">% see above</span>
<span class="lineno" data-linenos="40 "></span>
<span class="lineno" data-linenos="41 "></span><span class="n">iopts</span><span class="p">.</span><span class="n">medianFilterTrace</span> <span class="p">=</span> <span class="mi">0</span><span class="p">;</span> <span class="c">% whether to subtract a rolling median from trace</span>
<span class="lineno" data-linenos="42 "></span>
<span class="lineno" data-linenos="43 "></span><span class="n">iopts</span><span class="p">.</span><span class="n">subtractMean</span> <span class="p">=</span> <span class="mi">0</span><span class="p">;</span> <span class="c">% whether to subtract the trace mean</span>
<span class="lineno" data-linenos="44 "></span>
<span class="lineno" data-linenos="45 "></span><span class="n">iopts</span><span class="p">.</span><span class="n">movieMin</span> <span class="p">=</span> <span class="o">-</span><span class="mf">0.01</span><span class="p">;</span> <span class="c">% helps set contrast for subplot 2, preset movie min here or it is calculated</span>
<span class="lineno" data-linenos="46 "></span>
<span class="lineno" data-linenos="47 "></span><span class="n">iopts</span><span class="p">.</span><span class="n">movieMax</span> <span class="p">=</span> <span class="mf">0.05</span><span class="p">;</span> <span class="c">% helps set contrast for subplot 2, preset movie max here or it is calculated</span>
<span class="lineno" data-linenos="48 "></span>
<span class="lineno" data-linenos="49 "></span><span class="n">iopts</span><span class="p">.</span><span class="n">backgroundGood</span> <span class="p">=</span> <span class="p">[</span><span class="mi">208</span><span class="p">,</span><span class="mi">229</span><span class="p">,</span><span class="mi">180</span><span class="p">]</span><span class="o">/</span><span class="mi">255</span><span class="p">;</span>
<span class="lineno" data-linenos="50 "></span>
<span class="lineno" data-linenos="51 "></span><span class="n">iopts</span><span class="p">.</span><span class="n">backgroundBad</span> <span class="p">=</span> <span class="p">[</span><span class="mi">244</span><span class="p">,</span><span class="mi">166</span><span class="p">,</span><span class="mi">166</span><span class="p">]</span><span class="o">/</span><span class="mi">255</span><span class="p">;</span>
<span class="lineno" data-linenos="52 "></span>
<span class="lineno" data-linenos="53 "></span><span class="n">iopts</span><span class="p">.</span><span class="n">backgroundNeutral</span> <span class="p">=</span> <span class="nb">repmat</span><span class="p">(</span><span class="mi">230</span><span class="p">,[</span><span class="mi">1</span> <span class="mi">3</span><span class="p">])</span><span class="o">/</span><span class="mi">255</span><span class="p">;</span>
<span class="lineno" data-linenos="54 "></span>
<span class="lineno" data-linenos="55 "></span>
<span class="lineno" data-linenos="56 "></span>
<span class="lineno" data-linenos="57 "></span><span class="p">[</span><span class="o">~</span><span class="p">,</span> <span class="o">~</span><span class="p">,</span> <span class="n">choices</span><span class="p">]</span> <span class="p">=</span> <span class="n">signalSorter</span><span class="p">(</span><span class="n">inputImages</span><span class="p">,</span> <span class="n">inputSignals</span><span class="p">,</span> <span class="s">'options'</span><span class="p">,</span><span class="n">iopts</span><span class="p">);</span>
</code></pre></div>
<h3 id="interface">Interface<a class="headerlink" href="#interface" title="Permanent link">¶</a></h3>
<p><a href="https://user-images.githubusercontent.com/5241605/47396409-68da7b00-d6df-11e8-8c91-e85c3af356b5.png" target="_blank"><img alt="drawing" height="auto" src="https://user-images.githubusercontent.com/5241605/47396409-68da7b00-d6df-11e8-8c91-e85c3af356b5.png" width="900"/></a></p>
<p>GUI also contains a shortcut menu that users can access by right-clicking or selecting the top-left menu.</p>
<p><a href="https://user-images.githubusercontent.com/5241605/95838435-9ec30080-0cf6-11eb-981d-fc8b5d46de7b.png" target="_blank"><img alt="drawing" height="auto" src="https://user-images.githubusercontent.com/5241605/95838435-9ec30080-0cf6-11eb-981d-fc8b5d46de7b.png" width="900"/></a></p>
<p><strong>Example good cell extraction output</strong></p>
<p><a href="https://user-images.githubusercontent.com/5241605/58501425-3db67f00-8139-11e9-9c16-c7efc8a74144.gif" target="_blank"><img alt="drawing" height="auto" src="https://user-images.githubusercontent.com/5241605/58501425-3db67f00-8139-11e9-9c16-c7efc8a74144.gif" width="600"/></a></p>
<p><strong>Example bad cell extraction output</strong></p>
<p><a href="https://user-images.githubusercontent.com/5241605/58501420-3c855200-8139-11e9-8d1a-faea051ce2ea.gif" target="_blank"><img alt="drawing" height="auto" src="https://user-images.githubusercontent.com/5241605/58501420-3c855200-8139-11e9-8d1a-faea051ce2ea.gif" width="600"/></a></p>
<!-- ![2016_01_20_p460_m19_lineartrack01_s_bad_cellmax_517_1_32](https://user-images.githubusercontent.com/5241605/51698178-6a595f00-1fbe-11e9-940f-5dbcb08d4018.gif) -->
<p><strong>Jump to arbitrary cells</strong></p>
<ul>
<li>Click the cell map window or press <code>V</code> and a orange cross hair will appear, this will take the user to the clicked upon cell.</li>
</ul>
<p><img alt="image" src="https://user-images.githubusercontent.com/5241605/68536470-1549c800-0308-11ea-84fa-be12deadb329.png"/></p>
<ul>
<li>Or select the full cellmap, will obtain the same result.</li>
</ul>
<p><img alt="image" src="https://user-images.githubusercontent.com/5241605/68536494-9ef99580-0308-11ea-9040-618d6d836440.png"/></p>
<ul>
<li>This cell can be viewed like normal.</li>
</ul>
<p><img alt="image" src="https://user-images.githubusercontent.com/5241605/68536471-21358a00-0308-11ea-804b-b831d236cb4d.png"/></p>
<ul>
<li>Users can then press <code>Y</code> to take them back to the last sorted cell (here #2). This function works even with the <code>G</code> go to new signal via index number command.</li>
</ul>
<p><img alt="image" src="https://user-images.githubusercontent.com/5241605/68536472-2c88b580-0308-11ea-811d-f40ad5ddf94e.png"/></p>
<p><strong>Press "t" to bring up interface to compare neighboring cells</strong></p>
<p><img alt="image" src="https://user-images.githubusercontent.com/5241605/58516068-9d258680-815b-11e9-95b5-683d7f9b3495.png"/></p>
<ul>
<li>Users can zoom in on the traces to get a better sense of correlation between activity traces.</li>
</ul>
<p><img alt="image" src="https://user-images.githubusercontent.com/5241605/58516133-d9f17d80-815b-11e9-8faa-50216cb0f9c2.png"/></p>
<p><strong>Press "r" to bring up different views of trace</strong></p>
<ul>
<li>ROI trace included in instances where the entire movie is already loaded into RAM.</li>
</ul>
<p><img alt="image" src="https://user-images.githubusercontent.com/5241605/58517092-0a86e680-815f-11e9-966e-4a505336afb6.png"/></p>
<p><img alt="image" src="https://user-images.githubusercontent.com/5241605/58517156-4cb02800-815f-11e9-80fb-859d55703058.png"/></p>
<p><strong>Press "c" to bring up the whole movie cut to extraction output activity trace events</strong></p>
<p><img alt="ezgif-4-5a699a41b244_v2" src="https://user-images.githubusercontent.com/5241605/58517956-3192e780-8162-11e9-8946-f68fb1b25eab.gif"/></p>
<p><img alt="image" src="https://user-images.githubusercontent.com/5241605/58517239-93058700-815f-11e9-9374-4ea0f2252044.png"/></p>
<h3 id="best-practices">Best practices<a class="headerlink" href="#best-practices" title="Permanent link">¶</a></h3>
<ul>
<li>Always sort the cells with the trace, filter, and either images or video cut to transients in the movie.</li>
</ul>
<ul>
<li>This gets around two types of cells: those with irregular firing patterns that might be thrown out (see below) or those whose filter and traces look good, but are either fragments of a high SNR cell (see <strong>Common issues</strong>) or not actually a cell (e.g. a particulate in the field of view that has transient-like movement).</li>
</ul>
<ul>
<li>Sometimes two or more cell extraction outputs are for the same cell. In these suspected cases, press <code>t</code> in the <code>signalSorter</code> interface to pull up images and activity traces of nearby cells to see which have a higher SNR or better cell shape and should be kept.</li>
</ul>
<h3 id="neighboring-cells">Neighboring cells<a class="headerlink" href="#neighboring-cells" title="Permanent link">¶</a></h3>
<ul>
<li>Sometimes two or more cell extraction outputs are for the same cell. In these suspected cases, press <code>t</code> in the <code>signalSorter</code> interface to pull up images and activity traces of nearby cells to see which have a higher SNR or better cell shape and should be kept.</li>
</ul>
<ul>
<li>See below for an example, in which cell #3 (yellow) is a duplicate of cell #1 (blue).</li>
</ul>
<p><img alt="image" src="https://user-images.githubusercontent.com/5241605/52926738-ea3bc600-32eb-11e9-9fa1-e05087f3c05a.png"/></p>
<h3 id="common-issues_1">Common issues<a class="headerlink" href="#common-issues_1" title="Permanent link">¶</a></h3>
<ul>
<li>Cells with high SNR will sometimes be split into multiple cell extraction outputs. Refer to algorithm specific to notes on how to get around this problem.</li>
</ul>
<h3 id="examples">Examples<a class="headerlink" href="#examples" title="Permanent link">¶</a></h3>
<ul>
<li>Example of a good cell with GCaMP like rise/decay and for one-photon miniature microscope movies, has nice 2D Gaussian-like shape during transients in the movie.</li>
</ul>
<p><img alt="drawing" height="auto" src="https://user-images.githubusercontent.com/5241605/34796712-3868cb3a-f60b-11e7-830e-8eec5b2c76d7.gif" width="600"/></p>
<p><img alt="drawing" height="auto" src="https://user-images.githubusercontent.com/5241605/51698177-6a595f00-1fbe-11e9-9992-448881665c25.gif" width="600"/></p>
<!-- ![2016_01_20_p460_m19_lineartrack01_s_good_cellmax_510_1_32](https://user-images.githubusercontent.com/5241605/51698177-6a595f00-1fbe-11e9-9992-448881665c25.gif) -->
<!-- ![out-1](https://user-images.githubusercontent.com/5241605/34796712-3868cb3a-f60b-11e7-830e-8eec5b2c76d7.gif) -->
<ul>
<li>Example of good cells on left and bad on right. Subplots: CELLMax output, mean movie frame centered on the cell and aligned to cell transients, and example CELLMax traces.</li>
</ul>
<p><img alt="drawing" height="auto" src="https://user-images.githubusercontent.com/5241605/35294233-e0ec1ca2-002a-11e8-837c-857c93a6c810.png" width="600"/></p>
<!-- ![image](https://user-images.githubusercontent.com/5241605/35294233-e0ec1ca2-002a-11e8-837c-857c93a6c810.png) -->
<ul>
<li>Example of not-cells or borderline not-cells.</li>
</ul>
<p><img alt="drawing" height="auto" src="https://user-images.githubusercontent.com/5241605/51698178-6a595f00-1fbe-11e9-940f-5dbcb08d4018.gif" width="600"/></p>
<p><img alt="drawing" height="auto" src="https://user-images.githubusercontent.com/5241605/51698179-6a595f00-1fbe-11e9-9d4e-35ba75342cc4.gif" width="600"/></p>
<!-- ![2016_01_20_p460_m19_lineartrack01_s_bad_cellmax_517_1_32](https://user-images.githubusercontent.com/5241605/51698178-6a595f00-1fbe-11e9-940f-5dbcb08d4018.gif) -->
<!-- ![2016_01_20_p460_m19_lineartrack01_s_bad_cellmax_511](https://user-images.githubusercontent.com/5241605/51698179-6a595f00-1fbe-11e9-9d4e-35ba75342cc4.gif) -->
<ul>
<li>Good cells with their matched movies aligned to algorithm (PCA-ICA in this case) detected transients.</li>
</ul>
<p><img alt="drawing" src="https://cloud.githubusercontent.com/assets/5241605/26423683/67e85184-4083-11e7-88ff-f3bbe3600ffc.png" width="600"/></p>
<p><img alt="drawing" src="https://cloud.githubusercontent.com/assets/5241605/26423903/426a38b8-4084-11e7-93d5-f9962ea5b826.gif" width="300"/></p>
<p><img alt="drawing" height="auto" src="https://cloud.githubusercontent.com/assets/5241605/26423927/52804e2c-4084-11e7-8184-f3ae240dedea.png" width="600"/></p>
<p><img alt="drawing" height="auto" src="https://cloud.githubusercontent.com/assets/5241605/26423979/7f5348fa-4084-11e7-8c62-a277ecbbd13a.gif" width="300"/></p>
<!-- ![image](https://cloud.githubusercontent.com/assets/5241605/26423683/67e85184-4083-11e7-88ff-f3bbe3600ffc.png) -->
<!-- ![output3](https://cloud.githubusercontent.com/assets/5241605/26423903/426a38b8-4084-11e7-93d5-f9962ea5b826.gif) -->
<!-- ![image](https://cloud.githubusercontent.com/assets/5241605/26423927/52804e2c-4084-11e7-8184-f3ae240dedea.png) -->
<!-- ![output5](https://cloud.githubusercontent.com/assets/5241605/26423979/7f5348fa-4084-11e7-8c62-a277ecbbd13a.gif) -->
<ul>
<li>Additional examples of good cells.</li>
</ul>
<p><img alt="drawing" height="auto" src="https://cloud.githubusercontent.com/assets/5241605/10896133/e6c55e7a-816c-11e5-8527-f730ea0f7265.png" width="600"/></p>
<p><img alt="drawing" height="auto" src="https://cloud.githubusercontent.com/assets/5241605/11968975/bc4f24dc-a8c7-11e5-8b87-cf39eb52b62b.png" width="600"/></p>
<!-- ![image](https://cloud.githubusercontent.com/assets/5241605/10896133/e6c55e7a-816c-11e5-8527-f730ea0f7265.png) -->
<!-- ![image](https://cloud.githubusercontent.com/assets/5241605/11968975/bc4f24dc-a8c7-11e5-8b87-cf39eb52b62b.png) -->
<ul>
<li>As noted, without the transient aligned movie (see above), cells with unusual traces might be discarded, e.g. all three below are actual cells when the movie is visualized.</li>
</ul>
<p><img alt="drawing" height="auto" src="https://cloud.githubusercontent.com/assets/5241605/11164758/4ea1c02a-8aae-11e5-90bf-b6314eebb53a.png" width="600"/></p>
<!-- ![image](https://cloud.githubusercontent.com/assets/5241605/11164758/4ea1c02a-8aae-11e5-90bf-b6314eebb53a.png) -->
<h2 id="cross-day-or-session-cell-alignment-alignment">Cross-day or -session cell alignment alignment<a class="headerlink" href="#cross-day-or-session-cell-alignment-alignment" title="Permanent link">¶</a></h2>
<p>The purpose of cross-session alignment is to allow users to align cells across imaging sessions (e.g. those taken on different days) and thus compare coding of cells, changing in biological variables, and other parameters across conditions and time in their data.</p>
<p>This page details additional notes on one of the algorithms used in CIAtah, usage outside the CIAtah GUI, and other tips. The main function used to run cross-session analysis that allows users to align cells across sessions/days can be found at:</p>
<ul>
<li><a href="https://github.com/bahanonu/ciatah/blob/master/+ciapkg/+classification/matchObjBtwnTrials.m">https://github.com/bahanonu/ciatah/blob/master/+ciapkg/+classification/matchObjBtwnTrials.m</a></li>
</ul>
<p align="center">
<strong>Stable cell alignment across imaging sessions.</strong>
</p>
<p align="center">
<a href="https://user-images.githubusercontent.com/5241605/105437652-4ca74a80-5c16-11eb-893a-87ea6d53e964.gif">
<img align="center" alt="m121_matchedCells" src="https://user-images.githubusercontent.com/5241605/105437652-4ca74a80-5c16-11eb-893a-87ea6d53e964.gif" style="margin-left:auto;margin-right:auto;display:block;margin-bottom: 1%;" title="m121_matchedCells" width="40%"/>
</a>
</p>
<p>Below is an example of what the main output from cross-session alignment, a <code>globalIDs</code> matrix containing indices matches cells across days, looks like when visualized. Each column is an imaging session and each row is an individual global cell with the color indicating that global cell's within-session number. Any black cells indicate where no match was found for that global cell in that imaging day.</p>
<p><a href="https://user-images.githubusercontent.com/5241605/126750867-1ea1bcff-b3d1-493f-aac9-b7b7c7292796.png" target="_blank"><img alt="Global cell output" src="https://user-images.githubusercontent.com/5241605/126750867-1ea1bcff-b3d1-493f-aac9-b7b7c7292796.png" width="70%"/></a></p>
<h3 id="algorithm-overview">Algorithm overview<a class="headerlink" href="#algorithm-overview" title="Permanent link">¶</a></h3>
<p>For details, see <strong>Cross-day analysis of BLA neuronal activity</strong> methods section in the Corder<em>, Ahanonu</em>, et al. <em>Science</em>, 2019:</p>
<ul>
<li><a href="http://science.sciencemag.org/content/sci/suppl/2019/01/16/363.6424.276.DC1/aap8586_Corder_SM.pdf#page=10">http://science.sciencemag.org/content/sci/suppl/2019/01/16/363.6424.276.DC1/aap8586_Corder_SM.pdf#page=10</a>.</li>
</ul>
<p>We will also have details in an forthcoming imaging experiments and analysis book chapter.</p>
<!-- ![image](https://user-images.githubusercontent.com/5241605/51709763-21b09e80-1fdc-11e9-9332-1d52c9ed6bd5.png) -->
<p><img alt="image" src="https://user-images.githubusercontent.com/5241605/126744851-cd6e64ab-9b83-40bf-aa38-2301276f0ccf.png"/></p>
<p>Below is a general description of the algorithm/method used to match cells across sessions and references the above figure. A reference to the associated book chapter will be added in the future.</p>
<ol>
<li>
<p>Load the cell extraction spatial filters and threshold them by setting to zero any values below 40% the maximum value for each spatial filter and use these thresholded filters to calculate each neuron's centroid location. You can calculate the centroid using the <em>regionprops</em> function in MATLAB. <strong>Do not</strong> round each neuron's centroid coordinates to the nearest pixel value as this would reduce accuracy of cross-day alignment.</p>
</li>
<li>
<p>Next, create simplified spatial filters that contained a 10-pixel-radius circle (this can be varied based on microns-per-pixel of the movie and size of cells) centered on each neuron's centroid location. This allows you to register different days while ignoring any slight day-to-day differences in the cell extraction algorithm's estimate of each neuron's shape even if the centroid locations are similar.</p>
</li>
<li>
<p>For each animal, we recommend that if you have <em>N</em> sessions to align that you choose the <em>N/2</em> session (rounded down to the nearest whole number) to align to (referred to as the <em>align session</em>) to compensate for any drift or other imaging changes that may have occurred during the course of the imaging protocol.</p>
</li>
<li>
<p>For all imaging sessions create two neuron maps based on the thresholded spatial (see fig panel A, step 1, "thresholded neuron maps") and 10-pixel-radius circle (see fig panel A, step 2, "circle neuron maps") filters by taking a maximum projection across all <em>x</em> and <em>y</em> pixels and spatial filters (e.g. a max operation in the 3^rd^ dimension on a <em>x</em> Ã— <em>y</em> Ã— <em>n</em> neuron spatial filter matrix, where <em>n</em> = neuron number).</p>
</li>
<li>
<p>You then need to register these neuron maps to the <em>align session</em> using <em>Turboreg</em> with rotation enabled for all animals and isometric (projective) scaling enabled for a subset of animals in cases where that improves results. The registration steps are as follows (see fig panel A, step 3):</p>
<ul>
<li>Register the thresholded neuron map for a given session to the <em>align session</em> threshold neuron map.</li>
</ul>
<ul>
<li>Use the output 2D spatial transformation coordinates to also register the circle neuron maps.</li>
</ul>
<ul>
<li>Then register the circle neuron map with that animal's <em>align session</em> circle neuron map.</li>
</ul>
<ul>
<li>Apply the resulting 2D spatial transformation coordinates to the thresholded neuron map.</li>
</ul>
<ul>
<li>Repeat this procedure at least five times.</li>
</ul>
<ul>
<li>Lastly, use the final registration coordinates to transform all spatial filters from that session so they matched the <em>align session</em>'s spatial filters and repeat this process for all sessions for each animal individually.</li>
</ul>
</li>
<li>
<p>After registering all sessions to the <em>align session</em>, re-calculate all the centroid locations (see fig panel A, step 4).</p>
</li>
<li>
<p>Set the <em>align session</em> centroids as the initial seed for all <em>global cells</em> (see fig panel A, step 5)<em>.</em> Global cells are a tag to identify neurons that you match across imaging sessions.</p>
<ul>
<li>For example, global cell #1 might be associated with neurons that are at index number 1, 22, 300, 42, and 240 within the cell extraction analysis matrices across each of the first five imaging sessions, respectively.</li>
</ul>
</li>
<li>
<p>Starting with the <em>align session</em> for an animal, calculate the pairwise Euclidean distance between all global cells' and the selected session's (likely 1^st^) neurons' centroids.</p>
</li>
<li>
<p>Then identify any cases in which a global cell is within 5 Î¼m (nominally ~2 pixels in our data, this can be varied by the user) of a selected session's neurons. This distance depends on the density of cells in your imaging sessions, a stricter cut-off should be set for more dense brain areas. When you find a match, then check that the spatial filter is correlated (e.g. with 2-D correlation coefficient, Jaccard distance, or other measure) above a set threshold (e.g. <em>r</em> &gt; 0.4) with all other neurons associated with that global cell (see fig panel A, step 6).</p>
</li>
<li>
<p>If a neuron passes the above criteria, add that neuron to that global cell's pool of neurons then recalculate the global cell's centroid as the mean location between all associated session neurons' centroid locations and annotate any unmatched neurons in that session as new candidate global cells.</p>
</li>
<li>
<p>Repeat this process for all sessions associated with a given animal.</p>
</li>
</ol>
<h3 id="example-output">Example output<a class="headerlink" href="#example-output" title="Permanent link">¶</a></h3>
<ul>
<li>Example output of several mPFC animals across multiple sessions. Color is used to indicate a global ID cell (e.g. the same cell matched across multiple days).</li>
</ul>
<p><img src="https://user-images.githubusercontent.com/5241605/51710281-7a346b80-1fdd-11e9-8cad-3b3657038375.gif" width="600/"/></p>
<!-- ![2016_08_22_mpfcfear_allanimals_crossdayalignment](https://user-images.githubusercontent.com/5241605/51710281-7a346b80-1fdd-11e9-8cad-3b3657038375.gif) -->
<h3 id="usage_1">Usage<a class="headerlink" href="#usage_1" title="Permanent link">¶</a></h3>
<p>The below commands in MATLAB can be used to align sessions across days.</p>
<div class="codehilite"><pre><span></span><code><span class="lineno" data-linenos=" 1 "></span><span class="c">% Create input images, cell array of [x y nCells] matrices</span>
<span class="lineno" data-linenos=" 2 "></span>
<span class="lineno" data-linenos=" 3 "></span><span class="n">inputImages</span> <span class="p">=</span> <span class="p">{</span><span class="n">day1Images</span><span class="p">,</span><span class="n">day2Images</span><span class="p">,</span><span class="n">day3Images</span><span class="p">};</span>
<span class="lineno" data-linenos=" 4 "></span>
<span class="lineno" data-linenos=" 5 "></span>
<span class="lineno" data-linenos=" 6 "></span>
<span class="lineno" data-linenos=" 7 "></span><span class="c">% options to change</span>
<span class="lineno" data-linenos=" 8 "></span>
<span class="lineno" data-linenos=" 9 "></span><span class="n">opts</span><span class="p">.</span><span class="n">maxDistance</span> <span class="p">=</span> <span class="mi">5</span><span class="p">;</span> <span class="c">% distance in pixels between centroids for them to be grouped</span>
<span class="lineno" data-linenos="10 "></span>
<span class="lineno" data-linenos="11 "></span><span class="n">opts</span><span class="p">.</span><span class="n">trialToAlign</span> <span class="p">=</span> <span class="mi">1</span><span class="p">;</span> <span class="c">% which session to start alignment on</span>
<span class="lineno" data-linenos="12 "></span>
<span class="lineno" data-linenos="13 "></span><span class="n">opts</span><span class="p">.</span><span class="n">nCorrections</span> <span class="p">=</span> <span class="mi">1</span><span class="p">;</span> <span class="c">%number of rounds to register session cell maps.</span>
<span class="lineno" data-linenos="14 "></span>
<span class="lineno" data-linenos="15 "></span><span class="n">opts</span><span class="p">.</span><span class="n">RegisTypeFinal</span> <span class="p">=</span> <span class="mi">2</span> <span class="c">% 3 = rotation/translation and iso scaling; 2 = rotation/translation, no iso scaling</span>
<span class="lineno" data-linenos="16 "></span>
<span class="lineno" data-linenos="17 "></span>
<span class="lineno" data-linenos="18 "></span>
<span class="lineno" data-linenos="19 "></span><span class="c">% Run alignment code</span>
<span class="lineno" data-linenos="20 "></span>
<span class="lineno" data-linenos="21 "></span><span class="p">[</span><span class="n">alignmentStruct</span><span class="p">]</span> <span class="p">=</span> <span class="n">matchObjBtwnTrials</span><span class="p">(</span><span class="n">inputImages</span><span class="p">,</span><span class="s">'options'</span><span class="p">,</span><span class="n">opts</span><span class="p">);</span>
<span class="lineno" data-linenos="22 "></span>
<span class="lineno" data-linenos="23 "></span>
<span class="lineno" data-linenos="24 "></span>
<span class="lineno" data-linenos="25 "></span><span class="c">% Global IDs is a matrix of [globalID sessionID]</span>
<span class="lineno" data-linenos="26 "></span>
<span class="lineno" data-linenos="27 "></span><span class="c">% Each (globalID, sessionID) pair gives the within session ID for that particular global ID</span>
<span class="lineno" data-linenos="28 "></span>
<span class="lineno" data-linenos="29 "></span><span class="n">globalIDs</span> <span class="p">=</span> <span class="n">alignmentStruct</span><span class="p">.</span><span class="n">globalIDs</span><span class="p">;</span>
<span class="lineno" data-linenos="30 "></span>
<span class="lineno" data-linenos="31 "></span>
<span class="lineno" data-linenos="32 "></span>
<span class="lineno" data-linenos="33 "></span><span class="c">% View the cross-session matched cells, saved to `private\_tmpFiles` sub-folder.</span>
<span class="lineno" data-linenos="34 "></span>
<span class="lineno" data-linenos="35 "></span><span class="p">[</span><span class="n">success</span><span class="p">]</span> <span class="p">=</span> <span class="n">createMatchObjBtwnTrialsMaps</span><span class="p">(</span><span class="n">inputImages</span><span class="p">,</span><span class="n">alignmentStruct</span><span class="p">);</span>
</code></pre></div>
<p>In certain cases, you want to run analysis on the registered images, see below.</p>
<div class="codehilite"><pre><span></span><code><span class="lineno" data-linenos=" 1 "></span><span class="c">% Get registered images, cell array of [x y nCells] matrices</span>
<span class="lineno" data-linenos=" 2 "></span>
<span class="lineno" data-linenos=" 3 "></span><span class="n">registeredImagesCell</span> <span class="p">=</span> <span class="n">alignmentStruct</span><span class="p">.</span><span class="n">inputImages</span><span class="p">;</span>
<span class="lineno" data-linenos=" 4 "></span>
<span class="lineno" data-linenos=" 5 "></span><span class="c">% Get registered cell maps, cell array of [x y] matrices</span>
<span class="lineno" data-linenos=" 6 "></span>
<span class="lineno" data-linenos=" 7 "></span><span class="n">registeredCellmaps</span> <span class="p">=</span> <span class="n">alignmentStruct</span><span class="p">.</span><span class="n">objectMapTurboreg</span><span class="p">;</span>
<span class="lineno" data-linenos=" 8 "></span>
<span class="lineno" data-linenos=" 9 "></span>
<span class="lineno" data-linenos="10 "></span>
<span class="lineno" data-linenos="11 "></span><span class="c">% OR another method below.</span>
<span class="lineno" data-linenos="12 "></span>
<span class="lineno" data-linenos="13 "></span>
<span class="lineno" data-linenos="14 "></span>
<span class="lineno" data-linenos="15 "></span><span class="c">% Get the registration coordinates</span>
<span class="lineno" data-linenos="16 "></span>
<span class="lineno" data-linenos="17 "></span><span class="n">globalRegCoords</span> <span class="p">=</span> <span class="n">alignmentStruct</span><span class="p">.</span><span class="n">registrationCoords</span><span class="p">;</span>
<span class="lineno" data-linenos="18 "></span>
<span class="lineno" data-linenos="19 "></span><span class="n">globalRegCoords</span> <span class="p">=</span> <span class="n">globalRegCoords</span><span class="p">{</span><span class="n">folderNo</span><span class="p">};</span>
<span class="lineno" data-linenos="20 "></span>
<span class="lineno" data-linenos="21 "></span>
<span class="lineno" data-linenos="22 "></span>
<span class="lineno" data-linenos="23 "></span><span class="c">% Re-register input images for particular imaging session for later analysis.</span>
<span class="lineno" data-linenos="24 "></span>
<span class="lineno" data-linenos="25 "></span><span class="n">for</span> <span class="s">iterationNo</span> <span class="s">=</span> <span class="s">1:length(globalRegCoords)</span>
<span class="lineno" data-linenos="26 "></span>
<span class="lineno" data-linenos="27 "></span>    <span class="n">fn</span><span class="p">=</span><span class="n">fieldnames</span><span class="p">(</span><span class="n">globalRegCoords</span><span class="p">{</span><span class="n">iterationNo</span><span class="p">});</span>
<span class="lineno" data-linenos="28 "></span>
<span class="lineno" data-linenos="29 "></span>    <span class="n">for</span> <span class="s">i=1:length(fn)</span>
<span class="lineno" data-linenos="30 "></span>
<span class="lineno" data-linenos="31 "></span>        <span class="n">localCoords</span> <span class="p">=</span> <span class="n">globalRegCoords</span><span class="p">{</span><span class="n">iterationNo</span><span class="p">}.(</span><span class="n">fn</span><span class="p">{</span><span class="nb">i</span><span class="p">});</span>
<span class="lineno" data-linenos="32 "></span>
<span class="lineno" data-linenos="33 "></span>        <span class="p">[</span><span class="n">inputImages</span><span class="p">,</span> <span class="n">localCoords</span><span class="p">]</span> <span class="p">=</span> <span class="n">turboregMovie</span><span class="p">(</span><span class="n">inputImages</span><span class="p">,</span><span class="s">'precomputedRegistrationCooords'</span><span class="p">,</span><span class="n">localCoords</span><span class="p">);</span>
<span class="lineno" data-linenos="34 "></span>
<span class="lineno" data-linenos="35 "></span>    <span class="n">end</span>
<span class="lineno" data-linenos="36 "></span>
<span class="lineno" data-linenos="37 "></span><span class="s">end</span>
</code></pre></div>
<h3 id="algorithm-results">Algorithm results<a class="headerlink" href="#algorithm-results" title="Permanent link">¶</a></h3>
<h4 id="cross-session-metrics-and-results-on-cross-session-amygdala-response-to-pain">Cross-session metrics and results on cross-session amygdala response to pain<a class="headerlink" href="#cross-session-metrics-and-results-on-cross-session-amygdala-response-to-pain" title="Permanent link">¶</a></h4>
<p><img alt="image" src="https://user-images.githubusercontent.com/5241605/51709887-794f0a00-1fdc-11e9-921a-926fdcb48e4b.png"/></p>
<h4 id="pfc-cross-session-alignment">PFC cross-session alignment.<a class="headerlink" href="#pfc-cross-session-alignment" title="Permanent link">¶</a></h4>
<p><img src="https://user-images.githubusercontent.com/5241605/51710282-7a346b80-1fdd-11e9-9848-8ef84c0cfc2a.gif" width="600/"/></p>
<!--![2015_10_27_mpfc_aligned_acrossday_colored-1](https://user-images.githubusercontent.com/5241605/51710282-7a346b80-1fdd-11e9-9848-8ef84c0cfc2a.gif)-->
<h4 id="dorsal-striatum-cross-session-algorithm-comparison">Dorsal striatum cross-session algorithm comparison<a class="headerlink" href="#dorsal-striatum-cross-session-algorithm-comparison" title="Permanent link">¶</a></h4>
<ul>
<li>Original dorsal striatum cell maps from ICA with no motion correction applied.</li>
</ul>
<p><img alt="2017_05_02_p545_m121_p215_raw" src="https://cloud.githubusercontent.com/assets/5241605/25643108/9bcfccda-2f52-11e7-8514-31968752bd95.gif"/></p>
<ul>
<li>
<p><code>CIAtah</code> (Biafra's) registration algorithm</p>
<ul>
<li>Color is used to indicate a global ID cell (e.g. the same cell matched across multiple days). Thus, same color cell = same cell across sessions under the quick iteration parameters used in the below run.</li>
</ul>
</li>
</ul>
<p><img alt="2017_05_02_p545_m121_p215_corrected_biafraalgorithm2" src="https://cloud.githubusercontent.com/assets/5241605/25643473/dd7b11ce-2f54-11e7-8d84-eb98c5ef801c.gif"/></p>
<ul>
<li><code>CellReg</code> registration algorithm</li>
</ul>
<p>Using older code at <a href="https://github.com/zivlab/CellReg">https://github.com/zivlab/CellReg</a>.</p>
<p><img alt="2017_05_02_p545_m121_p215_corrected" src="https://cloud.githubusercontent.com/assets/5241605/25643113/a4445584-2f52-11e7-9ce8-5c5554ec9a5f.gif"/></p>
<h2 id="animal-tracking">Animal tracking<a class="headerlink" href="#animal-tracking" title="Permanent link">¶</a></h2>
<p>Code for ImageJ- and Matlab-based image tracking.</p>
<h2 id="imagej-based-tracking">ImageJ based tracking<a class="headerlink" href="#imagej-based-tracking" title="Permanent link">¶</a></h2>
<p>Functions needed (have entire <code>CIAtah</code> pipeline loaded anyways to ensure all dependencies are met):</p>
<ul>
<li><code>mm_tracking.ijm</code> is the tracking function for use in ImageJ, place in</li>
</ul>
<p><code>plugins</code> folder. It is found in the <code>ciapkg\tracking</code> folder of the repository.</p>
<ul>
<li><code>removeIncorrectObjs()</code> is a function to clean-up the ImageJ output.</li>
</ul>
<ul>
<li><code>createTrackingOverlayVideo()</code> is a function that allows users to check the output from the tracking by overlaying the mouse tracker onto the video.</li>
</ul>
<h3 id="instructions-for-imagej-and-matlab_1">Instructions for ImageJ and Matlab<a class="headerlink" href="#instructions-for-imagej-and-matlab_1" title="Permanent link">¶</a></h3>
<p>Run <code>mm_tracking</code> from the <code>Plugins</code> menu of ImageJ. Several settings to check:</p>
<ul>
<li><code>number of session folders to analyze</code> - this will indicate how many movies you want to analyze. Depending on <code>analyze movies from a list file</code> setting, a GUI will appear asking you to select movies to analyze (preferably AVIs) or a text file with a list of movies.</li>
</ul>
<ul>
<li><code>pixel to cm conversion, distance (cm)</code> - Make sure pixel to cm conversion indicates a measurable distance in the video, e.g. from one side of the box to another. The program will ask you to draw this distance to estimate pixels/cm.</li>
</ul>
<ul>
<li><code>crop stack?</code> - keep this selected, as allow removal of parts of movie where the animal will not go, improving results.</li>
</ul>
<ul>
<li><code>erode and dilate</code> - likely keep this selected, as it essentially makes sure the mouse is a solid object and smooths the tracking.</li>
</ul>
<ul>
<li><code>analyze movies from a list file</code> - select this option if you have a text file with the location of each movie to be analyzed on a new line. Use this to analyze many movies in batch.</li>
</ul>
<ul>
<li><code>hide loaded movie</code> - uncheck this to be able to visualize as ImageJ completes each step in the processing. Leave checked to improve speed of analysis.</li>
</ul>
<p>Example screen after running <code>mm_tracking</code> within ImageJ, click to expand.</p>
<!-- <a href="https://user-images.githubusercontent.com/5241605/34800762-1fa35480-f61a-11e7-91fb-65a260436725.png" target="_blank">![image](https://user-images.githubusercontent.com/5241605/34800762-1fa35480-f61a-11e7-91fb-65a260436725.png)</a> -->
<p><a href="https://user-images.githubusercontent.com/5241605/113023298-554a5e80-913a-11eb-88ed-181c133184f1.png" target="_blank"><img alt="image" src="https://user-images.githubusercontent.com/5241605/113023298-554a5e80-913a-11eb-88ed-181c133184f1.png"/></a></p>
<p>Once ImageJ is finished, within <code>MATLAB</code> run the following code (cleans up the ImageJ tracking by removing small objects and adding NaNs for missing frames along with making a movie to check output). Modify to point toward paths specific for your data.</p>
<div class="codehilite"><pre><span></span><code><span class="lineno" data-linenos="1 "></span><span class="c">% CSV file from imageJ and AVI movie path used in ImageJ</span>
<span class="lineno" data-linenos="2 "></span>
<span class="lineno" data-linenos="3 "></span><span class="n">moviePath</span> <span class="p">=</span> <span class="s">'PATH_TO_AVI_USED_IN_IMAEJ'</span><span class="p">;</span>
<span class="lineno" data-linenos="4 "></span>
<span class="lineno" data-linenos="5 "></span><span class="n">csvPath</span> <span class="p">=</span> <span class="s">'PATH_TO_CSV_OUTPUT_BY_IMAGEJ'</span><span class="p">;</span>
<span class="lineno" data-linenos="6 "></span>
<span class="lineno" data-linenos="7 "></span><span class="c">% clean up tracking</span>
<span class="lineno" data-linenos="8 "></span>
<span class="lineno" data-linenos="9 "></span><span class="p">[</span><span class="n">trackingTableFilteredCell</span><span class="p">]</span> <span class="p">=</span> <span class="n">removeIncorrectObjs</span><span class="p">(</span><span class="n">csvPath</span><span class="p">,</span><span class="s">'inputMovie'</span><span class="p">,{</span><span class="n">moviePath</span><span class="p">});</span>
</code></pre></div>
<h3 id="example-output-from-animal-in-open-field-during-miniature-microscope-imaging">Example output from animal in open field during miniature microscope imaging<a class="headerlink" href="#example-output-from-animal-in-open-field-during-miniature-microscope-imaging" title="Permanent link">¶</a></h3>
<!-- 2017_09_11_p540_m381_openfield01_091112017 -->
<p>Tracking of an animal over time (green = early in session, red = late in session).</p>
<p><img alt="image" src="https://user-images.githubusercontent.com/5241605/34800547-2a10a3b0-f619-11e7-9c88-88750c9875cd.png"/></p>
<h3 id="tracking-video">Tracking video<a class="headerlink" href="#tracking-video" title="Permanent link">¶</a></h3>
<p>The tracking video can be used to quickly validate that the animal is being correctly tracked.</p>
<div class="codehilite"><pre><span></span><code><span class="lineno" data-linenos=" 1 "></span><span class="c">% make tracking video</span>
<span class="lineno" data-linenos=" 2 "></span>
<span class="lineno" data-linenos=" 3 "></span><span class="c">% frames to use as example check</span>
<span class="lineno" data-linenos=" 4 "></span>
<span class="lineno" data-linenos=" 5 "></span><span class="n">nFrames</span><span class="p">=</span><span class="mi">1500</span><span class="p">:</span><span class="mi">2500</span><span class="p">;</span>
<span class="lineno" data-linenos=" 6 "></span>
<span class="lineno" data-linenos=" 7 "></span><span class="n">inputMovie</span> <span class="p">=</span> <span class="n">loadMovieList</span><span class="p">(</span><span class="n">moviePath</span><span class="p">,</span><span class="s">'frameList'</span><span class="p">,</span><span class="n">nFrames</span><span class="p">);</span>
<span class="lineno" data-linenos=" 8 "></span>
<span class="lineno" data-linenos=" 9 "></span><span class="p">[</span><span class="n">inputTrackingVideo</span><span class="p">]</span> <span class="p">=</span> <span class="n">createTrackingOverlayVideo</span><span class="p">(</span><span class="n">inputMovie</span><span class="p">,</span><span class="n">movmean</span><span class="p">(</span><span class="n">trackingTableFilteredCell</span><span class="p">.</span><span class="n">XM</span><span class="p">(</span><span class="n">nFrames</span><span class="p">),</span><span class="mi">5</span><span class="p">),</span><span class="n">movmean</span><span class="p">(</span><span class="n">trackingTableFilteredCell</span><span class="p">.</span><span class="n">YM</span><span class="p">(</span><span class="n">nFrames</span><span class="p">),</span><span class="mi">5</span><span class="p">));</span>
<span class="lineno" data-linenos="10 "></span>
<span class="lineno" data-linenos="11 "></span><span class="n">playMovie</span><span class="p">(</span><span class="n">inputTrackingVideo</span><span class="p">);</span>
</code></pre></div>
<p>Overlay of tracking (red circle) on the mouse in a specific frame.</p>
<p><img alt="image" src="https://user-images.githubusercontent.com/5241605/34800536-19eefcf2-f619-11e7-954f-dba59f4fd427.png"/></p>
<!-- # Matlab based tracking



<div class="codehilite"><pre><span></span><code><span class="lineno" data-linenos="1 "></span>
</code></pre></div>



* Refer to https://github.com/schnitzer-lab/miniscope_analysis/issues/21 for additional details about testing this function.



![image](https://cloud.githubusercontent.com/assets/5241605/10858250/c899794e-7f10-11e5-9a01-5f3c31606be9.png) -->
<h2 id="misc"><div class="subsection1">â€”Miscâ€”</div><a class="headerlink" href="#misc" title="Permanent link">¶</a></h2>
<h2 id="acknowledgments">Acknowledgments<a class="headerlink" href="#acknowledgments" title="Permanent link">¶</a></h2>
<p>Thanks to Jones G. Parker, PhD (<a href="https://parker-laboratory.com/">https://parker-laboratory.com/</a>) for providing extensive user feedback during development of the <code>CIAtah</code> software package.</p>
<p>Additional thanks to Drs. Jesse Marshall, JÃ©rÃ´me Lecoq, Tony H. Kim, Hakan Inan, Lacey Kitch, Maggie Larkin, Elizabeth Otto Hamel, Laurie Burns, and Claudia Schmuckermair for providing feedback, specific functions, or helping develop aspects of the code used in the <code>CIAtah</code> software package.</p>
<h2 id="references">References<a class="headerlink" href="#references" title="Permanent link">¶</a></h2>
<p>Please cite <a href="http://science.sciencemag.org/content/363/6424/276.full">Corder<em>, Ahanonu</em>, et al. 2019</a> <em>Science</em> publication or the <a href="https://doi.org/10.5281/zenodo.2222294">Ahanonu, 2018</a> <em>Zenodo</em> release if you used the software package or code from this repository to advance/help your research:</p>
<div class="codehilite"><pre><span></span><code><span class="lineno" data-linenos=" 1 "></span>@article<span class="nb">{</span>corderahanonu2019amygdalar,
<span class="lineno" data-linenos=" 2 "></span>
<span class="lineno" data-linenos=" 3 "></span>  title=<span class="nb">{</span>An amygdalar neural ensemble that encodes the unpleasantness of pain<span class="nb">}</span>,
<span class="lineno" data-linenos=" 4 "></span>
<span class="lineno" data-linenos=" 5 "></span>  author=<span class="nb">{</span>Corder, Gregory and Ahanonu, Biafra and Grewe, Benjamin F and Wang, Dong and Schnitzer, Mark J and Scherrer, Gr<span class="nb">{</span><span class="k">\'</span>e<span class="nb">}</span>gory<span class="nb">}</span>,
<span class="lineno" data-linenos=" 6 "></span>
<span class="lineno" data-linenos=" 7 "></span>  journal=<span class="nb">{</span>Science<span class="nb">}</span>,
<span class="lineno" data-linenos=" 8 "></span>
<span class="lineno" data-linenos=" 9 "></span>  volume=<span class="nb">{</span>363<span class="nb">}</span>,
<span class="lineno" data-linenos="10 "></span>
<span class="lineno" data-linenos="11 "></span>  number=<span class="nb">{</span>6424<span class="nb">}</span>,
<span class="lineno" data-linenos="12 "></span>
<span class="lineno" data-linenos="13 "></span>  pages=<span class="nb">{</span>276--281<span class="nb">}</span>,
<span class="lineno" data-linenos="14 "></span>
<span class="lineno" data-linenos="15 "></span>  year=<span class="nb">{</span>2019<span class="nb">}</span>,
<span class="lineno" data-linenos="16 "></span>
<span class="lineno" data-linenos="17 "></span>  publisher=<span class="nb">{</span>American Association for the Advancement of Science<span class="nb">}</span>
<span class="lineno" data-linenos="18 "></span>
<span class="lineno" data-linenos="19 "></span><span class="nb">}</span>
</code></pre></div>
<p>{% raw %}</p>
<div class="codehilite"><pre><span></span><code><span class="lineno" data-linenos=" 1 "></span>@misc<span class="nb">{</span>biafra<span class="nb">_</span>ahanonu<span class="nb">_</span>2018<span class="nb">_</span>2222295,
<span class="lineno" data-linenos=" 2 "></span>
<span class="lineno" data-linenos=" 3 "></span>  author       = <span class="nb">{</span>Biafra Ahanonu<span class="nb">}</span>,
<span class="lineno" data-linenos=" 4 "></span>
<span class="lineno" data-linenos=" 5 "></span>  title        = <span class="nb">{{</span> CIAtah : a software package for
<span class="lineno" data-linenos=" 6 "></span>
<span class="lineno" data-linenos=" 7 "></span>                   analyzing one- and two-photon calcium imaging
<span class="lineno" data-linenos=" 8 "></span>
<span class="lineno" data-linenos=" 9 "></span>                   datasets.<span class="nb">}}</span>,
<span class="lineno" data-linenos="10 "></span>
<span class="lineno" data-linenos="11 "></span>  month        = December,
<span class="lineno" data-linenos="12 "></span>
<span class="lineno" data-linenos="13 "></span>  year         = 2018,
<span class="lineno" data-linenos="14 "></span>
<span class="lineno" data-linenos="15 "></span>  doi          = <span class="nb">{</span>10.5281/zenodo.2222295<span class="nb">}</span>,
<span class="lineno" data-linenos="16 "></span>
<span class="lineno" data-linenos="17 "></span>  url          = <span class="nb">{</span>https://doi.org/10.5281/zenodo.2222295<span class="nb">}</span>
<span class="lineno" data-linenos="18 "></span>
<span class="lineno" data-linenos="19 "></span><span class="nb">}</span>
</code></pre></div>
<p>{% endraw %}</p>
<h3 id="turboreg-motion-correction">Turboreg (motion correction)<a class="headerlink" href="#turboreg-motion-correction" title="Permanent link">¶</a></h3>
<p>If you used <em>Turboreg</em> to conduct motion correction of your movies, please cite as below.</p>
<p>P. ThÃ©venaz, U.E. Ruttimann, M. Unser, "A Pyramid Approach to Subpixel Registration Based on Intensity," IEEE Transactions on Image Processing, vol. 7, no. 1, pp. 27-41, January 1998. Other relevant on-line publications are available at <a href="http://bigwww.epfl.ch/publications/">http://bigwww.epfl.ch/publications/</a>.</p>
<div class="codehilite"><pre><span></span><code><span class="lineno" data-linenos=" 1 "></span>@ARTICLE(http://bigwww.epfl.ch/publications/thevenaz9801.html,
<span class="lineno" data-linenos=" 2 "></span>
<span class="lineno" data-linenos=" 3 "></span>  AUTHOR="Th<span class="nb">{</span><span class="k">\'</span><span class="nb">{</span>e<span class="nb">}}</span>venaz, P. and Ruttimann, U.E. and Unser, M.",
<span class="lineno" data-linenos=" 4 "></span>
<span class="lineno" data-linenos=" 5 "></span>  TITLE="A Pyramid Approach to Subpixel Registration Based on
<span class="lineno" data-linenos=" 6 "></span>
<span class="lineno" data-linenos=" 7 "></span>          Intensity",
<span class="lineno" data-linenos=" 8 "></span>
<span class="lineno" data-linenos=" 9 "></span>  JOURNAL="<span class="nb">{</span>IEEE<span class="nb">}</span> Transactions on Image Processing",
<span class="lineno" data-linenos="10 "></span>
<span class="lineno" data-linenos="11 "></span>  YEAR="1998",
<span class="lineno" data-linenos="12 "></span>
<span class="lineno" data-linenos="13 "></span>  volume="7",
<span class="lineno" data-linenos="14 "></span>
<span class="lineno" data-linenos="15 "></span>  number="1",
<span class="lineno" data-linenos="16 "></span>
<span class="lineno" data-linenos="17 "></span>  pages="27--41",
<span class="lineno" data-linenos="18 "></span>
<span class="lineno" data-linenos="19 "></span>  month="January",
<span class="lineno" data-linenos="20 "></span>
<span class="lineno" data-linenos="21 "></span>  note=""
<span class="lineno" data-linenos="22 "></span>
<span class="lineno" data-linenos="23 "></span>)
</code></pre></div>
<h2 id="questions">Questions?<a class="headerlink" href="#questions" title="Permanent link">¶</a></h2>
<p>Please <a href="https://github.com/bahanonu/calciumImagingAnalysis/issues">open an issue on GitHub</a> or email any additional questions not covered in the repository to <code>bahanonu [at] alum.mit.edu</code>.</p>
<h2 id="license">License<a class="headerlink" href="#license" title="Permanent link">¶</a></h2>
<p>Copyright (C) 2013-2020 Biafra Ahanonu</p>
<p>This program is free software: you can redistribute it and/or modify it under the terms of the GNU General Public License as published by the Free Software Foundation, either version 3 of the License, or (at your option) any later version.</p>
<p>This program is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY; without even the implied warranty of</p>
<p>MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License for more details.</p>
<p>You should have received a copy of the GNU General Public License along with this program.  If not, see <a href="http://www.gnu.org/licenses/">http://www.gnu.org/licenses/</a>.</p>
</div>
</div>
<footer>
<div aria-label="footer navigation" class="rst-footer-buttons" role="navigation">
<a class="btn btn-neutral float-right" href="../install/" title="Quick Start">Next <span class="icon icon-circle-arrow-right"></span></a>
<a class="btn btn-neutral" href="./" title="One-page readme"><span class="icon icon-circle-arrow-left"></span> Previous</a>
</div>
<hr/>
<div role="contentinfo">
<!-- Copyright etc -->
</div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
</div>
</div>
</section>
</div>
<div aria-label="versions" class="rst-versions" role="note">
<span class="rst-current-version" data-toggle="rst-current-version">
<span><a href="./" style="color: #fcfcfc;">« Previous</a></span>
<span style="margin-left: 15px"><a href="../install/" style="color: #fcfcfc">Next »</a></span>
</span>
</div>
<script>var base_url = '..';</script>
<script defer="" src="../js/theme.js"></script>
<script defer="">
        window.onload = function () {
            SphinxRtdTheme.Navigation.enable(true);
        };
    </script>
</body>
</html>
