<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <meta name="author" content="Biafra Ahanonu">
  
  <link rel="shortcut icon" href="../img/favicon.ico">
<title>Cross-session cell alignment.</title>

  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Lato:400,700|Roboto+Slab:400,700|Inconsolata:400,700" />

  <link rel="stylesheet" href="../css/theme.css" />
  <link rel="stylesheet" href="../css/theme_extra.css" />
  <link href="../css/extra.css" rel="stylesheet" />
  <link href="../css/pygments.css" rel="stylesheet" />
  
  <script>
    // Current page data
    var mkdocs_page_name = "10| <u><strong>Cross-session alignment</strong></u>";
    var mkdocs_page_input_path = "pipeline_detailed_cross_session.md";
    var mkdocs_page_url = null;
  </script>
  
  <script src="../js/jquery-2.1.1.min.js" defer></script>
  <script src="../js/modernizr-2.8.3.min.js" defer></script> 
  
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
        <a href=".." class="icon icon-home"> CIAtah</a>
        
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="..">Home</a>
                    </li>
                </ul>
                <p class="caption"><span class="caption-text">End-to-end</span></p>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../all_docs/">One-page readme</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../all_docs/">One-page readme (auto)</a>
                    </li>
                </ul>
                <p class="caption"><span class="caption-text">Setup</span></p>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../install/">Quick Start</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../install_alt/">Install</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../example_data/">Example data</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../dependencies/">Dependencies</a>
                    </li>
                </ul>
                <p class="caption"><span class="caption-text">Repository</span></p>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../data/">Data formats</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../notes/">Notes</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../organization/">Organization</a>
                    </li>
                </ul>
                <p class="caption"><span class="caption-text">Processing imaging data</span></p>
                <ul class="current">
                    <li class="toctree-l1"><a class="reference internal" href="../pipeline_overview/">Overview</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../pipeline_detailed_all/">One-page step-by-step</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../pipeline_detailed/">One-page step-by-step (auto)</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../pipeline_detailed_downsample_raw/">1| Downsample raw movies</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../pipeline_detailed_preprocess_check/">2| Check pre-process settings</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../pipeline_detailed_preprocess/">3| <u><strong>Processing imaging movies</strong></u></a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../pipeline_detailed_modify_movies/">4| Movie clean-up</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../pipeline_detailed_signal_extraction/">5| <u><strong>Cell extraction</strong></u></a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../pipeline_detailed_signal_extraction_load/">6| Loading cell extraction outputs</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../pipeline_detailed_signal_extraction_validation/">7| <u><strong>Cell extraction validation</strong></u></a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../pipeline_detailed_signal_sorting_manual/">8| <u><strong>Manual cell sorting</strong></u></a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../pipeline_detailed_signal_region_analysis/">9| Region-specific analysis</a>
                    </li>
                    <li class="toctree-l1 current"><a class="reference internal current" href="./">10| <u><strong>Cross-session alignment</strong></u></a>
    <ul class="current">
    <li class="toctree-l2"><a class="reference internal" href="#output-of-computematchobjbtwntrials">Output of computeMatchObjBtwnTrials</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#notes-on-computematchobjbtwntrials-options">Notes on computeMatchObjBtwnTrials options</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#view-cross-session-cell-alignment-with-viewmatchobjbtwnsessions">View cross-session cell alignment with viewMatchObjBtwnSessions</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#save-cross-session-cell-alignment-with-modelsavematchobjbtwntrials">Save cross-session cell alignment with modelSaveMatchObjBtwnTrials</a>
    </li>
    </ul>
                    </li>
                </ul>
                <p class="caption"><span class="caption-text">Spinal cord motion correction</span></p>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../pipeline_detailed_spinal/">Spinal cord motion correction</a>
                    </li>
                </ul>
                <p class="caption"><span class="caption-text">Animal tracking</span></p>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../pipeline_animal_tracking/">Animal tracking (ImageJ+MATLAB)</a>
                    </li>
                </ul>
                <p class="caption"><span class="caption-text">API</span></p>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../api_example_pipeline/">Custom pipelines</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../api_ciapkg/">ciapkg</a>
                    </li>
                </ul>
                <p class="caption"><span class="caption-text">Help</span></p>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../help_issues/">Issues and fixes</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../blank/"><div class='subsection1'>Data</div></a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../help_inscopix/">Inscopix</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../help_nwb/">Neurodata Without Borders</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../blank/"><div class='subsection1'>Interface</div></a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../help_contrast/">Movie display and noise</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../blank/"><div class='subsection1'>Analysis</div></a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../help_analysis_methods/">Analysis methods</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../help_large_movie_analysis/">Large movie analysis</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../help_stripe_removal/">Stripe removal</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../help_snr/">Improving signal-to-noise</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../help_spatial_filtering/">Spatial filtering</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../help_temporal_downsampling/">Temporal downsampling</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../help_motion_correction/">Motion correction</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../help_cell_extraction/">Cell extraction</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../help_manual_cell_sorting/">Manual cell sorting</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../help_cross_session_alignment/">Cross-session alignemnt</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../help_animal_tracking/">Animal tracking</a>
                    </li>
                </ul>
                <p class="caption"><span class="caption-text">Misc</span></p>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../acknowledgments/">Acknowledgments</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../references/">Cite</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../questions/">Questions</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../license/">License</a>
                    </li>
                </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="..">CIAtah</a>
      </nav>

      
      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="..">Docs</a> &raquo;</li>
    
      
        
          <li>Processing imaging data &raquo;</li>
        
      
    
    <li>10| <u><strong>Cross-session alignment</strong></u></li>
    <li class="wy-breadcrumbs-aside">
      
    </li>
  </ul>
  
  <hr/>
</div>
          <div role="main">
            <div class="section">
              
                <h1 id="cross-session-cell-alignment-with-computematchobjbtwntrials">Cross-session cell alignment with <code>computeMatchObjBtwnTrials</code><a class="headerlink" href="#cross-session-cell-alignment-with-computematchobjbtwntrials" title="Permanent link">&para;</a></h1>
<p>This step allows users to align cells across imaging sessions (e.g. those taken on different days). See the <a href="../help_cross_session_alignment/">Cross session cell alignment help page</a> for more details and notes on cross-session alignment. See below sections for notes on options.</p>
<ul>
<li>Users run <code>computeMatchObjBtwnTrials</code> to do cross-day alignment (first row in pictures below).</li>
<li>Users then run <code>viewMatchObjBtwnSessions</code> to get a sense for how well the alignment ran.</li>
<li><code>computeCellDistances</code> and <code>computeCrossDayDistancesAlignment</code> allow users to compute the within session pairwise Euclidean centroid distance for all cells and the cross-session pairwise distance for all global matched cells, respectively.</li>
</ul>
<p><img alt="image" src="https://user-images.githubusercontent.com/5241605/49835713-eec88900-fd54-11e8-8d24-f7c426802297.png" /></p>
<h2 id="output-of-computematchobjbtwntrials">Output of <code>computeMatchObjBtwnTrials</code><a class="headerlink" href="#output-of-computematchobjbtwntrials" title="Permanent link">&para;</a></h2>
<p>The output for cross-session alignment for each animal is stored in a structure within the current <code>ciatah</code> object: <code>obj.globalIDStruct.ANIMAL_ID</code> where <code>ANIMAL_ID</code> is the animal identification automatically pulled from folder names (if none is found, defaults to <code>m0</code>). Users can then get the matrix that gives the session IDs from the <code>ciatah</code> class:</p>
<div class="codehilite"><pre><span></span><code><span class="lineno" data-linenos="1 "></span><span class="c">% Grab the cross session alignment structure from the current `ciatah` object. </span>
<span class="lineno" data-linenos="2 "></span><span class="n">alignmentStruct</span> <span class="p">=</span> <span class="n">obj</span><span class="p">.</span><span class="n">globalIDStruct</span><span class="p">.</span><span class="n">ANIMAL_ID</span>
<span class="lineno" data-linenos="3 "></span>
<span class="lineno" data-linenos="4 "></span><span class="c">% Global IDs is a matrix of [globalID sessionID].</span>
<span class="lineno" data-linenos="5 "></span><span class="c">% Each (globalID, sessionID) pair gives the within session ID for that particular global ID.</span>
<span class="lineno" data-linenos="6 "></span><span class="n">globalIDs</span> <span class="p">=</span> <span class="n">alignmentStruct</span><span class="p">.</span><span class="n">globalIDs</span><span class="p">;</span>
</code></pre></div>
<p>Below is an example of what that <code>globalIDs</code> matrix looks like when visualized. Each column is an imaging session and each row is an individual global cell with the color indicating that global cell's within-session number. Any black cells indicate where no match was found for that global cell in that imaging day.</p>
<p><a href="https://user-images.githubusercontent.com/5241605/126750867-1ea1bcff-b3d1-493f-aac9-b7b7c7292796.png" target="_blank"><img src="https://user-images.githubusercontent.com/5241605/126750867-1ea1bcff-b3d1-493f-aac9-b7b7c7292796.png" alt="Global cell output" width="70%"/></a></p>
<h2 id="notes-on-computematchobjbtwntrials-options">Notes on <code>computeMatchObjBtwnTrials</code> options<a class="headerlink" href="#notes-on-computematchobjbtwntrials-options" title="Permanent link">&para;</a></h2>
<p>After starting <code>computeMatchObjBtwnTrials</code>, the below options screen will appear: <br />
<a href="https://user-images.githubusercontent.com/5241605/126746771-c0486ab8-aec1-429d-b982-88f638a400a8.png" target="_blank"><img src="https://user-images.githubusercontent.com/5241605/126746771-c0486ab8-aec1-429d-b982-88f638a400a8.png" alt="Cross session options screen" width="100%"/></a></p>
<p>An explanation of each option is as follows:</p>
<ul>
<li><code>Number of rounds to register images (integer)</code><ul>
<li>This determines the number of rounds to register all the sessions to the "base" session used for alignment. Additional rounds of registration (e.g. we at times use up to 5 rounds) can often improve results especially in cases where there might be large lateral displacements across sessions.</li>
</ul>
</li>
<li><code>Distance threshold to match cells cross-session (in pixels)</code><ul>
<li>This determine the maximum distance that the algorithm should use to match cells across sessions. Ideally this value should be <em>below</em> the within-session distance between cells to minimize false positives (e.g. matching nearby cells across sessions that are actually different cells).</li>
</ul>
</li>
<li><code>Image binarization threshold (0 to 1, fraction each image''s max value)</code><ul>
<li>This threshold is used to remove parts of the cell filter that are not necessarily useful for cross-session alignment, such as faint dendrites or axons along with noise produced by some algorithms in their filters (e.g. as is the case with PCA-ICA).</li>
</ul>
</li>
<li><code>Session to align to (leave blank to auto-calculate middle session to use for alignment)</code><ul>
<li>Leaving blank automatically selects the middle session, as this session is often a compromise between changes (e.g. drift in the field of view) that occurred between the 1st and last session.</li>
</ul>
</li>
<li><code>Registration type (3 = rotation and iso scaling, 2 = rotation no iso scaling)</code><ul>
<li>This is the type of <em>Turboreg</em> registration used to align the sessions during cross-session motion correction. Avoid using iso scaling enabled (e.g. <code>3</code> or projective) unless you know in advance that you have warping in your field of view across days, else this option can lead to less optimal results compared to iso scaling disabled (e.g. <code>2</code> or affine).</li>
<li>See <a href="https://www.mathworks.com/help/images/matrix-representation-of-geometric-transformations.html">https://www.mathworks.com/help/images/matrix-representation-of-geometric-transformations.html</a>.</li>
</ul>
</li>
<li><code>Run image correlation threshold? (1 = yes, 0 = no)</code><ul>
<li>This determines whether a secondary measure will be used to match cells across sessions and decreases the probability of false positives. It does this by correlating the putative matched cell to others that have been already matched to be the same cells and adds it to the "global cell" group for that cell if it passes a pre-defined threshold as below. In general this should be enabled unless you know the imaging quality varies across sessions that would lead to a distortion in cell shapes or you are using a cell-extraction algorithm that does not produce high-quality filters.</li>
</ul>
</li>
<li><code>Image correlation type (e.g. "corr2","jaccard")</code><ul>
<li>This is the type of correlation measure, where <code>corr2</code> is <a href="https://www.mathworks.com/help/images/ref/corr2.html">2-D correlation coefficient</a> and <code>jaccard</code> is the <a href="https://en.wikipedia.org/wiki/Jaccard_index">Jaccard distance</a>. The <a href="https://en.wikipedia.org/wiki/Cosine_similarity">Ochiai similarity</a> is also supported.</li>
<li>A list of all possible measures can be found at <a href="https://www.mathworks.com/matlabcentral/fileexchange/55190-simbin-mat1-mat2-type-mask">https://www.mathworks.com/matlabcentral/fileexchange/55190-simbin-mat1-mat2-type-mask</a>. Note, some might not be valid and in general the above three should work for most users.</li>
</ul>
</li>
<li><code>Image correlation threshold for matched cells (0 to 1)</code><ul>
<li>How high the image correlation needs to be for it to be considered a match, e.g. accept the match if it has an image correlation above this amount <em>and</em> a distance below that specified above.</li>
</ul>
</li>
<li><code>Image correlation binarization threshold (0 to 1, fraction each image''s max value)</code><ul>
<li>This is the threshold used for calculated image correlations. <strong>Note</strong> this is different that the threshold used for cross-session cell alignment as sometimes the cross-session threshold needs to be a different value to improve alignment compared to a more relaxed threshold to improve estimation of cell shape (e.g. too high of a threshold can make all cells look similar depending on the algorithm).</li>
</ul>
</li>
<li><code>Threshold below which registered image values set to zero</code><ul>
<li>During registration zero values can sometimes take on very small numerical values that can cause problems for downstream analysis. This threshold sets all pixels below this value to zero to correct for this. For the most part do not change this value.</li>
</ul>
</li>
<li><code>Visually compare image correlation values and matched images (1 = yes, 0 = no)</code><ul>
<li>This will pop-up a GUI after running cross-session alignment to show matches that users can scroll through.</li>
</ul>
</li>
<li><code>View full results after [viewMatchObjBtwnSessions] (1 = yes, 0 = no)</code><ul>
<li>This will pop-up several figures showing example cells matched across sessions along with graphs that show cross-session matches with each cell colored by its global identification to help determine accuracy of results. If users go to <code>obj.picsSavePath</code> and look under the folders <code>matchObjColorMap</code>, they will find AVI and picture files with outputs related to these figures.</li>
</ul>
</li>
</ul>
<!-- ### Check within-session -->

<h2 id="view-cross-session-cell-alignment-with-viewmatchobjbtwnsessions">View cross-session cell alignment with <code>viewMatchObjBtwnSessions</code><a class="headerlink" href="#view-cross-session-cell-alignment-with-viewmatchobjbtwnsessions" title="Permanent link">&para;</a></h2>
<p>To evaluate how well cross-session alignment works, <code>computeMatchObjBtwnTrials</code> will automatically run <code>viewMatchObjBtwnSessions</code> at the end, but users can also run it separately after alignment. The left are raw dorsal striatum cell maps from a single animal. The right shows after cross-session alignment; color is used to indicate a global ID cell (e.g. the same cell matched across multiple days). Thus, same color cell = same cell across sessions.</p>
<p><a href="https://cloud.githubusercontent.com/assets/5241605/25643108/9bcfccda-2f52-11e7-8514-31968752bd95.gif" target="_blank"><img src="https://cloud.githubusercontent.com/assets/5241605/25643108/9bcfccda-2f52-11e7-8514-31968752bd95.gif" alt="2017_05_02_p545_m121_p215_raw" width="auto" height="400"/></a>
<a href="https://cloud.githubusercontent.com/assets/5241605/25643473/dd7b11ce-2f54-11e7-8d84-eb98c5ef801c.gif" target="_blank"><img src="https://cloud.githubusercontent.com/assets/5241605/25643473/dd7b11ce-2f54-11e7-8d84-eb98c5ef801c.gif" alt="2017_05_02_p545_m121_p215_corrected_biafraalgorithm2" width="auto" height="400"/></a></p>
<h2 id="save-cross-session-cell-alignment-with-modelsavematchobjbtwntrials">Save cross-session cell alignment with <code>modelSaveMatchObjBtwnTrials</code><a class="headerlink" href="#save-cross-session-cell-alignment-with-modelsavematchobjbtwntrials" title="Permanent link">&para;</a></h2>
<p>Users can save out the alignment structure by running <code>modelSaveMatchObjBtwnTrials</code>. This will allow users to select a folder where <code>CIAtah</code> will save a MAT-file with the alignment structure information for each animal.</p>
              
            </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="../pipeline_detailed_spinal/" class="btn btn-neutral float-right" title="Spinal cord motion correction">Next <span class="icon icon-circle-arrow-right"></span></a>
      
      
        <a href="../pipeline_detailed_signal_region_analysis/" class="btn btn-neutral" title="9| Region-specific analysis"><span class="icon icon-circle-arrow-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
    
  </div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
      
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="versions">
    <span class="rst-current-version" data-toggle="rst-current-version">
      
      
        <span><a href="../pipeline_detailed_signal_region_analysis/" style="color: #fcfcfc;">&laquo; Previous</a></span>
      
      
        <span style="margin-left: 15px"><a href="../pipeline_detailed_spinal/" style="color: #fcfcfc">Next &raquo;</a></span>
      
    </span>
</div>
    <script>var base_url = '..';</script>
    <script src="../js/theme.js" defer></script>
    <script defer>
        window.onload = function () {
            SphinxRtdTheme.Navigation.enable(true);
        };
    </script>

</body>
</html>
